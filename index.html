<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PRISM ‚Äî PGIMER HemePath Registry</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Mono:wght@300;400;500&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --crimson: #8B1A1A;
    --crimson-light: #C0392B;
    --crimson-pale: #fdf0f0;
    --gold: #C9A84C;
    --gold-light: #f5e6c0;
    --dark: #1a1a2e;
    --mid: #2d2d44;
    --slate: #4a4a6a;
    --light: #f4f4f8;
    --white: #ffffff;
    --border: #e2e2ee;
    --success: #2d7a4f;
    --mono: 'DM Mono', monospace;
    --serif: 'DM Serif Display', serif;
    --sans: 'DM Sans', sans-serif;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: var(--sans);
    background: var(--dark);
    min-height: 100vh;
    color: var(--dark);
  }

  /* ‚îÄ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ‚îÄ */
  header {
    background: linear-gradient(135deg, var(--dark) 0%, var(--mid) 100%);
    border-bottom: 2px solid var(--crimson);
    padding: 18px 40px;
    display: flex;
    align-items: center;
    gap: 16px;
  }
  .logo-mark {
    width: 52px; height: 52px;
    background: linear-gradient(135deg, var(--crimson), #c0392b);
    border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    font-family: var(--mono);
    color: white;
    font-size: 13px;
    font-weight: 700;
    flex-shrink: 0;
    letter-spacing: 0.05em;
    box-shadow: 0 4px 12px rgba(139,26,26,0.4);
  }
  header h1 {
    font-family: var(--serif);
    font-size: 22px;
    color: white;
    letter-spacing: 0.02em;
  }
  header p {
    font-size: 11px;
    color: var(--gold);
    font-family: var(--mono);
    letter-spacing: 0.1em;
    text-transform: uppercase;
    margin-top: 2px;
  }

  /* ‚îÄ‚îÄ‚îÄ MAIN WRAPPER ‚îÄ‚îÄ‚îÄ */
  .main {
    max-width: 960px;
    margin: 0 auto;
    padding: 40px 20px 60px;
  }

  /* ‚îÄ‚îÄ‚îÄ HOME SCREEN ‚îÄ‚îÄ‚îÄ */
  .home-screen {
    text-align: center;
    padding: 60px 20px;
  }
  .home-title {
    font-family: var(--serif);
    font-size: 38px;
    color: white;
    margin-bottom: 10px;
    line-height: 1.2;
  }
  .home-subtitle {
    font-family: var(--mono);
    color: var(--gold);
    font-size: 12px;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    margin-bottom: 50px;
  }
  .home-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 20px;
    max-width: 860px;
    margin: 0 auto;
  }
  .home-card {
    background: white;
    border-radius: 12px;
    padding: 36px 28px;
    cursor: pointer;
    border: 2px solid transparent;
    transition: all 0.25s ease;
    text-align: left;
    position: relative;
    overflow: hidden;
  }
  .home-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0;
    width: 4px; height: 100%;
    background: var(--crimson);
    transition: width 0.25s ease;
  }
  .home-card:hover::before { width: 100%; opacity: 0.04; }
  .home-card:hover { border-color: var(--crimson); transform: translateY(-3px); box-shadow: 0 12px 40px rgba(139,26,26,0.15); }
  .card-num {
    font-family: var(--mono);
    font-size: 11px;
    color: var(--crimson);
    letter-spacing: 0.15em;
    text-transform: uppercase;
    margin-bottom: 12px;
  }
  .card-icon { font-size: 32px; margin-bottom: 14px; }
  .home-card h3 {
    font-family: var(--serif);
    font-size: 20px;
    color: var(--dark);
    margin-bottom: 8px;
  }
  .home-card p {
    font-size: 13px;
    color: var(--slate);
    line-height: 1.5;
  }
  .card-btn {
    display: inline-block;
    margin-top: 20px;
    padding: 9px 20px;
    background: var(--dark);
    color: white;
    border-radius: 6px;
    font-size: 12px;
    font-family: var(--mono);
    letter-spacing: 0.08em;
    text-transform: uppercase;
    transition: background 0.2s;
  }
  .home-card:hover .card-btn { background: var(--crimson); }

  /* ‚îÄ‚îÄ‚îÄ PANEL / FORM WRAPPER ‚îÄ‚îÄ‚îÄ */
  .panel {
    display: none;
    background: white;
    border-radius: 14px;
    overflow: hidden;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  }
  .panel.active { display: block; }

  .panel-header {
    background: linear-gradient(135deg, var(--dark), var(--mid));
    padding: 24px 32px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .panel-header h2 {
    font-family: var(--serif);
    font-size: 22px;
    color: white;
  }
  .panel-header .step-badge {
    font-family: var(--mono);
    font-size: 11px;
    color: var(--gold);
    letter-spacing: 0.12em;
    text-transform: uppercase;
    background: rgba(201,168,76,0.15);
    padding: 5px 12px;
    border-radius: 20px;
    border: 1px solid rgba(201,168,76,0.3);
  }
  .back-btn {
    background: none;
    border: 1px solid rgba(255,255,255,0.3);
    color: white;
    padding: 7px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    font-family: var(--mono);
    letter-spacing: 0.08em;
    transition: all 0.2s;
    display: flex; align-items: center; gap: 6px;
  }
  .back-btn:hover { background: rgba(255,255,255,0.1); }

  .panel-body { padding: 36px 32px; }

  /* ‚îÄ‚îÄ‚îÄ FORM ELEMENTS ‚îÄ‚îÄ‚îÄ */
  .form-section {
    margin-bottom: 32px;
    padding-bottom: 28px;
    border-bottom: 1px solid var(--border);
  }
  .form-section:last-child { border-bottom: none; margin-bottom: 0; }
  .section-label {
    font-family: var(--mono);
    font-size: 10px;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: var(--crimson);
    margin-bottom: 18px;
    display: flex; align-items: center; gap: 8px;
  }
  .section-label::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--crimson-pale);
  }

  .form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 16px;
  }
  .form-grid.cols-2 { grid-template-columns: 1fr 1fr; }
  .form-grid.cols-3 { grid-template-columns: 1fr 1fr 1fr; }

  .field {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  .field.span-2 { grid-column: span 2; }
  .field.span-3 { grid-column: span 3; }

  label {
    font-size: 11px;
    font-weight: 600;
    color: var(--slate);
    text-transform: uppercase;
    letter-spacing: 0.08em;
  }
  label span.req { color: var(--crimson); }

  input[type="text"], input[type="date"], input[type="number"],
  select, textarea {
    padding: 10px 14px;
    border: 1.5px solid var(--border);
    border-radius: 8px;
    font-size: 14px;
    font-family: var(--sans);
    color: var(--dark);
    background: var(--light);
    transition: border-color 0.2s, box-shadow 0.2s;
    outline: none;
    width: 100%;
  }
  input:focus, select:focus, textarea:focus {
    border-color: var(--crimson);
    box-shadow: 0 0 0 3px rgba(139,26,26,0.08);
    background: white;
  }

  /* ‚îÄ‚îÄ‚îÄ RADIO BUTTONS (Sex) ‚îÄ‚îÄ‚îÄ */
  .radio-group {
    display: flex;
    gap: 10px;
  }
  .radio-opt {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 10px;
    border: 1.5px solid var(--border);
    border-radius: 8px;
    cursor: pointer;
    font-size: 13px;
    color: var(--slate);
    transition: all 0.2s;
    background: var(--light);
  }
  .radio-opt input { display: none; }
  .radio-opt:has(input:checked) {
    border-color: var(--crimson);
    background: var(--crimson-pale);
    color: var(--crimson);
    font-weight: 600;
  }

  /* ‚îÄ‚îÄ‚îÄ MULTI-SELECT TAGS (Clinical Suspicion) ‚îÄ‚îÄ‚îÄ */
  .tag-cloud {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }
  .tag {
    padding: 7px 14px;
    border: 1.5px solid var(--border);
    border-radius: 20px;
    font-size: 12px;
    cursor: pointer;
    color: var(--slate);
    background: var(--light);
    transition: all 0.2s;
    user-select: none;
  }
  .tag.selected {
    border-color: var(--crimson);
    background: var(--crimson);
    color: white;
  }
  .tag-other-wrap { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
  #otherSuspicionInput {
    margin-top: 10px;
    display: none;
    width: 300px;
  }

  /* ‚îÄ‚îÄ‚îÄ ANCILLARY PANELS ‚îÄ‚îÄ‚îÄ */
  .anc-section {
    border: 1.5px solid var(--border);
    border-radius: 10px;
    overflow: hidden;
    margin-bottom: 16px;
  }
  .anc-toggle {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 20px;
    background: var(--light);
    cursor: pointer;
    font-weight: 600;
    font-size: 14px;
    color: var(--dark);
    border: none;
    width: 100%;
    text-align: left;
    transition: background 0.2s;
  }
  .anc-toggle:hover { background: var(--gold-light); }
  .anc-toggle.enabled { background: var(--crimson-pale); color: var(--crimson); }
  .anc-toggle .toggle-icon { font-size: 18px; transition: transform 0.2s; }
  .anc-toggle.open .toggle-icon { transform: rotate(45deg); }
  .anc-body {
    display: none;
    padding: 20px;
    border-top: 1.5px solid var(--border);
  }
  .anc-body.open { display: block; }

  /* Multi-select for panels */
  .panel-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 8px;
  }
  .panel-tag {
    padding: 7px 14px;
    border: 1.5px solid var(--border);
    border-radius: 6px;
    font-size: 12px;
    font-family: var(--mono);
    cursor: pointer;
    color: var(--slate);
    background: var(--light);
    transition: all 0.2s;
    user-select: none;
  }
  .panel-tag.selected {
    border-color: var(--dark);
    background: var(--dark);
    color: white;
  }

  /* ‚îÄ‚îÄ‚îÄ PATIENT PREVIEW CARD ‚îÄ‚îÄ‚îÄ */
  .patient-card {
    background: linear-gradient(135deg, var(--dark), var(--mid));
    border-radius: 10px;
    padding: 20px 24px;
    margin-bottom: 28px;
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
    gap: 14px;
  }
  .pc-field label {
    color: var(--gold);
    font-size: 10px;
  }
  .pc-field .val {
    color: white;
    font-size: 15px;
    font-weight: 600;
    margin-top: 3px;
    font-family: var(--mono);
  }

  /* ‚îÄ‚îÄ‚îÄ RESULT ENTRY ‚îÄ‚îÄ‚îÄ */
  .result-block {
    background: var(--light);
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 16px;
    border-left: 4px solid var(--crimson);
  }
  .result-block h4 {
    font-family: var(--serif);
    font-size: 16px;
    margin-bottom: 12px;
    color: var(--dark);
  }
  .result-status {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 11px;
    font-family: var(--mono);
    padding: 4px 10px;
    border-radius: 12px;
    margin-bottom: 12px;
  }
  .status-pending { background: #fff3cd; color: #856404; }
  .status-done { background: #d1e7dd; color: var(--success); }

  textarea.result-area {
    min-height: 100px;
    resize: vertical;
    font-family: var(--mono);
    font-size: 13px;
  }

  /* ‚îÄ‚îÄ‚îÄ CR LOOKUP ‚îÄ‚îÄ‚îÄ */
  .cr-lookup {
    display: flex;
    gap: 12px;
    margin-bottom: 28px;
    align-items: flex-end;
  }
  .cr-lookup .field { flex: 1; }
  .lookup-btn {
    padding: 10px 24px;
    background: var(--crimson);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 13px;
    font-family: var(--mono);
    cursor: pointer;
    letter-spacing: 0.08em;
    transition: background 0.2s;
    white-space: nowrap;
    height: 42px;
  }
  .lookup-btn:hover { background: var(--crimson-light); }

  /* ‚îÄ‚îÄ‚îÄ SUBMIT BTN ‚îÄ‚îÄ‚îÄ */
  .submit-wrap { text-align: right; margin-top: 28px; }
  .submit-btn {
    padding: 13px 36px;
    background: var(--crimson);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-family: var(--sans);
    font-weight: 600;
    cursor: pointer;
    letter-spacing: 0.04em;
    transition: all 0.2s;
    display: inline-flex; align-items: center; gap: 8px;
  }
  .submit-btn:hover { background: var(--crimson-light); transform: translateY(-1px); box-shadow: 0 6px 20px rgba(139,26,26,0.3); }
  .submit-btn:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }

  /* ‚îÄ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ */
  .toast {
    position: fixed;
    bottom: 30px; right: 30px;
    background: var(--dark);
    color: white;
    padding: 14px 22px;
    border-radius: 10px;
    font-size: 13px;
    font-family: var(--mono);
    box-shadow: 0 8px 30px rgba(0,0,0,0.3);
    border-left: 4px solid var(--gold);
    opacity: 0;
    transform: translateY(20px);
    transition: all 0.3s ease;
    z-index: 1000;
    max-width: 360px;
  }
  .toast.show { opacity: 1; transform: translateY(0); }
  .toast.error { border-left-color: var(--crimson); }
  .toast.success { border-left-color: #2d7a4f; }

  /* ‚îÄ‚îÄ‚îÄ SETUP NOTICE ‚îÄ‚îÄ‚îÄ */
  
  

  .hidden { display: none !important; }
  
  /* Config panel */
  .config-btn {
    position: fixed;
    bottom: 20px; left: 20px;
    background: var(--mid);
    color: var(--gold);
    border: 1px solid rgba(201,168,76,0.3);
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 11px;
    font-family: var(--mono);
    cursor: pointer;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    transition: all 0.2s;
  }
  .config-btn:hover { background: var(--dark); }

  .config-modal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    z-index: 500;
    align-items: center;
    justify-content: center;
  }
  .config-modal.open { display: flex; }
  .config-box {
    background: white;
    border-radius: 14px;
    padding: 32px;
    width: 500px;
    max-width: 90vw;
  }
  .config-box h3 {
    font-family: var(--serif);
    font-size: 20px;
    margin-bottom: 6px;
  }
  .config-box p {
    font-size: 13px;
    color: var(--slate);
    margin-bottom: 20px;
    line-height: 1.5;
  }
  .config-box ol {
    font-size: 13px;
    color: var(--slate);
    line-height: 1.8;
    padding-left: 20px;
    margin-bottom: 20px;
  }
  .config-row {
    display: flex; gap: 10px; margin-top: 8px;
  }
  .config-row input { flex: 1; }
  .config-save {
    padding: 10px 20px;
    background: var(--crimson);
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 13px;
    font-family: var(--mono);
    white-space: nowrap;
  }
  .close-modal {
    float: right;
    background: none;
    border: none;
    font-size: 20px;
    cursor: pointer;
    color: var(--slate);
    margin-top: -8px;
  }




  /* ‚îÄ‚îÄ‚îÄ LAB ID COMPOSITE FIELD ‚îÄ‚îÄ‚îÄ */
  .labid-grid {
    display: grid;
    grid-template-columns: 1fr 2fr 1fr;
    gap: 8px;
    align-items: start;
    margin-top: 2px;
  }
  .labid-cell { display: flex; flex-direction: column; gap: 4px; }
  .labid-sublabel {
    font-size: 10px;
    color: var(--slate);
    font-family: var(--mono);
    letter-spacing: 0.05em;
    text-transform: uppercase;
    font-weight: 600;
  }
  .labid-type-sel {
    width: 100%;
    padding: 11px 6px;
    border: 1.5px solid var(--border);
    border-radius: 8px;
    font-size: 14px;
    font-family: var(--mono);
    font-weight: 700;
    background: white;
    color: var(--dark);
    cursor: pointer;
    outline: none;
  }
  .labid-type-sel:focus { border-color: var(--crimson); }
  @media (max-width: 400px) {
    .labid-grid { grid-template-columns: 1fr 2fr 1fr; gap: 6px; }
    .labid-type-sel { font-size: 13px; padding: 10px 4px; }
  }
  .labid-preview {
    margin-top: 8px;
    font-family: var(--mono);
    font-size: 14px;
    font-weight: 700;
    color: var(--crimson);
    letter-spacing: 0.08em;
    min-height: 20px;
  }
  .labid-preview {
    margin-top: 5px;
    font-family: var(--mono);
    font-size: 13px;
    font-weight: 700;
    color: var(--crimson);
    letter-spacing: 0.08em;
    min-height: 18px;
  }
  input.cr-error { border-color: var(--crimson) !important; }
  input.cr-ok    { border-color: #1a6a3a !important; }

  /* ‚îÄ‚îÄ‚îÄ ORDER BLOCKS ‚îÄ‚îÄ‚îÄ */
  .order-block {
    background: var(--light);
    border: 1.5px solid var(--border);
    border-radius: 10px;
    padding: 16px;
    margin-bottom: 14px;
  }
  .order-block-title {
    font-family: var(--mono);
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--dark);
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .order-block-title .req { color: var(--crimson); font-size: 13px; }

  /* Payment tags */
  .pay-tag.pay-yes.selected {
    background: #1a6a3a;
    border-color: #1a6a3a;
    color: white;
  }
  .pay-tag.pay-no.selected {
    background: var(--crimson);
    border-color: var(--crimson);
    color: white;
  }
  .pay-status-bar {
    margin-top: 10px;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 12px;
    font-family: var(--mono);
    font-weight: 600;
    letter-spacing: 0.05em;
  }
  .pay-status-bar.paid   { background: #d1e7dd; color: #0a4a20; border: 1px solid #a3cfbb; }
  .pay-status-bar.notpaid{ background: #fde8e8; color: #7a1a1a; border: 1px solid #f5c6c6; }

  /* Panel tags */
  .panel-tag.selected {
    background: #1a3a6a;
    border-color: #1a3a6a;
    color: white;
  }
  .panel-tag.other-trigger.selected {
    background: var(--slate);
    border-color: var(--slate);
  }

  /* Other input */
  .other-input-wrap {
    margin-top: 10px;
  }
  .other-input {
    width: 100%;
    padding: 10px 14px;
    border: 1.5px solid var(--gold);
    border-radius: 8px;
    font-size: 14px;
    font-family: var(--sans);
    background: var(--gold-light);
    outline: none;
  }
  .other-input:focus { border-color: var(--crimson); background: white; }

  /* Order summary strip */
  .order-summary {
    background: linear-gradient(135deg, var(--dark), var(--mid));
    border-radius: 10px;
    padding: 14px 16px;
    margin-bottom: 14px;
    font-size: 12px;
    font-family: var(--mono);
    color: var(--gold);
    line-height: 1.8;
  }
  .order-summary strong { color: white; display: block; margin-bottom: 4px; font-size: 11px; letter-spacing: 0.1em; text-transform: uppercase; }

  /* ‚îÄ‚îÄ‚îÄ PANEL RESULT BLOCKS ‚îÄ‚îÄ‚îÄ */
  .panel-result-block {
    border: 1.5px solid var(--border);
    border-radius: 8px;
    padding: 12px 14px;
    margin-bottom: 10px;
    background: white;
    transition: border-color 0.2s;
  }
  .panel-result-block.accepted { border-color: #1a6a3a; }
  .panel-result-block.rejected { border-color: var(--crimson); opacity: 0.6; }
  .panel-result-block.inactive { opacity: 0.35; pointer-events: none; }
  .prb-title {
    font-family: var(--mono);
    font-size: 12px;
    font-weight: 700;
    letter-spacing: 0.08em;
    color: var(--dark);
    margin-bottom: 10px;
    text-transform: uppercase;
  }


  /* ‚îÄ‚îÄ‚îÄ ROLE SELECTION SCREEN ‚îÄ‚îÄ‚îÄ */
  #screen-role {
    position: fixed;
    inset: 0;
    background: var(--dark);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    padding: 32px 24px;
  }
  .role-logo {
    font-family: var(--mono);
    font-size: 36px;
    font-weight: 900;
    color: var(--crimson);
    letter-spacing: 0.15em;
    margin-bottom: 6px;
  }
  .role-tagline {
    font-size: 11px;
    color: #888;
    font-family: var(--mono);
    letter-spacing: 0.1em;
    text-transform: uppercase;
    margin-bottom: 40px;
    text-align: center;
  }
  .role-prompt {
    font-size: 13px;
    color: #aaa;
    font-family: var(--mono);
    letter-spacing: 0.08em;
    text-transform: uppercase;
    margin-bottom: 20px;
  }
  .role-cards {
    display: flex;
    flex-direction: column;
    gap: 14px;
    width: 100%;
    max-width: 360px;
  }
  .role-card {
    background: #1a1a1a;
    border: 1.5px solid #333;
    border-radius: 14px;
    padding: 20px 22px;
    cursor: pointer;
    transition: all 0.18s;
    display: flex;
    align-items: center;
    gap: 16px;
  }
  .role-card:active, .role-card:hover { border-color: var(--crimson); background: #222; transform: scale(0.98); }
  .role-icon { font-size: 28px; flex-shrink: 0; }
  .role-info { flex: 1; }
  .role-name {
    font-family: var(--mono);
    font-size: 15px;
    font-weight: 700;
    color: white;
    margin-bottom: 4px;
  }
  .role-desc { font-size: 11px; color: #888; line-height: 1.4; }
  .role-access {
    font-size: 10px;
    color: var(--crimson);
    font-family: var(--mono);
    margin-top: 5px;
    font-weight: 600;
  }
  .role-badge {
    position: fixed;
    bottom: 70px;
    right: 16px;
    background: var(--dark);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 5px 12px;
    font-family: var(--mono);
    font-size: 10px;
    font-weight: 700;
    color: var(--slate);
    letter-spacing: 0.08em;
    cursor: pointer;
    z-index: 100;
  }
  .role-badge.resident { color: #1a6a3a; border-color: #1a6a3a; }
  .role-badge.lab      { color: #b8860b; border-color: #b8860b; }
  .role-badge.senior   { color: var(--crimson); border-color: var(--crimson); }
  .home-card.locked {
    opacity: 0.25;
    pointer-events: none;
    filter: grayscale(1);
  }


  /* ‚îÄ‚îÄ‚îÄ WORKFLOW BLOCK MESSAGE ‚îÄ‚îÄ‚îÄ */
  .workflow-block {
    display: none;
    background: #fde8e8;
    border: 1.5px solid var(--crimson);
    border-radius: 10px;
    padding: 14px 16px;
    margin: 12px 0;
    font-size: 13px;
    color: var(--crimson);
    font-weight: 600;
    line-height: 1.5;
  }
  .workflow-block.visible { display: block; }
  .workflow-block .wf-icon { font-size: 20px; margin-right: 8px; vertical-align: middle; }
  /* ‚îÄ‚îÄ‚îÄ RESULT OPTION TAGS ‚îÄ‚îÄ‚îÄ */
  .result-opt {
    font-size: 12px;
    font-weight: 600;
    min-height: 40px;
    padding: 8px 10px;
    text-align: center;
    border-color: var(--border);
    color: var(--dark);
    transition: all 0.15s;
  }
  .result-opt.selected {
    background: #1a3a6a;
    border-color: #1a3a6a;
    color: white;
  }
  .result-opt.selected-positive {
    background: var(--crimson);
    border-color: var(--crimson);
    color: white;
  }
  .result-opt.selected-negative {
    background: #1a6a3a;
    border-color: #1a6a3a;
    color: white;
  }
  .result-opt.selected-inconclusive {
    background: #b8860b;
    border-color: #b8860b;
    color: white;
  }
  /* ‚îÄ‚îÄ‚îÄ OK / PP / HP STATUS TAGS ‚îÄ‚îÄ‚îÄ */
  .ok-tag { color: #1a6a3a; border-color: #1a6a3a; font-weight: 700; font-size: 15px; min-height: 48px; }
  .pp-tag { color: #8a6000; border-color: #b8860b; font-weight: 700; font-size: 15px; min-height: 48px; }
  .hp-tag { color: var(--crimson); border-color: var(--crimson); font-weight: 700; font-size: 15px; min-height: 48px; }
  .ok-tag.selected { background: #1a6a3a; border-color: #1a6a3a; color: white; }
  .pp-tag.selected { background: #b8860b; border-color: #b8860b; color: white; }
  .hp-tag.selected { background: var(--crimson); border-color: var(--crimson); color: white; }
  .panel-result-block.ok-status { border-color: #1a6a3a; border-width: 2px; }
  .panel-result-block.pp-status { border-color: #b8860b; border-width: 2px; }
  .panel-result-block.hp-status { border-color: var(--crimson); border-width: 2px; }
  .panel-result-block.inactive { opacity: 0.3; pointer-events: none; }
  .status-badge-inline {
    font-family: var(--mono);
    font-size: 11px;
    font-weight: 700;
    padding: 2px 8px;
    border-radius: 10px;
    letter-spacing: 0.1em;
  }
  .status-badge-inline.ok  { background: #d1e7dd; color: #1a6a3a; }
  .status-badge-inline.pp  { background: #fff3cd; color: #8a6000; }
  .status-badge-inline.hp  { background: #fde8e8; color: var(--crimson); }

  /* ‚îÄ‚îÄ‚îÄ ACCEPTANCE TAGS ‚îÄ‚îÄ‚îÄ */
  .accept-yes {
    border-color: #1a6a3a;
    color: #1a6a3a;
    font-weight: 600;
    font-size: 14px;
    min-height: 52px;
  }
  .accept-no {
    border-color: var(--crimson);
    color: var(--crimson);
    font-weight: 600;
    font-size: 14px;
    min-height: 52px;
  }
  .accept-yes.selected {
    background: #1a6a3a;
    border-color: #1a6a3a;
    color: white;
  }
  .accept-no.selected {
    background: var(--crimson);
    border-color: var(--crimson);
    color: white;
  }

  /* ‚îÄ‚îÄ‚îÄ SUB-TABS (mobile first) ‚îÄ‚îÄ‚îÄ */
  .sub-tabs {
    display: flex;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    gap: 0;
    margin: -36px -32px 24px;
    border-bottom: 2px solid var(--border);
    background: var(--light);
    scrollbar-width: none;
  }
  .sub-tabs::-webkit-scrollbar { display: none; }
  .sub-tab {
    flex-shrink: 0;
    padding: 14px 18px;
    background: none;
    border: none;
    border-bottom: 3px solid transparent;
    font-size: 13px;
    font-family: var(--mono);
    font-weight: 500;
    letter-spacing: 0.06em;
    color: var(--slate);
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
  }
  .sub-tab.active {
    color: var(--crimson);
    border-bottom-color: var(--crimson);
    background: white;
  }
  .sub-panel { display: none; }
  .sub-panel.active { display: block; }

  /* ‚îÄ‚îÄ‚îÄ MOBILE TAG GRID ‚îÄ‚îÄ‚îÄ */
  .mobile-tag-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: 8px;
    margin-bottom: 16px;
  }
  .mtag {
    padding: 11px 12px;
    border: 1.5px solid var(--border);
    border-radius: 8px;
    font-size: 12px;
    font-family: var(--sans);
    cursor: pointer;
    color: var(--slate);
    background: var(--light);
    transition: all 0.18s;
    user-select: none;
    text-align: center;
    line-height: 1.3;
    min-height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .mtag.selected {
    border-color: var(--crimson);
    background: var(--crimson);
    color: white;
    font-weight: 600;
  }
  .mtag.pay-tag.selected {
    border-color: var(--dark);
    background: var(--dark);
  }
  .mtag.status-tag.selected {
    border-color: var(--success);
    background: var(--success);
  }

  /* ‚îÄ‚îÄ‚îÄ MOBILE NOTES / SAVE ‚îÄ‚îÄ‚îÄ */
  .mob-notes {
    width: 100%;
    padding: 12px 14px;
    border: 1.5px solid var(--border);
    border-radius: 8px;
    font-size: 14px;
    font-family: var(--sans);
    resize: vertical;
    min-height: 80px;
    margin-bottom: 14px;
    background: var(--light);
    outline: none;
  }
  .mob-notes.tall { min-height: 130px; }
  .mob-notes:focus { border-color: var(--crimson); background: white; }

  .mob-save-btn {
    width: 100%;
    padding: 16px;
    background: var(--crimson);
    color: white;
    border: none;
    border-radius: 10px;
    font-size: 15px;
    font-family: var(--sans);
    font-weight: 600;
    cursor: pointer;
    margin-top: 4px;
    transition: background 0.2s;
  }
  .mob-save-btn:hover, .mob-save-btn:active { background: var(--crimson-light); }

  /* ‚îÄ‚îÄ‚îÄ ORDERED SUMMARY BADGE ‚îÄ‚îÄ‚îÄ */
  .ordered-summary {
    background: var(--gold-light);
    border: 1px solid var(--gold);
    border-radius: 8px;
    padding: 10px 14px;
    font-size: 12px;
    font-family: var(--mono);
    color: #5a4200;
    margin-bottom: 16px;
    line-height: 1.6;
  }
  .ordered-summary.empty { display: none; }

  /* ‚îÄ‚îÄ‚îÄ MOBILE PANEL BODY ‚îÄ‚îÄ‚îÄ */
  @media (max-width: 640px) {
    .panel-body { padding: 20px 14px; }
    .sub-tabs { margin: -20px -14px 20px; }
    .panel-header { padding: 16px 14px; }
    .panel-header h2 { font-size: 17px; }
    .mobile-tag-grid { grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 7px; }
    .cr-lookup { flex-direction: column; gap: 8px; }
    .cr-lookup .lookup-btn { width: 100%; }
    .patient-card { grid-template-columns: 1fr 1fr; }
    header { padding: 12px 14px; }
    header h1 { font-size: 16px; }
    .home-cards { grid-template-columns: 1fr; gap: 12px; }
    .home-title { font-size: 26px; }
    .home-screen { padding: 30px 4px; }
    .home-card { padding: 22px 18px; }
  }

  /* ‚îÄ‚îÄ‚îÄ INTEGRATED REPORT ‚îÄ‚îÄ‚îÄ */
  .rpt-header {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 20px 24px;
    background: linear-gradient(135deg, var(--dark), var(--mid));
    border-radius: 10px;
    margin-bottom: 20px;
  }
  .rpt-logo {
    font-family: var(--mono);
    font-size: 13px;
    font-weight: 700;
    color: white;
    background: var(--crimson);
    padding: 10px 14px;
    border-radius: 8px;
    flex-shrink: 0;
    letter-spacing: 0.05em;
  }
  .rpt-title {
    font-family: var(--serif);
    font-size: 18px;
    color: white;
  }
  .rpt-subtitle {
    font-family: var(--mono);
    font-size: 10px;
    color: var(--gold);
    letter-spacing: 0.1em;
    text-transform: uppercase;
    margin-top: 4px;
  }
  .rpt-print-btn {
    margin-left: auto;
    flex-shrink: 0;
    padding: 9px 18px;
    background: var(--gold);
    color: var(--dark);
    border: none;
    border-radius: 7px;
    font-size: 12px;
    font-family: var(--mono);
    font-weight: 600;
    cursor: pointer;
    letter-spacing: 0.05em;
    transition: background 0.2s;
  }
  .rpt-print-btn:hover { background: #b8953e; color: white; }

  .rpt-section {
    background: white;
    border: 1.5px solid var(--border);
    border-radius: 10px;
    margin-bottom: 14px;
    overflow: hidden;
  }
  .rpt-section-title {
    font-family: var(--mono);
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: white;
    background: var(--slate);
    padding: 10px 18px;
  }
  .rpt-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
    gap: 0;
    padding: 4px 0;
  }
  .rpt-cell {
    padding: 12px 18px;
    border-right: 1px solid var(--border);
    border-bottom: 1px solid var(--border);
  }
  .rpt-cell label {
    font-size: 10px;
    font-weight: 600;
    color: var(--slate);
    letter-spacing: 0.08em;
    text-transform: uppercase;
    display: block;
    margin-bottom: 4px;
  }
  .rpt-cell .val {
    font-size: 14px;
    color: var(--dark);
    font-weight: 500;
    word-break: break-word;
  }
  .rpt-cell .val.suspicion {
    font-size: 12px;
    color: var(--crimson);
    font-weight: 600;
  }

  .rpt-lab-block {
    background: white;
    border: 1.5px solid var(--border);
    border-radius: 10px;
    margin-bottom: 14px;
    overflow: hidden;
  }
  .rpt-lab-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 18px;
    font-family: var(--mono);
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: white;
  }
  .rpt-lab-header.fish  { background: #6a1a6a; }
  .rpt-lab-header.fcm   { background: #1a4a8a; }
  .rpt-lab-header.rtpcr { background: #1a6a4a; }
  .rpt-lab-header.ngsh12{ background: #6a4a1a; }
  .rpt-lab-header.ngsh9 { background: #1a3a6a; }
  .rpt-lab-header.tcr   { background: #5a1a3a; }

  .rpt-status-badge {
    font-size: 11px;
    padding: 3px 10px;
    border-radius: 12px;
    font-weight: 600;
    background: rgba(255,255,255,0.2);
    color: white;
  }
  .rpt-lab-body { padding: 16px 18px; }
  .rpt-ordered {
    font-size: 12px;
    font-family: var(--mono);
    color: var(--slate);
    background: var(--light);
    padding: 8px 12px;
    border-radius: 6px;
    margin-bottom: 12px;
    line-height: 1.6;
  }
  .rpt-result-text {
    font-size: 13px;
    color: var(--dark);
    line-height: 1.7;
    white-space: pre-wrap;
    padding: 10px 14px;
    background: var(--crimson-pale);
    border-left: 3px solid var(--crimson);
    border-radius: 0 6px 6px 0;
  }
  .rpt-no-data {
    font-size: 12px;
    color: #aaa;
    font-style: italic;
    padding: 8px 0;
  }

  .rpt-footer {
    text-align: center;
    font-family: var(--mono);
    font-size: 10px;
    color: var(--slate);
    padding: 16px;
    letter-spacing: 0.08em;
  }

  @media print {
    header, .config-btn, .back-btn, .rpt-print-btn,
    .cr-lookup, #screen-home, #screen-register,
    #screen-order, #screen-results { display: none !important; }
    body { background: white !important; }
    .panel { box-shadow: none !important; }
    .panel-header { display: none !important; }
    .rpt-section, .rpt-lab-block { break-inside: avoid; }
  }

  @media (max-width: 640px) {
    .rpt-header { flex-wrap: wrap; gap: 10px; }
    .rpt-print-btn { margin-left: 0; width: 100%; text-align: center; }
    .rpt-grid { grid-template-columns: 1fr 1fr; }
  }
  @media (max-width: 640px) {
    .form-grid.cols-3 { grid-template-columns: 1fr 1fr; }
    .form-grid.cols-2 { grid-template-columns: 1fr; }
    .panel-body { padding: 20px 16px; }
    .home-title { font-size: 28px; }
  }
</style>
</head>
<body>

<header>
  <div class="logo-mark"><span style="color:var(--crimson);">P</span><span style="color:var(--crimson);">R</span><span style="color:var(--crimson);">I</span><span style="color:var(--crimson);">S</span><span style="color:var(--crimson);">M</span></div>
  <div>
    <h1><span style="color:var(--crimson);">P</span><span style="color:var(--crimson);">R</span><span style="color:var(--crimson);">I</span><span style="color:var(--crimson);">S</span><span style="color:var(--crimson);">M</span></h1>
    <p><span style="color:var(--crimson);font-weight:700;">P</span>GIMER-HemePath <span style="color:var(--crimson);font-weight:700;">R</span>egistry for <span style="color:var(--crimson);font-weight:700;">I</span>ntegrated <span style="color:var(--crimson);font-weight:700;">S</span>ample <span style="color:var(--crimson);font-weight:700;">M</span>anagement</p>
  </div>
</header>

<div class="main">

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ROLE SELECTION ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div id="screen-role" style="position:fixed;inset:0;background:#111;display:none;flex-direction:column;align-items:center;justify-content:center;z-index:99999;padding:32px 24px;">
    <div style="font-family:var(--mono);font-size:40px;font-weight:900;letter-spacing:0.18em;margin-bottom:4px;"><span style="color:var(--crimson);font-weight:700;">P</span><span style="color:var(--crimson);font-weight:700;">R</span><span style="color:var(--crimson);font-weight:700;">I</span><span style="color:var(--crimson);font-weight:700;">S</span><span style="color:var(--crimson);font-weight:700;">M</span></div>
    <div style="font-size:12px;color:#ccc;font-weight:600;letter-spacing:0.03em;margin-bottom:4px;text-align:center;line-height:1.9;">
      <span style="color:var(--crimson);">P</span>GIMER-HemePath
      <span style="color:var(--crimson);">R</span>egistry for
      <span style="color:var(--crimson);">I</span>ntegrated
      <span style="color:var(--crimson);">S</span>ample
      <span style="color:var(--crimson);">M</span>anagement
    </div>
    <div style="font-size:13px;color:#aaa;font-family:var(--mono);letter-spacing:0.08em;text-transform:uppercase;margin-bottom:20px;">Who are you?</div>
    <div style="display:flex;flex-direction:column;gap:10px;width:100%;max-width:380px;overflow-y:auto;max-height:70vh;padding-right:4px;">

      <div onclick="selectRole('resident')" style="background:#1a1a1a;border:1.5px solid #333;border-radius:14px;padding:16px 18px;cursor:pointer;display:flex;align-items:center;gap:14px;">
        <div style="font-size:24px;flex-shrink:0;">ü©∫</div>
        <div>
          <div style="font-family:var(--mono);font-size:13px;font-weight:700;color:white;margin-bottom:2px;">Resident Doctor</div>
          <div style="font-size:10px;color:#888;">Register patients and order tests</div>
          <div style="font-size:10px;color:var(--crimson);font-family:var(--mono);margin-top:3px;font-weight:600;">Module 01 ¬∑ Module 02 ¬∑ Module 03</div>
        </div>
      </div>

      <div style="background:#1a1a1a;border:1.5px solid #333;border-radius:14px;padding:16px 18px;">
        <div style="display:flex;align-items:center;gap:14px;cursor:pointer;" onclick="togglePwdPrompt('fish')">
          <div style="font-size:24px;flex-shrink:0;">üî¨</div>
          <div style="flex:1;">
            <div style="font-family:var(--mono);font-size:13px;font-weight:700;color:white;margin-bottom:2px;">FISH Lab</div>
            <div style="font-size:10px;color:#888;">Test acceptance and result entry</div>
            <div style="font-size:10px;color:var(--crimson);font-family:var(--mono);margin-top:3px;font-weight:600;">Module 04 FISH ¬∑ Module 05 FISH</div>
          </div>
          <div style="color:#555;font-size:16px;">üîí</div>
        </div>
        <div id="pwd-prompt-fish" style="display:none;margin-top:10px;padding-top:10px;border-top:1px solid #333;">
          <div style="display:flex;gap:8px;align-items:center;">
            <input type="password" id="pwd-input-fish" placeholder="FISH password"
              style="flex:1;padding:9px 11px;border-radius:8px;border:1.5px solid #444;background:#111;color:white;font-size:13px;font-family:var(--mono);outline:none;"
              onkeydown="if(event.key==='Enter')verifyRolePwd('fish');if(event.key==='Escape')togglePwdPrompt('fish')">
            <button onclick="verifyRolePwd('fish')" style="padding:9px 14px;background:var(--crimson);color:white;border:none;border-radius:8px;font-family:var(--mono);font-weight:700;font-size:13px;cursor:pointer;">‚Üí</button>
          </div>
          <div id="pwd-err-fish" style="color:#ff6b6b;font-size:10px;font-family:var(--mono);margin-top:6px;min-height:14px;"></div>
        </div>
      </div>

      <div style="background:#1a1a1a;border:1.5px solid #333;border-radius:14px;padding:16px 18px;">
        <div style="display:flex;align-items:center;gap:14px;cursor:pointer;" onclick="togglePwdPrompt('fcm')">
          <div style="font-size:24px;flex-shrink:0;">üî¨</div>
          <div style="flex:1;">
            <div style="font-family:var(--mono);font-size:13px;font-weight:700;color:white;margin-bottom:2px;">FCM Lab</div>
            <div style="font-size:10px;color:#888;">Test acceptance and result entry</div>
            <div style="font-size:10px;color:var(--crimson);font-family:var(--mono);margin-top:3px;font-weight:600;">Module 04 FCM ¬∑ Module 05 FCM</div>
          </div>
          <div style="color:#555;font-size:16px;">üîí</div>
        </div>
        <div id="pwd-prompt-fcm" style="display:none;margin-top:10px;padding-top:10px;border-top:1px solid #333;">
          <div style="display:flex;gap:8px;align-items:center;">
            <input type="password" id="pwd-input-fcm" placeholder="FCM password"
              style="flex:1;padding:9px 11px;border-radius:8px;border:1.5px solid #444;background:#111;color:white;font-size:13px;font-family:var(--mono);outline:none;"
              onkeydown="if(event.key==='Enter')verifyRolePwd('fcm');if(event.key==='Escape')togglePwdPrompt('fcm')">
            <button onclick="verifyRolePwd('fcm')" style="padding:9px 14px;background:var(--crimson);color:white;border:none;border-radius:8px;font-family:var(--mono);font-weight:700;font-size:13px;cursor:pointer;">‚Üí</button>
          </div>
          <div id="pwd-err-fcm" style="color:#ff6b6b;font-size:10px;font-family:var(--mono);margin-top:6px;min-height:14px;"></div>
        </div>
      </div>

      <div style="background:#1a1a1a;border:1.5px solid #333;border-radius:14px;padding:16px 18px;">
        <div style="display:flex;align-items:center;gap:14px;cursor:pointer;" onclick="togglePwdPrompt('rtpcr')">
          <div style="font-size:24px;flex-shrink:0;">üî¨</div>
          <div style="flex:1;">
            <div style="font-family:var(--mono);font-size:13px;font-weight:700;color:white;margin-bottom:2px;">RT-PCR Lab</div>
            <div style="font-size:10px;color:#888;">Test acceptance and result entry</div>
            <div style="font-size:10px;color:var(--crimson);font-family:var(--mono);margin-top:3px;font-weight:600;">Module 04 RT-PCR ¬∑ Module 05 RT-PCR</div>
          </div>
          <div style="color:#555;font-size:16px;">üîí</div>
        </div>
        <div id="pwd-prompt-rtpcr" style="display:none;margin-top:10px;padding-top:10px;border-top:1px solid #333;">
          <div style="display:flex;gap:8px;align-items:center;">
            <input type="password" id="pwd-input-rtpcr" placeholder="RT-PCR password"
              style="flex:1;padding:9px 11px;border-radius:8px;border:1.5px solid #444;background:#111;color:white;font-size:13px;font-family:var(--mono);outline:none;"
              onkeydown="if(event.key==='Enter')verifyRolePwd('rtpcr');if(event.key==='Escape')togglePwdPrompt('rtpcr')">
            <button onclick="verifyRolePwd('rtpcr')" style="padding:9px 14px;background:var(--crimson);color:white;border:none;border-radius:8px;font-family:var(--mono);font-weight:700;font-size:13px;cursor:pointer;">‚Üí</button>
          </div>
          <div id="pwd-err-rtpcr" style="color:#ff6b6b;font-size:10px;font-family:var(--mono);margin-top:6px;min-height:14px;"></div>
        </div>
      </div>

      <div style="background:#1a1a1a;border:1.5px solid #333;border-radius:14px;padding:16px 18px;">
        <div style="display:flex;align-items:center;gap:14px;cursor:pointer;" onclick="togglePwdPrompt('ngsh12')">
          <div style="font-size:24px;flex-shrink:0;">üî¨</div>
          <div style="flex:1;">
            <div style="font-family:var(--mono);font-size:13px;font-weight:700;color:white;margin-bottom:2px;">NGS-H12 Lab</div>
            <div style="font-size:10px;color:#888;">Test acceptance and result entry</div>
            <div style="font-size:10px;color:var(--crimson);font-family:var(--mono);margin-top:3px;font-weight:600;">Module 04 NGS-H12 ¬∑ Module 05 NGS-H12</div>
          </div>
          <div style="color:#555;font-size:16px;">üîí</div>
        </div>
        <div id="pwd-prompt-ngsh12" style="display:none;margin-top:10px;padding-top:10px;border-top:1px solid #333;">
          <div style="display:flex;gap:8px;align-items:center;">
            <input type="password" id="pwd-input-ngsh12" placeholder="NGS-H12 password"
              style="flex:1;padding:9px 11px;border-radius:8px;border:1.5px solid #444;background:#111;color:white;font-size:13px;font-family:var(--mono);outline:none;"
              onkeydown="if(event.key==='Enter')verifyRolePwd('ngsh12');if(event.key==='Escape')togglePwdPrompt('ngsh12')">
            <button onclick="verifyRolePwd('ngsh12')" style="padding:9px 14px;background:var(--crimson);color:white;border:none;border-radius:8px;font-family:var(--mono);font-weight:700;font-size:13px;cursor:pointer;">‚Üí</button>
          </div>
          <div id="pwd-err-ngsh12" style="color:#ff6b6b;font-size:10px;font-family:var(--mono);margin-top:6px;min-height:14px;"></div>
        </div>
      </div>

      <div style="background:#1a1a1a;border:1.5px solid #333;border-radius:14px;padding:16px 18px;">
        <div style="display:flex;align-items:center;gap:14px;cursor:pointer;" onclick="togglePwdPrompt('ngsh9')">
          <div style="font-size:24px;flex-shrink:0;">üî¨</div>
          <div style="flex:1;">
            <div style="font-family:var(--mono);font-size:13px;font-weight:700;color:white;margin-bottom:2px;">NGS-H9 Lab</div>
            <div style="font-size:10px;color:#888;">Test acceptance and result entry</div>
            <div style="font-size:10px;color:var(--crimson);font-family:var(--mono);margin-top:3px;font-weight:600;">Module 04 NGS-H9 ¬∑ Module 05 NGS-H9</div>
          </div>
          <div style="color:#555;font-size:16px;">üîí</div>
        </div>
        <div id="pwd-prompt-ngsh9" style="display:none;margin-top:10px;padding-top:10px;border-top:1px solid #333;">
          <div style="display:flex;gap:8px;align-items:center;">
            <input type="password" id="pwd-input-ngsh9" placeholder="NGS-H9 password"
              style="flex:1;padding:9px 11px;border-radius:8px;border:1.5px solid #444;background:#111;color:white;font-size:13px;font-family:var(--mono);outline:none;"
              onkeydown="if(event.key==='Enter')verifyRolePwd('ngsh9');if(event.key==='Escape')togglePwdPrompt('ngsh9')">
            <button onclick="verifyRolePwd('ngsh9')" style="padding:9px 14px;background:var(--crimson);color:white;border:none;border-radius:8px;font-family:var(--mono);font-weight:700;font-size:13px;cursor:pointer;">‚Üí</button>
          </div>
          <div id="pwd-err-ngsh9" style="color:#ff6b6b;font-size:10px;font-family:var(--mono);margin-top:6px;min-height:14px;"></div>
        </div>
      </div>

      <div style="background:#1a1a1a;border:1.5px solid #333;border-radius:14px;padding:16px 18px;">
        <div style="display:flex;align-items:center;gap:14px;cursor:pointer;" onclick="togglePwdPrompt('tcr')">
          <div style="font-size:24px;flex-shrink:0;">üî¨</div>
          <div style="flex:1;">
            <div style="font-family:var(--mono);font-size:13px;font-weight:700;color:white;margin-bottom:2px;">TCR Lab</div>
            <div style="font-size:10px;color:#888;">Test acceptance and result entry</div>
            <div style="font-size:10px;color:var(--crimson);font-family:var(--mono);margin-top:3px;font-weight:600;">Module 04 TCR ¬∑ Module 05 TCR</div>
          </div>
          <div style="color:#555;font-size:16px;">üîí</div>
        </div>
        <div id="pwd-prompt-tcr" style="display:none;margin-top:10px;padding-top:10px;border-top:1px solid #333;">
          <div style="display:flex;gap:8px;align-items:center;">
            <input type="password" id="pwd-input-tcr" placeholder="TCR password"
              style="flex:1;padding:9px 11px;border-radius:8px;border:1.5px solid #444;background:#111;color:white;font-size:13px;font-family:var(--mono);outline:none;"
              onkeydown="if(event.key==='Enter')verifyRolePwd('tcr');if(event.key==='Escape')togglePwdPrompt('tcr')">
            <button onclick="verifyRolePwd('tcr')" style="padding:9px 14px;background:var(--crimson);color:white;border:none;border-radius:8px;font-family:var(--mono);font-weight:700;font-size:13px;cursor:pointer;">‚Üí</button>
          </div>
          <div id="pwd-err-tcr" style="color:#ff6b6b;font-size:10px;font-family:var(--mono);margin-top:6px;min-height:14px;"></div>
        </div>
      </div>

      <div style="background:#1a1a1a;border:1.5px solid #333;border-radius:14px;padding:16px 18px;">
        <div style="display:flex;align-items:center;gap:14px;cursor:pointer;" onclick="togglePwdPrompt('consultant')">
          <div style="font-size:24px;flex-shrink:0;">üë®‚Äç‚öïÔ∏è</div>
          <div style="flex:1;">
            <div style="font-family:var(--mono);font-size:13px;font-weight:700;color:white;margin-bottom:2px;">Consultant</div>
            <div style="font-size:10px;color:#888;">Integrated report access only</div>
            <div style="font-size:10px;color:var(--crimson);font-family:var(--mono);margin-top:3px;font-weight:600;">Module 06 ¬∑ Module 07</div>
          </div>
          <div style="color:#555;font-size:16px;">üîí</div>
        </div>
        <div id="pwd-prompt-consultant" style="display:none;margin-top:10px;padding-top:10px;border-top:1px solid #333;">
          <div style="display:flex;gap:8px;align-items:center;">
            <input type="password" id="pwd-input-consultant" placeholder="Consultant password"
              style="flex:1;padding:9px 11px;border-radius:8px;border:1.5px solid #444;background:#111;color:white;font-size:13px;font-family:var(--mono);outline:none;"
              onkeydown="if(event.key==='Enter')verifyRolePwd('consultant');if(event.key==='Escape')togglePwdPrompt('consultant')">
            <button onclick="verifyRolePwd('consultant')" style="padding:9px 14px;background:var(--crimson);color:white;border:none;border-radius:8px;font-family:var(--mono);font-weight:700;font-size:13px;cursor:pointer;">‚Üí</button>
          </div>
          <div id="pwd-err-consultant" style="color:#ff6b6b;font-size:10px;font-family:var(--mono);margin-top:6px;min-height:14px;"></div>
        </div>
      </div>

      <div style="background:#1a1a1a;border:1.5px solid #333;border-radius:14px;padding:16px 18px;">
        <div style="display:flex;align-items:center;gap:14px;cursor:pointer;" onclick="togglePwdPrompt('admin')">
          <div style="font-size:24px;flex-shrink:0;">üîë</div>
          <div style="flex:1;">
            <div style="font-family:var(--mono);font-size:13px;font-weight:700;color:white;margin-bottom:2px;">Administrator</div>
            <div style="font-size:10px;color:#888;">Full access to all modules</div>
            <div style="font-size:10px;color:var(--crimson);font-family:var(--mono);margin-top:3px;font-weight:600;">All Modules</div>
          </div>
          <div style="color:#555;font-size:16px;">üîí</div>
        </div>
        <div id="pwd-prompt-admin" style="display:none;margin-top:10px;padding-top:10px;border-top:1px solid #333;">
          <div style="display:flex;gap:8px;align-items:center;">
            <input type="password" id="pwd-input-admin" placeholder="Admin password"
              style="flex:1;padding:9px 11px;border-radius:8px;border:1.5px solid #444;background:#111;color:white;font-size:13px;font-family:var(--mono);outline:none;"
              onkeydown="if(event.key==='Enter')verifyRolePwd('admin');if(event.key==='Escape')togglePwdPrompt('admin')">
            <button onclick="verifyRolePwd('admin')" style="padding:9px 14px;background:var(--crimson);color:white;border:none;border-radius:8px;font-family:var(--mono);font-weight:700;font-size:13px;cursor:pointer;">‚Üí</button>
          </div>
          <div id="pwd-err-admin" style="color:#ff6b6b;font-size:10px;font-family:var(--mono);margin-top:6px;min-height:14px;"></div>
        </div>
      </div>

    </div>

    <div style="position:absolute;bottom:24px;left:0;right:0;text-align:center;">
      <div style="font-size:10px;color:#444;font-family:var(--mono);letter-spacing:0.04em;line-height:1.8;">
        &copy; Dept of Hematology, PGIMER, Chandigarh
      </div>
    </div>

  </div>

  <!-- Role badge -->
  <div id="role-badge" onclick="switchRole()" title="Tap to switch role" style="display:none;position:fixed;bottom:70px;right:16px;background:var(--dark);border:1px solid var(--border);border-radius:20px;padding:5px 12px;font-family:var(--mono);font-size:10px;font-weight:700;color:var(--slate);letter-spacing:0.08em;cursor:pointer;z-index:100;"></div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HOME ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div id="screen-home" class="home-screen">
    <h2 class="home-title"><span style="color:var(--crimson);font-weight:700;">P</span><span style="color:var(--crimson);font-weight:700;">R</span><span style="color:var(--crimson);font-weight:700;">I</span><span style="color:var(--crimson);font-weight:700;">S</span><span style="color:var(--crimson);font-weight:700;">M</span></h2>
    <p class="home-subtitle" style="font-size:13px;letter-spacing:0.08em;margin-bottom:6px;">PGIMER HemePath Registry for Integrated Sample Management</p>
    <p class="home-subtitle" style="margin-bottom:50px;">Hematopathology ¬∑ Bone Marrow ¬∑ Molecular ¬∑ Cytogenetics</p>
    <div class="home-cards">
      <div class="home-card" onclick="showScreen('screen-register')">
        <div class="card-num">Module 01</div>
        <div class="card-icon">ü©∏</div>
        <h3>Register Patient</h3>
        <p>Enter patient demographics, CR number, Lab ID, and clinical suspicion for new bone marrow cases.</p>
        <div class="card-btn">Open ‚Üí</div>
      </div>
      <div class="home-card" onclick="showScreen('screen-morph')">
        <div class="card-num">Module 02</div>
        <div class="card-icon">ü¶¥</div>
        <h3>BM Morphology</h3>
        <p>Enter bone marrow morphology report findings by CR number.</p>
        <div class="card-btn">Open ‚Üí</div>
      </div>
      <div class="home-card" onclick="showScreen('screen-order')">
        <div class="card-num">Module 03</div>
        <div class="card-icon">üî¨</div>
        <h3>Order Tests</h3>
        <p>Order FISH ¬∑ FCM ¬∑ RT-PCR ¬∑ NGS-H12 ¬∑ NGS-H9 panels after morphology review.</p>
        <div class="card-btn">Open ‚Üí</div>
      </div>
      <div class="home-card" onclick="showScreen('screen-results')">
        <div class="card-num">Module 04</div>
        <div class="card-icon">‚úÖ</div>
        <h3>Test Acceptance</h3>
        <p>Mark each ordered panel as OK ¬∑ PP ¬∑ HP for sample acceptance and payment status.</p>
        <div class="card-btn">Open ‚Üí</div>
      </div>
      <div class="home-card" onclick="showScreen('screen-entry')">
        <div class="card-num">Module 05</div>
        <div class="card-icon">üìù</div>
        <h3>Result Entry</h3>
        <p>Enter laboratory results for each accepted panel by CR number.</p>
        <div class="card-btn">Open ‚Üí</div>
      </div>
      <div class="home-card" onclick="showScreen('screen-provbm')">
        <div class="card-num">Module 07</div>
        <div class="card-icon">üìã</div>
        <h3>Provisional BM Report</h3>
        <p>Generate provisional bone marrow report for patient communication.</p>
        <div class="card-btn">Open ‚Üí</div>
      </div>

      <div class="home-card" onclick="showScreen('screen-report')">
        <div class="card-num">Module 06</div>
        <div class="card-icon">üìä</div>
        <h3>Integrated Report</h3>
        <p>View complete case summary ‚Äî morphology, all ancillary orders and results in one place.</p>
        <div class="card-btn">Open ‚Üí</div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODULE 1: REGISTER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div id="screen-register" class="panel">
    <div class="panel-header">
      <button class="back-btn" onclick="showScreen('screen-home')">‚Üê Back</button>
      <h2>Patient Registration</h2>
      <span class="step-badge">Module 01</span>
    </div>
    <div class="panel-body">
<!-- IDs -->
      <div class="form-section">
        <div class="section-label">Case Identifiers</div>
        <div class="form-grid cols-3">
          <div class="field">
            <label>CR Number <span class="req">*</span> <span style="font-size:10px;font-weight:400;color:var(--slate);">12 digits</span></label>
            <input type="text" id="reg_cr" placeholder="e.g. 202600012345" maxlength="12" inputmode="numeric"
              oninput="this.value=this.value.replace(/\D/g,'').slice(0,12); validateCR(this);">
            <div id="cr_hint" style="font-size:10px;color:var(--slate);margin-top:3px;"></div>
          </div>
          <div class="field">
            <label>Lab ID <span class="req">*</span></label>
            <div class="labid-grid">
              <div class="labid-cell">
                <span class="labid-sublabel">Type <span class="req">*</span></span>
                <select id="reg_labid_type" class="labid-type-sel" onchange="updateLabIdPreview()">
                  <option value="A">A ‚Äî Adult</option>
                  <option value="P">P ‚Äî Paediatric</option>
                </select>
              </div>
              <div class="labid-cell">
                <span class="labid-sublabel">Number <span class="req">*</span></span>
                <input type="text" id="reg_labid_num" placeholder="1000" inputmode="numeric"
                  oninput="this.value=this.value.replace(/[^0-9]/g,''); updateLabIdPreview();" maxlength="6">
              </div>
              <div class="labid-cell">
                <span class="labid-sublabel">Year <span class="req">*</span></span>
                <input type="text" id="reg_labid_year" placeholder="2026" inputmode="numeric"
                  oninput="this.value=this.value.replace(/[^0-9]/g,'').slice(0,4); updateLabIdPreview();" maxlength="4"
                  value="2026">
              </div>
            </div>
            <div id="labid_preview" class="labid-preview"></div>
            <input type="hidden" id="reg_labid">
          </div>
          <div class="field">
            <label>Date Received <span class="req">*</span></label>
            <input type="date" id="reg_date">
          </div>
        </div>
      </div>

      <!-- Demographics -->
      <div class="form-section">
        <div class="section-label">Patient Demographics</div>
        <div class="form-grid cols-3">
          <div class="field span-2">
            <label>Patient Name <span class="req">*</span></label>
            <input type="text" id="reg_name" placeholder="Full name">
          </div>
          <div class="field">
            <label>Age (years)</label>
            <input type="number" id="reg_age" min="0" max="120" placeholder="e.g. 45">
          </div>
        </div>
        <div style="margin-top: 16px;">
          <label style="display:block;margin-bottom:8px;">Sex</label>
          <div class="radio-group">
            <label class="radio-opt"><input type="radio" name="reg_sex" value="Male"> üë® Male</label>
            <label class="radio-opt"><input type="radio" name="reg_sex" value="Female"> üë© Female</label>
            <label class="radio-opt"><input type="radio" name="reg_sex" value="Other"> ‚öß Other</label>
          </div>
        </div>
      </div>

      <!-- Clinical Suspicion -->
      <div class="form-section">
        <div class="section-label">Clinical Suspicion / Disease</div>
        <p style="font-size:13px;color:var(--slate);margin-bottom:14px;">Select all that apply:</p>
        <div class="tag-cloud" id="suspicionTags">
          <div class="tag" data-val="Acute Leukemia" onclick="toggleTag(this)">Acute Leukemia</div>
          <div class="tag" data-val="ALL" onclick="toggleTag(this)">ALL</div>
          <div class="tag" data-val="AML" onclick="toggleTag(this)">AML</div>
          <div class="tag" data-val="CML" onclick="toggleTag(this)">CML</div>
          <div class="tag" data-val="MPN" onclick="toggleTag(this)">MPN</div>
          <div class="tag" data-val="MDS" onclick="toggleTag(this)">MDS</div>
          <div class="tag" data-val="MDS/MPN" onclick="toggleTag(this)">MDS/MPN</div>
          <div class="tag" data-val="CLL" onclick="toggleTag(this)">CLL</div>
          <div class="tag" data-val="LPL" onclick="toggleTag(this)">LPL</div>
          <div class="tag" data-val="SMZL" onclick="toggleTag(this)">SMZL</div>
          <div class="tag" data-val="Low Grade CLPD" onclick="toggleTag(this)">Low Grade CLPD</div>
          <div class="tag" data-val="LGL" onclick="toggleTag(this)">LGL</div>
          <div class="tag" data-val="High Grade Lymphoma" onclick="toggleTag(this)">High Grade Lymphoma</div>
          <div class="tag" data-val="Burkitt" onclick="toggleTag(this)">Burkitt</div>
          <div class="tag" data-val="HES" onclick="toggleTag(this)">HES</div>
          <div class="tag" data-val="Aplastic Anemia" onclick="toggleTag(this)">Aplastic Anemia</div>
          <div class="tag" data-val="PUO" onclick="toggleTag(this)">PUO</div>
          <div class="tag" data-val="B-ALL on therapy" onclick="toggleTag(this)" style="border-color:#7a3a00;color:#7a3a00;">B-ALL on therapy</div>
          <div class="tag" data-val="T-ALL on therapy" onclick="toggleTag(this)" style="border-color:#7a3a00;color:#7a3a00;">T-ALL on therapy</div>
          <div class="tag" data-val="AML on therapy" onclick="toggleTag(this)" style="border-color:#7a3a00;color:#7a3a00;">AML on therapy</div>
          <div class="tag" data-val="CML on therapy" onclick="toggleTag(this)" style="border-color:#7a3a00;color:#7a3a00;">CML on therapy</div>
          <div class="tag" data-val="MDS on therapy" onclick="toggleTag(this)" style="border-color:#7a3a00;color:#7a3a00;">MDS on therapy</div>
          <div class="tag" data-val="CLL on therapy" onclick="toggleTag(this)" style="border-color:#7a3a00;color:#7a3a00;">CLL on therapy</div>
          <div class="tag" data-val="Lymphoma on therapy" onclick="toggleTag(this)" style="border-color:#7a3a00;color:#7a3a00;">Lymphoma on therapy</div>
          <div class="tag" data-val="Other" onclick="toggleTagOther(this)">Others‚Ä¶</div>
        </div>
        <input type="text" id="otherSuspicionInput" placeholder="Specify other diagnosis‚Ä¶" style="margin-top:10px;display:none;width:300px;">
      </div>

      <!-- Reporting Faculty + Sample -->
      <div class="form-section">
        <div class="section-label">Reporting &amp; Sample Details</div>
        <div class="form-grid">
          <div class="field">
            <label>Reporting Faculty <span class="req">*</span></label>
            <select id="reg_faculty">
              <option value="">&#8212; Select &#8212;</option>
              <option>RD</option>
              <option>JA</option>
              <option>MUSS</option>
              <option>SN</option>
              <option>PS</option>
              <option>NK</option>
              <option>SRE</option>
              <option>NM</option>
              <option>PR</option>
              <option>SPS</option>
              <option>Sample collected in lab</option>
              <option>DR</option>
            </select>
          </div>
          <div class="field">
            <label>Reporting JR</label>
            <input type="text" id="reg_jr" placeholder="Junior Resident name">
          </div>
          <div class="field">
            <label>Reporting SR</label>
            <input type="text" id="reg_sr" placeholder="Senior Resident name">
          </div>
          <div class="field">
            <label>Sample Type <span class="req">*</span></label>
            <div class="radio-group" style="margin-top:2px;">
              <label class="radio-opt"><input type="radio" name="reg_sample" value="PB"> PB</label>
              <label class="radio-opt"><input type="radio" name="reg_sample" value="BM"> BM</label>
            </div>
          </div>
          <div class="field">
            <label>TLC (√ó10‚Åπ/L)</label>
            <input type="number" id="reg_tlc" step="0.01" min="0" placeholder="e.g. 12.5">
          </div>
        </div>
      </div>

      <!-- BM Quality -->
      <div class="form-section">
        <div class="section-label">BM Aspirate Quality</div>
        <p style="font-size:13px;color:var(--slate);margin-bottom:12px;">Select all that apply:</p>
        <div class="tag-cloud" id="bmQualityTags">
          <div class="tag" data-val="Not Diluted" onclick="toggleTag(this)">Not Diluted</div>
          <div class="tag" data-val="Diluted" onclick="toggleTag(this)">Diluted</div>
          <div class="tag" data-val="Left Imprint Better" onclick="toggleTag(this)">Left Imprint Better</div>
          <div class="tag" data-val="Right Imprint Better" onclick="toggleTag(this)">Right Imprint Better</div>
          <div class="tag" data-val="Not Applicable" onclick="toggleTag(this)" style="background:#2a2a2a;border-color:#555;color:#aaa;">Not Applicable</div>
        </div>
      </div>

      <!-- Morphology Counts -->
      <div class="form-section">
        <div class="section-label">Morphology Data</div>
        <div class="form-grid cols-3">
          <div class="field">
            <label>Blasts / Atypical Cells in Aspirate (%)</label>
            <input type="number" id="reg_blasts" min="0" max="100" placeholder="Number only, e.g. 45">
          </div>
          <div class="field">
            <label>Eosinophils in Peripheral Blood (%)</label>
            <input type="number" id="reg_eos" min="0" max="100" placeholder="Number only, e.g. 8">
          </div>
          <div class="field">
            <label>Plasma Cells (%) <span style="font-weight:400;font-size:11px;color:var(--slate)">(if needed)</span></label>
            <input type="number" id="reg_plasma" min="0" max="100" placeholder="Number only, e.g. 20">
          </div>
        </div>
        <div class="form-grid cols-2" style="margin-top:14px;">
          <div class="field">
            <label>Abnormal Cells ‚Äî Right Imprint <span style="font-weight:400;font-size:11px;color:var(--slate)">(if needed)</span></label>
            <div style="display:flex;gap:8px;align-items:center;">
              <input type="text" id="reg_right_imprint" placeholder="e.g. 40% blasts" style="flex:1;">
              <button type="button" onclick="document.getElementById('reg_right_imprint').value='Not Applicable'" style="background:#2a2a2a;border:1.5px solid #555;color:#aaa;border-radius:8px;padding:8px 10px;font-size:11px;font-family:var(--mono);cursor:pointer;white-space:nowrap;flex-shrink:0;">N/A</button>
            </div>
          </div>
          <div class="field">
            <label>Abnormal Cells ‚Äî Left Imprint <span style="font-weight:400;font-size:11px;color:var(--slate)">(if needed)</span></label>
            <div style="display:flex;gap:8px;align-items:center;">
              <input type="text" id="reg_left_imprint" placeholder="e.g. 38% blasts" style="flex:1;">
              <button type="button" onclick="document.getElementById('reg_left_imprint').value='Not Applicable'" style="background:#2a2a2a;border:1.5px solid #555;color:#aaa;border-radius:8px;padding:8px 10px;font-size:11px;font-family:var(--mono);cursor:pointer;white-space:nowrap;flex-shrink:0;">N/A</button>
            </div>
          </div>
        </div>
      </div>

      <div class="submit-wrap" style="display:flex;gap:10px;flex-wrap:wrap;">
        <button class="submit-btn" onclick="registerPatient()">
          üíæ Save Patient Registration
        </button>
        <button id="reg-clear-btn" onclick="showReadyBanner('screen-register');window.scrollTo(0,0);"
          style="background:#1a6a3a;color:white;border:none;border-radius:12px;padding:14px 20px;font-family:var(--mono);font-size:13px;font-weight:700;cursor:pointer;white-space:nowrap;">
          üßπ Clear &amp; Next Patient
        </button>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODULE 2: BM MORPHOLOGY ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div id="screen-morph" class="panel">
    <div class="panel-header">
      <button class="back-btn" onclick="showScreen('screen-home')">‚Üê Back</button>
      <h2>BM Morphology</h2>
      <span class="step-badge">Module 02</span>
    </div>
    <div class="panel-body">

      <div class="workflow-block" id="morph_wfblock"></div>
      <div class="cr-lookup">
        <div class="field">
          <label>CR Number</label>
          <input type="text" id="morph_cr" placeholder="e.g. 202600012345"
            inputmode="numeric" maxlength="12"
            onkeydown="if(event.key==='Enter')loadForMorph()">
        </div>
        <button class="lookup-btn" onclick="loadForMorph()">üîç Load</button>
      </div>

      <div id="morph_wrap" class="hidden">
        <div class="patient-card" id="morph_pc"></div>

        <div class="order-block" style="margin-top:16px;">
          <div class="order-block-title">Bone Marrow Morphology Report <span class="req">*</span></div>
          <p style="font-size:11px;color:var(--slate);margin-bottom:10px;">Enter complete morphology findings, diagnosis, and recommendations.</p>
          <textarea id="morph_report"
            style="width:100%;min-height:220px;padding:14px;border:1.5px solid var(--border);border-radius:10px;font-size:14px;font-family:inherit;line-height:1.7;resize:vertical;background:white;color:var(--dark);outline:none;"
            placeholder="e.g. Hypercellular marrow with 80% blasts showing myeloid differentiation. Auer rods present. Erythropoiesis markedly suppressed. Megakaryocytes reduced. Trephine biopsy shows diffuse infiltration..."></textarea>
        </div>

        <button class="mob-save-btn" onclick="saveMorph()" style="margin-top:14px;">üíæ Save Morphology Report</button>
      </div>

    </div>
  </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODULE 03: ORDER TESTS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div id="screen-order" class="panel">
    <div class="panel-header">
      <button class="back-btn" onclick="showScreen('screen-home')">‚Üê Back</button>
      <h2>Order Ancillary Tests</h2>
      <span class="step-badge">Module 03</span>
    </div>
    <div class="panel-body">
      <div class="sub-tabs">
        <button class="sub-tab active" onclick="switchSubTab('order','fish',this)">FISH</button>
        <button class="sub-tab" onclick="switchSubTab('order','fcm',this)">FCM</button>
        <button class="sub-tab" onclick="switchSubTab('order','rtpcr',this)">RT-PCR</button>
        <button class="sub-tab" onclick="switchSubTab('order','ngsh12',this)">NGS-H12</button>
        <button class="sub-tab" onclick="switchSubTab('order','ngsh9',this)">NGS-H9</button>
        <button class="sub-tab" onclick="switchSubTab('order','tcr',this)">TCR</button>
      </div>

      <!-- ‚îÄ‚îÄ FISH ‚îÄ‚îÄ -->
      <div class="sub-panel active" id="order-fish">
        <div class="workflow-block" id="order_fish_wfblock"></div>
        <div class="cr-lookup">
          <div class="field"><label>CR Number</label>
            <input type="text" id="fish_cr" placeholder="CR-2024-0001" onkeydown="if(event.key==='Enter')loadForOrder('fish')">
          </div>
          <button class="lookup-btn" onclick="loadForOrder('fish')">üîç Load</button>
        </div>
        <div id="fish_card_wrap" class="hidden">
          <div class="patient-card" id="fish_pc"></div>

          <!-- A: Payment Status -->
          <div class="order-block">
            <div class="order-block-title">A ¬∑ Payment Status <span class="req">*</span></div>
            <div class="mobile-tag-grid" id="fish-payment">
              <div class="mtag pay-tag pay-yes" onclick="togglePayment('fish','paid',this)">‚úÖ Paid</div>
              <div class="mtag pay-tag pay-yes" onclick="togglePayment('fish','paid',this)">Ayushman</div>
              <div class="mtag pay-tag pay-yes" onclick="togglePayment('fish','paid',this)">Poor Free</div>
              <div class="mtag pay-tag pay-yes" onclick="togglePayment('fish','paid',this)">JSSK</div>
              <div class="mtag pay-tag pay-yes" onclick="togglePayment('fish','paid',this)">HIMCARE</div>
              <div class="mtag pay-tag pay-no"  onclick="togglePayment('fish','notpaid',this)">‚ùå Not Paid</div>
            </div>
            <div id="fish_pay_status" class="pay-status-bar hidden"></div>
          </div>

          <!-- B: Panel Selection -->
          <div class="order-block">
            <div class="order-block-title">B ¬∑ FISH Panel <span class="req">*</span></div>
            <div class="mobile-tag-grid" id="fish-panels">
              <div class="mtag panel-tag" onclick="toggleFishPanel(this)" data-val="ALL">ALL</div>
              <div class="mtag panel-tag" onclick="toggleFishPanel(this)" data-val="MDS">MDS</div>
              <div class="mtag panel-tag" onclick="toggleFishPanel(this)" data-val="MDS-Extended">MDS-Extended</div>
              <div class="mtag panel-tag" onclick="toggleFishPanel(this)" data-val="Acute Leuk-NOS">Acute Leuk-NOS</div>
              <div class="mtag panel-tag" onclick="toggleFishPanel(this)" data-val="CML/MPN">CML / MPN</div>
              <div class="mtag panel-tag" onclick="toggleFishPanel(this)" data-val="JMML">JMML</div>
              <div class="mtag panel-tag" onclick="toggleFishPanel(this)" data-val="CLL">CLL</div>
              <div class="mtag panel-tag" onclick="toggleFishPanel(this)" data-val="CLL+CCND1">CLL + CCND1</div>
              <div class="mtag panel-tag" onclick="toggleFishPanel(this)" data-val="Lymphoma-not CLL">Lymphoma (not CLL)</div>
              <div class="mtag panel-tag" onclick="toggleFishPanel(this)" data-val="HES">HES</div>
              <div class="mtag panel-tag" onclick="toggleFishPanel(this)" data-val="T-PLL">T-PLL</div>
              <div class="mtag panel-tag" onclick="toggleFishPanel(this)" data-val="MM">MM</div>
              <div class="mtag panel-tag other-trigger" onclick="toggleFishOther(this)" data-val="Other">Other‚Ä¶</div>
            </div>
            <div id="fish_other_wrap" class="other-input-wrap hidden">
              <input type="text" id="fish_other_text" class="other-input" placeholder="Specify other panel‚Ä¶">
            </div>
          </div>

          <!-- Selected summary -->
          <div id="fish_summary" class="order-summary hidden"></div>

          <textarea class="mob-notes" id="fish_notes" placeholder="Special instructions or remarks‚Ä¶"></textarea>
          <button class="mob-save-btn" onclick="saveOrder('fish')">üíæ Save FISH Order</button>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ FCM ‚îÄ‚îÄ -->
      <div class="sub-panel" id="order-fcm">
        <div class="workflow-block" id="order_fcm_wfblock"></div>
        <div class="cr-lookup">
          <div class="field"><label>CR Number</label>
            <input type="text" id="fcm_cr" placeholder="CR-2024-0001" onkeydown="if(event.key==='Enter')loadForOrder('fcm')">
          </div>
          <button class="lookup-btn" onclick="loadForOrder('fcm')">üîç Load</button>
        </div>
        <div id="fcm_card_wrap" class="hidden">
          <div class="patient-card" id="fcm_pc"></div>

          <!-- A: Payment Status -->
          <div class="order-block">
            <div class="order-block-title">A ¬∑ Payment Status <span class="req">*</span></div>
            <div class="mobile-tag-grid" id="fcm-payment">
              <div class="mtag pay-tag pay-yes" onclick="togglePayment('fcm','paid',this)">‚úÖ Paid</div>
              <div class="mtag pay-tag pay-yes" onclick="togglePayment('fcm','paid',this)">Ayushman</div>
              <div class="mtag pay-tag pay-yes" onclick="togglePayment('fcm','paid',this)">Poor Free</div>
              <div class="mtag pay-tag pay-yes" onclick="togglePayment('fcm','paid',this)">JSSK</div>
              <div class="mtag pay-tag pay-yes" onclick="togglePayment('fcm','paid',this)">HIMCARE</div>
              <div class="mtag pay-tag pay-no"  onclick="togglePayment('fcm','notpaid',this)">‚ùå Not Paid</div>
            </div>
            <div id="fcm_pay_status" class="pay-status-bar hidden"></div>
          </div>

          <!-- B: Panel Selection -->
          <div class="order-block">
            <div class="order-block-title">B ¬∑ FCM Panel <span class="req">*</span></div>
            <div class="mobile-tag-grid" id="fcm-panels">
              <div class="mtag panel-tag" onclick="toggleLabPanel('fcm',this)" data-val="Acute Leuk">Acute Leuk</div>
              <div class="mtag panel-tag" onclick="toggleLabPanel('fcm',this)" data-val="CLPD">CLPD</div>
              <div class="mtag panel-tag" onclick="toggleLabPanel('fcm',this)" data-val="MM-Diagnosis">MM-Diagnosis</div>
              <div class="mtag panel-tag" onclick="toggleLabPanel('fcm',this)" data-val="MM-MRD">MM-MRD</div>
              <div class="mtag panel-tag" onclick="toggleLabPanel('fcm',this)" data-val="B-ALL-MRD">B-ALL-MRD</div>
              <div class="mtag panel-tag" onclick="toggleLabPanel('fcm',this)" data-val="T-ALL-MRD">T-ALL-MRD</div>
              <div class="mtag panel-tag" onclick="toggleLabPanel('fcm',this)" data-val="MDS">MDS</div>
              <div class="mtag panel-tag" onclick="toggleLabPanel('fcm',this)" data-val="B &amp; T Tubes Acute Leuk">B &amp; T Tubes ‚Äî Acute Leuk</div>
              <div class="mtag panel-tag" onclick="toggleLabPanel('fcm',this)" data-val="CLPD-MRD">CLPD-MRD</div>
              <div class="mtag panel-tag" onclick="toggleLabPanel('fcm',this)" data-val="Mast Cell Tube">Mast Cell Tube</div>
              <div class="mtag panel-tag" onclick="toggleLabPanel('fcm',this)" data-val="Neuroblastoma">Neuroblastoma</div>
              <div class="mtag panel-tag other-trigger" onclick="toggleLabOther('fcm',this)" data-val="Other">Others‚Ä¶</div>
            </div>
            <div id="fcm_other_wrap" class="other-input-wrap hidden">
              <input type="text" id="fcm_other_text" class="other-input" placeholder="Specify other panel‚Ä¶">
            </div>
          </div>

          <!-- Live summary -->
          <div id="fcm_summary" class="order-summary hidden"></div>

          <textarea class="mob-notes" id="fcm_notes" placeholder="Special instructions or remarks‚Ä¶"></textarea>
          <button class="mob-save-btn" onclick="saveOrder('fcm')">üíæ Save FCM Order</button>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ RT-PCR ‚îÄ‚îÄ -->
      <div class="sub-panel" id="order-rtpcr">
        <div class="workflow-block" id="order_rtpcr_wfblock"></div>
        <div class="cr-lookup">
          <div class="field"><label>CR Number</label>
            <input type="text" id="rtpcr_cr" placeholder="CR-2024-0001" onkeydown="if(event.key==='Enter')loadForOrder('rtpcr')">
          </div>
          <button class="lookup-btn" onclick="loadForOrder('rtpcr')">üîç Load</button>
        </div>
        <div id="rtpcr_card_wrap" class="hidden">
          <div class="patient-card" id="rtpcr_pc"></div>

          <!-- A: Payment Status -->
          <div class="order-block">
            <div class="order-block-title">A ¬∑ Payment Status <span class="req">*</span></div>
            <div class="mobile-tag-grid" id="rtpcr-payment">
              <div class="mtag pay-tag pay-yes" onclick="togglePayment('rtpcr','paid',this)">‚úÖ Paid</div>
              <div class="mtag pay-tag pay-yes" onclick="togglePayment('rtpcr','paid',this)">Ayushman</div>
              <div class="mtag pay-tag pay-yes" onclick="togglePayment('rtpcr','paid',this)">Poor Free</div>
              <div class="mtag pay-tag pay-yes" onclick="togglePayment('rtpcr','paid',this)">JSSK</div>
              <div class="mtag pay-tag pay-yes" onclick="togglePayment('rtpcr','paid',this)">HIMCARE</div>
              <div class="mtag pay-tag pay-no"  onclick="togglePayment('rtpcr','notpaid',this)">‚ùå Not Paid</div>
            </div>
            <div id="rtpcr_pay_status" class="pay-status-bar hidden"></div>
          </div>

          <!-- B: Panel Selection -->
          <div class="order-block">
            <div class="order-block-title">B ¬∑ RT-PCR Panel <span class="req">*</span></div>
            <div class="mobile-tag-grid" id="rtpcr-panels">
              <div class="mtag panel-tag" onclick="toggleLabPanel('rtpcr',this)" data-val="Acute Leukemia Panel">Acute Leukemia Panel</div>
              <div class="mtag panel-tag" onclick="toggleLabPanel('rtpcr',this)" data-val="BCR-ABL1">BCR-ABL1</div>
              <div class="mtag panel-tag" onclick="toggleLabPanel('rtpcr',this)" data-val="JAK2">JAK2</div>
              <div class="mtag panel-tag" onclick="toggleLabPanel('rtpcr',this)" data-val="CML/MPN Panel">CML / MPN Panel</div>
              <div class="mtag panel-tag" onclick="toggleLabPanel('rtpcr',this)" data-val="MYD88">MYD88</div>
              <div class="mtag panel-tag" onclick="toggleLabPanel('rtpcr',this)" data-val="BRAF">BRAF</div>
              <div class="mtag panel-tag" onclick="toggleLabPanel('rtpcr',this)" data-val="ddPCR-MRD">ddPCR based MRD</div>
              <div class="mtag panel-tag" onclick="toggleLabPanel('rtpcr',this)" data-val="qPCR-MRD">qPCR-MRD</div>
              <div class="mtag panel-tag other-trigger" onclick="toggleLabOther('rtpcr',this)" data-val="Other">Others‚Ä¶</div>
            </div>
            <div id="rtpcr_other_wrap" class="other-input-wrap hidden">
              <input type="text" id="rtpcr_other_text" class="other-input" placeholder="Specify other test‚Ä¶">
            </div>
          </div>

          <!-- Live summary -->
          <div id="rtpcr_summary" class="order-summary hidden"></div>

          <textarea class="mob-notes" id="rtpcr_notes" placeholder="Special instructions or remarks‚Ä¶"></textarea>
          <button class="mob-save-btn" onclick="saveOrder('rtpcr')">üíæ Save RT-PCR Order</button>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ NGS-H12 ‚îÄ‚îÄ -->
      <div class="sub-panel" id="order-ngsh12">
        <div class="workflow-block" id="order_ngsh12_wfblock"></div>
        <div class="cr-lookup">
          <div class="field"><label>CR Number</label>
            <input type="text" id="ngsh12_cr" placeholder="CR-2024-0001" onkeydown="if(event.key==='Enter')loadForOrder('ngsh12')">
          </div>
          <button class="lookup-btn" onclick="loadForOrder('ngsh12')">üîç Load</button>
        </div>
        <div id="ngsh12_card_wrap" class="hidden">
          <div class="patient-card" id="ngsh12_pc"></div>

          <!-- A: Payment Status -->
          <div class="order-block">
            <div class="order-block-title">A ¬∑ Payment Status <span class="req">*</span></div>
            <div class="mobile-tag-grid" id="ngsh12-payment">
              <div class="mtag pay-tag pay-yes" onclick="togglePayment('ngsh12','paid',this)">‚úÖ Paid</div>
              <div class="mtag pay-tag pay-yes" onclick="togglePayment('ngsh12','paid',this)">Ayushman</div>
              <div class="mtag pay-tag pay-yes" onclick="togglePayment('ngsh12','paid',this)">Poor Free</div>
              <div class="mtag pay-tag pay-yes" onclick="togglePayment('ngsh12','paid',this)">JSSK</div>
              <div class="mtag pay-tag pay-yes" onclick="togglePayment('ngsh12','paid',this)">HIMCARE</div>
              <div class="mtag pay-tag pay-no"  onclick="togglePayment('ngsh12','notpaid',this)">‚ùå Not Paid</div>
            </div>
            <div id="ngsh12_pay_status" class="pay-status-bar hidden"></div>
          </div>

          <!-- B: Panel -->
          <div class="order-block">
            <div class="order-block-title">B ¬∑ NGS-H12 Panel <span class="req">*</span></div>
            <div class="mobile-tag-grid" id="ngsh12-panels">
              <div class="mtag panel-tag" onclick="toggleLabPanel('ngsh12',this)" data-val="Myeloid Mutation Panel">Myeloid Mutation Panel</div>
              <div class="mtag panel-tag" onclick="toggleLabPanel('ngsh12',this)" data-val="Lymphoid Mutation Panel">Lymphoid Mutation Panel</div>
              <div class="mtag panel-tag" onclick="toggleLabPanel('ngsh12',this)" data-val="TP53 Only">TP53 Only</div>
              <div class="mtag panel-tag other-trigger" onclick="toggleLabOther('ngsh12',this)" data-val="Other">Others‚Ä¶</div>
            </div>
            <div id="ngsh12_other_wrap" class="other-input-wrap hidden">
              <input type="text" id="ngsh12_other_text" class="other-input" placeholder="Specify other panel‚Ä¶">
            </div>
          </div>

          <div id="ngsh12_summary" class="order-summary hidden"></div>
          <textarea class="mob-notes" id="ngsh12_notes" placeholder="Special instructions or remarks‚Ä¶"></textarea>
          <button class="mob-save-btn" onclick="saveOrder('ngsh12')">üíæ Save NGS-H12 Order</button>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ NGS-H9 ‚îÄ‚îÄ -->
      <div class="sub-panel" id="order-ngsh9">
        <div class="workflow-block" id="order_ngsh9_wfblock"></div>
        <div class="cr-lookup">
          <div class="field"><label>CR Number</label>
            <input type="text" id="ngsh9_cr" placeholder="CR-2024-0001" onkeydown="if(event.key==='Enter')loadForOrder('ngsh9')">
          </div>
          <button class="lookup-btn" onclick="loadForOrder('ngsh9')">üîç Load</button>
        </div>
        <div id="ngsh9_card_wrap" class="hidden">
          <div class="patient-card" id="ngsh9_pc"></div>

          <!-- A: Payment Status -->
          <div class="order-block">
            <div class="order-block-title">A ¬∑ Payment Status <span class="req">*</span></div>
            <div class="mobile-tag-grid" id="ngsh9-payment">
              <div class="mtag pay-tag pay-yes" onclick="togglePayment('ngsh9','paid',this)">‚úÖ Paid</div>
              <div class="mtag pay-tag pay-yes" onclick="togglePayment('ngsh9','paid',this)">Ayushman</div>
              <div class="mtag pay-tag pay-yes" onclick="togglePayment('ngsh9','paid',this)">Poor Free</div>
              <div class="mtag pay-tag pay-yes" onclick="togglePayment('ngsh9','paid',this)">JSSK</div>
              <div class="mtag pay-tag pay-yes" onclick="togglePayment('ngsh9','paid',this)">HIMCARE</div>
              <div class="mtag pay-tag pay-no"  onclick="togglePayment('ngsh9','notpaid',this)">‚ùå Not Paid</div>
            </div>
            <div id="ngsh9_pay_status" class="pay-status-bar hidden"></div>
          </div>

          <!-- B: Panel -->
          <div class="order-block">
            <div class="order-block-title">B ¬∑ NGS-H9 Panel <span class="req">*</span></div>
            <div class="mobile-tag-grid" id="ngsh9-panels">
              <div class="mtag panel-tag" onclick="toggleLabPanel('ngsh9',this)" data-val="RNA Fusion Panel">RNA Fusion Panel</div>
              <div class="mtag panel-tag" onclick="toggleLabPanel('ngsh9',this)" data-val="IBMFS Panel">IBMFS Panel</div>
              <div class="mtag panel-tag" onclick="toggleLabPanel('ngsh9',this)" data-val="WES with CNV">WES with CNV</div>
              <div class="mtag panel-tag" onclick="toggleLabPanel('ngsh9',this)" data-val="TCR by NGS">TCR by NGS</div>
              <div class="mtag panel-tag" onclick="toggleLabPanel('ngsh9',this)" data-val="T-ALL Somatic">T-ALL Somatic</div>
              <div class="mtag panel-tag other-trigger" onclick="toggleLabOther('ngsh9',this)" data-val="Other">Others‚Ä¶</div>
            </div>
            <div id="ngsh9_other_wrap" class="other-input-wrap hidden">
              <input type="text" id="ngsh9_other_text" class="other-input" placeholder="Specify other panel‚Ä¶">
            </div>
          </div>

          <div id="ngsh9_summary" class="order-summary hidden"></div>
          <textarea class="mob-notes" id="ngsh9_notes" placeholder="Special instructions or remarks‚Ä¶"></textarea>
          <button class="mob-save-btn" onclick="saveOrder('ngsh9')">üíæ Save NGS-H9 Order</button>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ TCR Clonality ‚îÄ‚îÄ -->
      <div class="sub-panel" id="order-tcr">
        <div class="workflow-block" id="order_tcr_wfblock"></div>
        <div class="cr-lookup">
          <div class="field"><label>CR Number</label>
            <input type="text" id="tcr_cr" placeholder="CR-2024-0001" onkeydown="if(event.key==='Enter')loadForOrder('tcr')">
          </div>
          <button class="lookup-btn" onclick="loadForOrder('tcr')">üîç Load</button>
        </div>
        <div id="tcr_card_wrap" class="hidden">
          <div class="patient-card" id="tcr_pc"></div>

          <!-- A: Payment Status -->
          <div class="order-block">
            <div class="order-block-title">A ¬∑ Payment Status <span class="req">*</span></div>
            <div class="mobile-tag-grid" id="tcr-payment">
              <div class="mtag pay-tag pay-yes" onclick="togglePayment('tcr','paid',this)">‚úÖ Paid</div>
              <div class="mtag pay-tag pay-yes" onclick="togglePayment('tcr','paid',this)">Ayushman</div>
              <div class="mtag pay-tag pay-yes" onclick="togglePayment('tcr','paid',this)">Poor Free</div>
              <div class="mtag pay-tag pay-yes" onclick="togglePayment('tcr','paid',this)">JSSK</div>
              <div class="mtag pay-tag pay-yes" onclick="togglePayment('tcr','paid',this)">HIMCARE</div>
              <div class="mtag pay-tag pay-no"  onclick="togglePayment('tcr','notpaid',this)">‚ùå Not Paid</div>
            </div>
            <div id="tcr_pay_status" class="pay-status-bar hidden"></div>
          </div>

          <!-- B: Panel -->
          <div class="order-block">
            <div class="order-block-title">B ¬∑ TCR Panel <span class="req">*</span></div>
            <div class="mobile-tag-grid" id="tcr-panels">
              <div class="mtag panel-tag" onclick="toggleLabPanel('tcr',this)" data-val="TCR Beta">TCR Beta (Œ≤)</div>
              <div class="mtag panel-tag" onclick="toggleLabPanel('tcr',this)" data-val="TCR Gamma">TCR Gamma (Œ≥)</div>
              <div class="mtag panel-tag other-trigger" onclick="toggleLabOther('tcr',this)" data-val="Other">Others‚Ä¶</div>
            </div>
            <div id="tcr_other_wrap" class="other-input-wrap hidden">
              <input type="text" id="tcr_other_text" class="other-input" placeholder="Specify other‚Ä¶">
            </div>
          </div>

          <div id="tcr_summary" class="order-summary hidden"></div>
          <textarea class="mob-notes" id="tcr_notes" placeholder="Special instructions or remarks‚Ä¶"></textarea>
          <button class="mob-save-btn" onclick="saveOrder('tcr')">üíæ Save TCR Order</button>
        </div>
      </div>

    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODULE 3: TEST ACCEPTANCE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div id="screen-results" class="panel">
    <div class="panel-header">
      <button class="back-btn" onclick="showScreen('screen-home')">‚Üê Back</button>
      <h2>Test Acceptance</h2>
      <span class="step-badge">Module 04</span>
    </div>
    <div class="panel-body">
      <div class="sub-tabs">
        <button id="tab-btn-accept-fish" class="sub-tab active" onclick="switchSubTab('accept','fish',this)">FISH</button>
        <button id="tab-btn-accept-fcm" class="sub-tab" onclick="switchSubTab('accept','fcm',this)">FCM</button>
        <button id="tab-btn-accept-rtpcr" class="sub-tab" onclick="switchSubTab('accept','rtpcr',this)">RT-PCR</button>
        <button id="tab-btn-accept-ngsh12" class="sub-tab" onclick="switchSubTab('accept','ngsh12',this)">NGS-H12</button>
        <button id="tab-btn-accept-ngsh9" class="sub-tab" onclick="switchSubTab('accept','ngsh9',this)">NGS-H9</button>
        <button id="tab-btn-accept-tcr" class="sub-tab" onclick="switchSubTab('accept','tcr',this)">TCR</button>
      </div>

      <div class="sub-panel active" id="accept-fish">
        <div class="workflow-block" id="accept_fish_wfblock"></div>
        <div class="cr-lookup">
          <div class="field"><label>CR Number</label>
            <input type="text" id="afish_cr" placeholder="CR-2024-0001" onkeydown="if(event.key==='Enter')loadForAcceptance('fish')">
          </div>
          <button class="lookup-btn" onclick="loadForAcceptance('fish')">üîç Load</button>
        </div>
        <div id="afish_wrap" class="hidden">
          <div class="patient-card" id="afish_pc"></div>
          <div class="ordered-summary" id="afish_ordered"></div>
          <div class="order-block" style="margin-top:14px;">
            <div class="order-block-title">Unique Lab ID <span class="req">*</span> <span style="font-size:10px;font-weight:400;color:var(--slate);">Assigned by FISH lab</span></div>
            <input type="text" id="afish_unique_id" placeholder="e.g. FISH-2026-001" style="margin-bottom:4px;"
              oninput="checkUniqueLabId('fish',this)">
            <div id="afish_uid_status" style="font-size:11px;min-height:16px;margin-bottom:8px;font-family:var(--mono);"></div>
          </div>

<div class="order-block" style="margin-top:14px;">
            <div class="order-block-title">A ¬∑ Test Status per Panel</div>
            <div style="display:flex;gap:12px;font-size:11px;font-family:var(--mono);margin-bottom:14px;flex-wrap:wrap;">
              <span style="color:#1a6a3a;font-weight:700;">‚ñ† OK</span> ‚Äî Test proceeding, payment OK &nbsp;
              <span style="color:#b8860b;font-weight:700;">‚ñ† PP</span> ‚Äî Payment Pending &nbsp;
              <span style="color:var(--crimson);font-weight:700;">‚ñ† HP</span> ‚Äî Hold for Payment
            </div>
            <div id="afish_panels">
            <div class="panel-result-block" id="afish_all_block">
              <div class="prb-title">ALL</div>
              <div class="mobile-tag-grid" style="grid-template-columns:1fr 1fr 1fr;gap:6px;">
                <div class="mtag ok-tag"  onclick="toggleStatus('afish','all','OK',this)">OK</div>
                <div class="mtag pp-tag"  onclick="toggleStatus('afish','all','PP',this)">PP</div>
                <div class="mtag hp-tag"  onclick="toggleStatus('afish','all','HP',this)">HP</div>
              </div>
            </div>
            <div class="panel-result-block" id="afish_mds_block">
              <div class="prb-title">MDS</div>
              <div class="mobile-tag-grid" style="grid-template-columns:1fr 1fr 1fr;gap:6px;">
                <div class="mtag ok-tag"  onclick="toggleStatus('afish','mds','OK',this)">OK</div>
                <div class="mtag pp-tag"  onclick="toggleStatus('afish','mds','PP',this)">PP</div>
                <div class="mtag hp-tag"  onclick="toggleStatus('afish','mds','HP',this)">HP</div>
              </div>
            </div>
            <div class="panel-result-block" id="afish_mds_extended_block">
              <div class="prb-title">MDS-Extended</div>
              <div class="mobile-tag-grid" style="grid-template-columns:1fr 1fr 1fr;gap:6px;">
                <div class="mtag ok-tag"  onclick="toggleStatus('afish','mds_extended','OK',this)">OK</div>
                <div class="mtag pp-tag"  onclick="toggleStatus('afish','mds_extended','PP',this)">PP</div>
                <div class="mtag hp-tag"  onclick="toggleStatus('afish','mds_extended','HP',this)">HP</div>
              </div>
            </div>
            <div class="panel-result-block" id="afish_acute_leuk_nos_block">
              <div class="prb-title">Acute Leuk-NOS</div>
              <div class="mobile-tag-grid" style="grid-template-columns:1fr 1fr 1fr;gap:6px;">
                <div class="mtag ok-tag"  onclick="toggleStatus('afish','acute_leuk_nos','OK',this)">OK</div>
                <div class="mtag pp-tag"  onclick="toggleStatus('afish','acute_leuk_nos','PP',this)">PP</div>
                <div class="mtag hp-tag"  onclick="toggleStatus('afish','acute_leuk_nos','HP',this)">HP</div>
              </div>
            </div>
            <div class="panel-result-block" id="afish_cml_mpn_block">
              <div class="prb-title">CML/MPN</div>
              <div class="mobile-tag-grid" style="grid-template-columns:1fr 1fr 1fr;gap:6px;">
                <div class="mtag ok-tag"  onclick="toggleStatus('afish','cml_mpn','OK',this)">OK</div>
                <div class="mtag pp-tag"  onclick="toggleStatus('afish','cml_mpn','PP',this)">PP</div>
                <div class="mtag hp-tag"  onclick="toggleStatus('afish','cml_mpn','HP',this)">HP</div>
              </div>
            </div>
            <div class="panel-result-block" id="afish_jmml_block">
              <div class="prb-title">JMML</div>
              <div class="mobile-tag-grid" style="grid-template-columns:1fr 1fr 1fr;gap:6px;">
                <div class="mtag ok-tag"  onclick="toggleStatus('afish','jmml','OK',this)">OK</div>
                <div class="mtag pp-tag"  onclick="toggleStatus('afish','jmml','PP',this)">PP</div>
                <div class="mtag hp-tag"  onclick="toggleStatus('afish','jmml','HP',this)">HP</div>
              </div>
            </div>
            <div class="panel-result-block" id="afish_cll_block">
              <div class="prb-title">CLL</div>
              <div class="mobile-tag-grid" style="grid-template-columns:1fr 1fr 1fr;gap:6px;">
                <div class="mtag ok-tag"  onclick="toggleStatus('afish','cll','OK',this)">OK</div>
                <div class="mtag pp-tag"  onclick="toggleStatus('afish','cll','PP',this)">PP</div>
                <div class="mtag hp-tag"  onclick="toggleStatus('afish','cll','HP',this)">HP</div>
              </div>
            </div>
            <div class="panel-result-block" id="afish_cll_ccnd1_block">
              <div class="prb-title">CLL+CCND1</div>
              <div class="mobile-tag-grid" style="grid-template-columns:1fr 1fr 1fr;gap:6px;">
                <div class="mtag ok-tag"  onclick="toggleStatus('afish','cll_ccnd1','OK',this)">OK</div>
                <div class="mtag pp-tag"  onclick="toggleStatus('afish','cll_ccnd1','PP',this)">PP</div>
                <div class="mtag hp-tag"  onclick="toggleStatus('afish','cll_ccnd1','HP',this)">HP</div>
              </div>
            </div>
            <div class="panel-result-block" id="afish_lymphoma_not_cll_block">
              <div class="prb-title">Lymphoma-not CLL</div>
              <div class="mobile-tag-grid" style="grid-template-columns:1fr 1fr 1fr;gap:6px;">
                <div class="mtag ok-tag"  onclick="toggleStatus('afish','lymphoma_not_cll','OK',this)">OK</div>
                <div class="mtag pp-tag"  onclick="toggleStatus('afish','lymphoma_not_cll','PP',this)">PP</div>
                <div class="mtag hp-tag"  onclick="toggleStatus('afish','lymphoma_not_cll','HP',this)">HP</div>
              </div>
            </div>
            <div class="panel-result-block" id="afish_hes_block">
              <div class="prb-title">HES</div>
              <div class="mobile-tag-grid" style="grid-template-columns:1fr 1fr 1fr;gap:6px;">
                <div class="mtag ok-tag"  onclick="toggleStatus('afish','hes','OK',this)">OK</div>
                <div class="mtag pp-tag"  onclick="toggleStatus('afish','hes','PP',this)">PP</div>
                <div class="mtag hp-tag"  onclick="toggleStatus('afish','hes','HP',this)">HP</div>
              </div>
            </div>
            <div class="panel-result-block" id="afish_t_pll_block">
              <div class="prb-title">T-PLL</div>
              <div class="mobile-tag-grid" style="grid-template-columns:1fr 1fr 1fr;gap:6px;">
                <div class="mtag ok-tag"  onclick="toggleStatus('afish','t_pll','OK',this)">OK</div>
                <div class="mtag pp-tag"  onclick="toggleStatus('afish','t_pll','PP',this)">PP</div>
                <div class="mtag hp-tag"  onclick="toggleStatus('afish','t_pll','HP',this)">HP</div>
              </div>
            </div>
            <div class="panel-result-block" id="afish_mm_block">
              <div class="prb-title">MM</div>
              <div class="mobile-tag-grid" style="grid-template-columns:1fr 1fr 1fr;gap:6px;">
                <div class="mtag ok-tag"  onclick="toggleStatus('afish','mm','OK',this)">OK</div>
                <div class="mtag pp-tag"  onclick="toggleStatus('afish','mm','PP',this)">PP</div>
                <div class="mtag hp-tag"  onclick="toggleStatus('afish','mm','HP',this)">HP</div>
              </div>
            </div>
            <div class="panel-result-block" id="afish_other_block">
              <div class="prb-title">Other</div>
              <div class="mobile-tag-grid" style="grid-template-columns:1fr 1fr 1fr;gap:6px;">
                <div class="mtag ok-tag"  onclick="toggleStatus('afish','other','OK',this)">OK</div>
                <div class="mtag pp-tag"  onclick="toggleStatus('afish','other','PP',this)">PP</div>
                <div class="mtag hp-tag"  onclick="toggleStatus('afish','other','HP',this)">HP</div>
              </div>
            </div>
            </div>
          </div>
          <textarea class="mob-notes" id="afish_notes" placeholder="Overall remarks‚Ä¶" style="margin-top:12px;"></textarea>
          <button class="mob-save-btn" onclick="saveAcceptance('fish')">üíæ Save FISH Acceptance</button>
        </div>
      </div>
      <div class="sub-panel" id="accept-fcm">
        <div class="workflow-block" id="accept_fcm_wfblock"></div>
        <div class="cr-lookup">
          <div class="field"><label>CR Number</label>
            <input type="text" id="afcm_cr" placeholder="CR-2024-0001" onkeydown="if(event.key==='Enter')loadForAcceptance('fcm')">
          </div>
          <button class="lookup-btn" onclick="loadForAcceptance('fcm')">üîç Load</button>
        </div>
        <div id="afcm_wrap" class="hidden">
          <div class="patient-card" id="afcm_pc"></div>
          <div class="ordered-summary" id="afcm_ordered"></div>
          <div class="order-block" style="margin-top:14px;">
            <div class="order-block-title">Unique Lab ID <span class="req">*</span> <span style="font-size:10px;font-weight:400;color:var(--slate);">Assigned by FCM lab</span></div>
            <input type="text" id="afcm_unique_id" placeholder="e.g. FCM-2026-001" style="margin-bottom:4px;"
              oninput="checkUniqueLabId('fcm',this)">
            <div id="afcm_uid_status" style="font-size:11px;min-height:16px;margin-bottom:8px;font-family:var(--mono);"></div>
          </div>

          <div class="order-block" style="margin-top:14px;">
            <div class="order-block-title">A ¬∑ Test Status per Panel</div>
            <div style="display:flex;gap:12px;font-size:11px;font-family:var(--mono);margin-bottom:14px;flex-wrap:wrap;">
              <span style="color:#1a6a3a;font-weight:700;">‚ñ† OK</span> ‚Äî Test proceeding, payment OK &nbsp;
              <span style="color:#b8860b;font-weight:700;">‚ñ† PP</span> ‚Äî Payment Pending &nbsp;
              <span style="color:var(--crimson);font-weight:700;">‚ñ† HP</span> ‚Äî Hold for Payment
            </div>
            <div id="afcm_panels">
            <div class="panel-result-block" id="afcm_acute_leuk_block">
              <div class="prb-title">Acute Leuk</div>
              <div class="mobile-tag-grid" style="grid-template-columns:1fr 1fr 1fr;gap:6px;">
                <div class="mtag ok-tag"  onclick="toggleStatus('afcm','acute_leuk','OK',this)">OK</div>
                <div class="mtag pp-tag"  onclick="toggleStatus('afcm','acute_leuk','PP',this)">PP</div>
                <div class="mtag hp-tag"  onclick="toggleStatus('afcm','acute_leuk','HP',this)">HP</div>
              </div>
            </div>
            <div class="panel-result-block" id="afcm_clpd_block">
              <div class="prb-title">CLPD</div>
              <div class="mobile-tag-grid" style="grid-template-columns:1fr 1fr 1fr;gap:6px;">
                <div class="mtag ok-tag"  onclick="toggleStatus('afcm','clpd','OK',this)">OK</div>
                <div class="mtag pp-tag"  onclick="toggleStatus('afcm','clpd','PP',this)">PP</div>
                <div class="mtag hp-tag"  onclick="toggleStatus('afcm','clpd','HP',this)">HP</div>
              </div>
            </div>
            <div class="panel-result-block" id="afcm_mm_diagnosis_block">
              <div class="prb-title">MM-Diagnosis</div>
              <div class="mobile-tag-grid" style="grid-template-columns:1fr 1fr 1fr;gap:6px;">
                <div class="mtag ok-tag"  onclick="toggleStatus('afcm','mm_diagnosis','OK',this)">OK</div>
                <div class="mtag pp-tag"  onclick="toggleStatus('afcm','mm_diagnosis','PP',this)">PP</div>
                <div class="mtag hp-tag"  onclick="toggleStatus('afcm','mm_diagnosis','HP',this)">HP</div>
              </div>
            </div>
            <div class="panel-result-block" id="afcm_mm_mrd_block">
              <div class="prb-title">MM-MRD</div>
              <div class="mobile-tag-grid" style="grid-template-columns:1fr 1fr 1fr;gap:6px;">
                <div class="mtag ok-tag"  onclick="toggleStatus('afcm','mm_mrd','OK',this)">OK</div>
                <div class="mtag pp-tag"  onclick="toggleStatus('afcm','mm_mrd','PP',this)">PP</div>
                <div class="mtag hp-tag"  onclick="toggleStatus('afcm','mm_mrd','HP',this)">HP</div>
              </div>
            </div>
            <div class="panel-result-block" id="afcm_b_all_mrd_block">
              <div class="prb-title">B-ALL-MRD</div>
              <div class="mobile-tag-grid" style="grid-template-columns:1fr 1fr 1fr;gap:6px;">
                <div class="mtag ok-tag"  onclick="toggleStatus('afcm','b_all_mrd','OK',this)">OK</div>
                <div class="mtag pp-tag"  onclick="toggleStatus('afcm','b_all_mrd','PP',this)">PP</div>
                <div class="mtag hp-tag"  onclick="toggleStatus('afcm','b_all_mrd','HP',this)">HP</div>
              </div>
            </div>
            <div class="panel-result-block" id="afcm_t_all_mrd_block">
              <div class="prb-title">T-ALL-MRD</div>
              <div class="mobile-tag-grid" style="grid-template-columns:1fr 1fr 1fr;gap:6px;">
                <div class="mtag ok-tag"  onclick="toggleStatus('afcm','t_all_mrd','OK',this)">OK</div>
                <div class="mtag pp-tag"  onclick="toggleStatus('afcm','t_all_mrd','PP',this)">PP</div>
                <div class="mtag hp-tag"  onclick="toggleStatus('afcm','t_all_mrd','HP',this)">HP</div>
              </div>
            </div>
            <div class="panel-result-block" id="afcm_mds_block">
              <div class="prb-title">MDS</div>
              <div class="mobile-tag-grid" style="grid-template-columns:1fr 1fr 1fr;gap:6px;">
                <div class="mtag ok-tag"  onclick="toggleStatus('afcm','mds','OK',this)">OK</div>
                <div class="mtag pp-tag"  onclick="toggleStatus('afcm','mds','PP',this)">PP</div>
                <div class="mtag hp-tag"  onclick="toggleStatus('afcm','mds','HP',this)">HP</div>
              </div>
            </div>
            <div class="panel-result-block" id="afcm_b_t_tubes_acute_leuk_block">
              <div class="prb-title">B & T Tubes Acute Leuk</div>
              <div class="mobile-tag-grid" style="grid-template-columns:1fr 1fr 1fr;gap:6px;">
                <div class="mtag ok-tag"  onclick="toggleStatus('afcm','b_t_tubes_acute_leuk','OK',this)">OK</div>
                <div class="mtag pp-tag"  onclick="toggleStatus('afcm','b_t_tubes_acute_leuk','PP',this)">PP</div>
                <div class="mtag hp-tag"  onclick="toggleStatus('afcm','b_t_tubes_acute_leuk','HP',this)">HP</div>
              </div>
            </div>
            <div class="panel-result-block" id="afcm_clpd_mrd_block">
              <div class="prb-title">CLPD-MRD</div>
              <div class="mobile-tag-grid" style="grid-template-columns:1fr 1fr 1fr;gap:6px;">
                <div class="mtag ok-tag"  onclick="toggleStatus('afcm','clpd_mrd','OK',this)">OK</div>
                <div class="mtag pp-tag"  onclick="toggleStatus('afcm','clpd_mrd','PP',this)">PP</div>
                <div class="mtag hp-tag"  onclick="toggleStatus('afcm','clpd_mrd','HP',this)">HP</div>
              </div>
            </div>
            <div class="panel-result-block" id="afcm_mast_cell_tube_block">
              <div class="prb-title">Mast Cell Tube</div>
              <div class="mobile-tag-grid" style="grid-template-columns:1fr 1fr 1fr;gap:6px;">
                <div class="mtag ok-tag"  onclick="toggleStatus('afcm','mast_cell_tube','OK',this)">OK</div>
                <div class="mtag pp-tag"  onclick="toggleStatus('afcm','mast_cell_tube','PP',this)">PP</div>
                <div class="mtag hp-tag"  onclick="toggleStatus('afcm','mast_cell_tube','HP',this)">HP</div>
              </div>
            </div>
            <div class="panel-result-block" id="afcm_neuroblastoma_block">
              <div class="prb-title">Neuroblastoma</div>
              <div class="mobile-tag-grid" style="grid-template-columns:1fr 1fr 1fr;gap:6px;">
                <div class="mtag ok-tag"  onclick="toggleStatus('afcm','neuroblastoma','OK',this)">OK</div>
                <div class="mtag pp-tag"  onclick="toggleStatus('afcm','neuroblastoma','PP',this)">PP</div>
                <div class="mtag hp-tag"  onclick="toggleStatus('afcm','neuroblastoma','HP',this)">HP</div>
              </div>
            </div>
            <div class="panel-result-block" id="afcm_other_block">
              <div class="prb-title">Other</div>
              <div class="mobile-tag-grid" style="grid-template-columns:1fr 1fr 1fr;gap:6px;">
                <div class="mtag ok-tag"  onclick="toggleStatus('afcm','other','OK',this)">OK</div>
                <div class="mtag pp-tag"  onclick="toggleStatus('afcm','other','PP',this)">PP</div>
                <div class="mtag hp-tag"  onclick="toggleStatus('afcm','other','HP',this)">HP</div>
              </div>
            </div>
            </div>
          </div>
          <textarea class="mob-notes" id="afcm_notes" placeholder="Overall remarks‚Ä¶" style="margin-top:12px;"></textarea>
          <button class="mob-save-btn" onclick="saveAcceptance('fcm')">üíæ Save FCM Acceptance</button>
        </div>
      </div>
      <div class="sub-panel" id="accept-rtpcr">
        <div class="workflow-block" id="accept_rtpcr_wfblock"></div>
        <div class="cr-lookup">
          <div class="field"><label>CR Number</label>
            <input type="text" id="artpcr_cr" placeholder="CR-2024-0001" onkeydown="if(event.key==='Enter')loadForAcceptance('rtpcr')">
          </div>
          <button class="lookup-btn" onclick="loadForAcceptance('rtpcr')">üîç Load</button>
        </div>
        <div id="artpcr_wrap" class="hidden">
          <div class="patient-card" id="artpcr_pc"></div>
          <div class="ordered-summary" id="artpcr_ordered"></div>
          <div class="order-block" style="margin-top:14px;">
            <div class="order-block-title">Unique Lab ID <span class="req">*</span> <span style="font-size:10px;font-weight:400;color:var(--slate);">Assigned by RT-PCR lab</span></div>
            <input type="text" id="artpcr_unique_id" placeholder="e.g. RT-PCR-2026-001" style="margin-bottom:4px;"
              oninput="checkUniqueLabId('rtpcr',this)">
            <div id="artpcr_uid_status" style="font-size:11px;min-height:16px;margin-bottom:8px;font-family:var(--mono);"></div>
          </div>

<div class="order-block" style="margin-top:14px;">
            <div class="order-block-title">A ¬∑ Test Status per Panel</div>
            <div style="display:flex;gap:12px;font-size:11px;font-family:var(--mono);margin-bottom:14px;flex-wrap:wrap;">
              <span style="color:#1a6a3a;font-weight:700;">‚ñ† OK</span> ‚Äî Test proceeding, payment OK &nbsp;
              <span style="color:#b8860b;font-weight:700;">‚ñ† PP</span> ‚Äî Payment Pending &nbsp;
              <span style="color:var(--crimson);font-weight:700;">‚ñ† HP</span> ‚Äî Hold for Payment
            </div>
            <div id="artpcr_panels">
            <div class="panel-result-block" id="artpcr_acute_leukemia_panel_block">
              <div class="prb-title">Acute Leukemia Panel</div>
              <div class="mobile-tag-grid" style="grid-template-columns:1fr 1fr 1fr;gap:6px;">
                <div class="mtag ok-tag"  onclick="toggleStatus('artpcr','rt_pcr_acute_panel','OK',this)">OK</div>
                <div class="mtag pp-tag"  onclick="toggleStatus('artpcr','rt_pcr_acute_panel','PP',this)">PP</div>
                <div class="mtag hp-tag"  onclick="toggleStatus('artpcr','rt_pcr_acute_panel','HP',this)">HP</div>
              </div>
            </div>
            <div class="panel-result-block" id="artpcr_bcr_abl1_block">
              <div class="prb-title">BCR-ABL1</div>
              <div class="mobile-tag-grid" style="grid-template-columns:1fr 1fr 1fr;gap:6px;">
                <div class="mtag ok-tag"  onclick="toggleStatus('artpcr','bcr_abl1','OK',this)">OK</div>
                <div class="mtag pp-tag"  onclick="toggleStatus('artpcr','bcr_abl1','PP',this)">PP</div>
                <div class="mtag hp-tag"  onclick="toggleStatus('artpcr','bcr_abl1','HP',this)">HP</div>
              </div>
            </div>
            <div class="panel-result-block" id="artpcr_jak2_block">
              <div class="prb-title">JAK2</div>
              <div class="mobile-tag-grid" style="grid-template-columns:1fr 1fr 1fr;gap:6px;">
                <div class="mtag ok-tag"  onclick="toggleStatus('artpcr','jak2','OK',this)">OK</div>
                <div class="mtag pp-tag"  onclick="toggleStatus('artpcr','jak2','PP',this)">PP</div>
                <div class="mtag hp-tag"  onclick="toggleStatus('artpcr','jak2','HP',this)">HP</div>
              </div>
            </div>
            <div class="panel-result-block" id="artpcr_cml_mpn_panel_block">
              <div class="prb-title">CML/MPN Panel</div>
              <div class="mobile-tag-grid" style="grid-template-columns:1fr 1fr 1fr;gap:6px;">
                <div class="mtag ok-tag"  onclick="toggleStatus('artpcr','cml_mpn_panel','OK',this)">OK</div>
                <div class="mtag pp-tag"  onclick="toggleStatus('artpcr','cml_mpn_panel','PP',this)">PP</div>
                <div class="mtag hp-tag"  onclick="toggleStatus('artpcr','cml_mpn_panel','HP',this)">HP</div>
              </div>
            </div>
            <div class="panel-result-block" id="artpcr_myd88_block">
              <div class="prb-title">MYD88</div>
              <div class="mobile-tag-grid" style="grid-template-columns:1fr 1fr 1fr;gap:6px;">
                <div class="mtag ok-tag"  onclick="toggleStatus('artpcr','myd88','OK',this)">OK</div>
                <div class="mtag pp-tag"  onclick="toggleStatus('artpcr','myd88','PP',this)">PP</div>
                <div class="mtag hp-tag"  onclick="toggleStatus('artpcr','myd88','HP',this)">HP</div>
              </div>
            </div>
            <div class="panel-result-block" id="artpcr_braf_block">
              <div class="prb-title">BRAF</div>
              <div class="mobile-tag-grid" style="grid-template-columns:1fr 1fr 1fr;gap:6px;">
                <div class="mtag ok-tag"  onclick="toggleStatus('artpcr','braf','OK',this)">OK</div>
                <div class="mtag pp-tag"  onclick="toggleStatus('artpcr','braf','PP',this)">PP</div>
                <div class="mtag hp-tag"  onclick="toggleStatus('artpcr','braf','HP',this)">HP</div>
              </div>
            </div>
            <div class="panel-result-block" id="artpcr_ddpcr_mrd_block">
              <div class="prb-title">ddPCR-MRD</div>
              <div class="mobile-tag-grid" style="grid-template-columns:1fr 1fr 1fr;gap:6px;">
                <div class="mtag ok-tag"  onclick="toggleStatus('artpcr','ddpcr_mrd','OK',this)">OK</div>
                <div class="mtag pp-tag"  onclick="toggleStatus('artpcr','ddpcr_mrd','PP',this)">PP</div>
                <div class="mtag hp-tag"  onclick="toggleStatus('artpcr','ddpcr_mrd','HP',this)">HP</div>
              </div>
            </div>
            <div class="panel-result-block" id="artpcr_qpcr_mrd_block">
              <div class="prb-title">qPCR-MRD</div>
              <div class="mobile-tag-grid" style="grid-template-columns:1fr 1fr 1fr;gap:6px;">
                <div class="mtag ok-tag"  onclick="toggleStatus('artpcr','qpcr_mrd','OK',this)">OK</div>
                <div class="mtag pp-tag"  onclick="toggleStatus('artpcr','qpcr_mrd','PP',this)">PP</div>
                <div class="mtag hp-tag"  onclick="toggleStatus('artpcr','qpcr_mrd','HP',this)">HP</div>
              </div>
            </div>
            <div class="panel-result-block" id="artpcr_other_block">
              <div class="prb-title">Other</div>
              <div class="mobile-tag-grid" style="grid-template-columns:1fr 1fr 1fr;gap:6px;">
                <div class="mtag ok-tag"  onclick="toggleStatus('artpcr','other','OK',this)">OK</div>
                <div class="mtag pp-tag"  onclick="toggleStatus('artpcr','other','PP',this)">PP</div>
                <div class="mtag hp-tag"  onclick="toggleStatus('artpcr','other','HP',this)">HP</div>
              </div>
            </div>
            </div>
          </div>
          <textarea class="mob-notes" id="artpcr_notes" placeholder="Overall remarks‚Ä¶" style="margin-top:12px;"></textarea>
          <button class="mob-save-btn" onclick="saveAcceptance('rtpcr')">üíæ Save RT-PCR Acceptance</button>
        </div>
      </div>
      <div class="sub-panel" id="accept-ngsh12">
        <div class="workflow-block" id="accept_ngsh12_wfblock"></div>
        <div class="cr-lookup">
          <div class="field"><label>CR Number</label>
            <input type="text" id="angsh12_cr" placeholder="CR-2024-0001" onkeydown="if(event.key==='Enter')loadForAcceptance('ngsh12')">
          </div>
          <button class="lookup-btn" onclick="loadForAcceptance('ngsh12')">üîç Load</button>
        </div>
        <div id="angsh12_wrap" class="hidden">
          <div class="patient-card" id="angsh12_pc"></div>
          <div class="ordered-summary" id="angsh12_ordered"></div>
          <div class="order-block" style="margin-top:14px;">
            <div class="order-block-title">Unique Lab ID <span class="req">*</span> <span style="font-size:10px;font-weight:400;color:var(--slate);">Assigned by NGS-H12 lab</span></div>
            <input type="text" id="angsh12_unique_id" placeholder="e.g. NGS-H12-2026-001" style="margin-bottom:4px;"
              oninput="checkUniqueLabId('ngsh12',this)">
            <div id="angsh12_uid_status" style="font-size:11px;min-height:16px;margin-bottom:8px;font-family:var(--mono);"></div>
          </div>

          <div class="order-block" style="margin-top:14px;">
            <div class="order-block-title">A ¬∑ Test Status per Panel</div>
            <div style="display:flex;gap:12px;font-size:11px;font-family:var(--mono);margin-bottom:14px;flex-wrap:wrap;">
              <span style="color:#1a6a3a;font-weight:700;">‚ñ† OK</span> ‚Äî Test proceeding, payment OK &nbsp;
              <span style="color:#b8860b;font-weight:700;">‚ñ† PP</span> ‚Äî Payment Pending &nbsp;
              <span style="color:var(--crimson);font-weight:700;">‚ñ† HP</span> ‚Äî Hold for Payment
            </div>
            <div id="angsh12_panels">
            <div class="panel-result-block" id="angsh12_myeloid_mutation_panel_block">
              <div class="prb-title">Myeloid Mutation Panel</div>
              <div class="mobile-tag-grid" style="grid-template-columns:1fr 1fr 1fr;gap:6px;">
                <div class="mtag ok-tag"  onclick="toggleStatus('angsh12','myeloid_mutation_panel','OK',this)">OK</div>
                <div class="mtag pp-tag"  onclick="toggleStatus('angsh12','myeloid_mutation_panel','PP',this)">PP</div>
                <div class="mtag hp-tag"  onclick="toggleStatus('angsh12','myeloid_mutation_panel','HP',this)">HP</div>
              </div>
            </div>
            <div class="panel-result-block" id="angsh12_lymphoid_mutation_panel_block">
              <div class="prb-title">Lymphoid Mutation Panel</div>
              <div class="mobile-tag-grid" style="grid-template-columns:1fr 1fr 1fr;gap:6px;">
                <div class="mtag ok-tag"  onclick="toggleStatus('angsh12','lymphoid_mutation_panel','OK',this)">OK</div>
                <div class="mtag pp-tag"  onclick="toggleStatus('angsh12','lymphoid_mutation_panel','PP',this)">PP</div>
                <div class="mtag hp-tag"  onclick="toggleStatus('angsh12','lymphoid_mutation_panel','HP',this)">HP</div>
              </div>
            </div>
            <div class="panel-result-block" id="angsh12_tp53_only_block">
              <div class="prb-title">TP53 Only</div>
              <div class="mobile-tag-grid" style="grid-template-columns:1fr 1fr 1fr;gap:6px;">
                <div class="mtag ok-tag"  onclick="toggleStatus('angsh12','tp53_only','OK',this)">OK</div>
                <div class="mtag pp-tag"  onclick="toggleStatus('angsh12','tp53_only','PP',this)">PP</div>
                <div class="mtag hp-tag"  onclick="toggleStatus('angsh12','tp53_only','HP',this)">HP</div>
              </div>
            </div>
            <div class="panel-result-block" id="angsh12_other_block">
              <div class="prb-title">Other</div>
              <div class="mobile-tag-grid" style="grid-template-columns:1fr 1fr 1fr;gap:6px;">
                <div class="mtag ok-tag"  onclick="toggleStatus('angsh12','other','OK',this)">OK</div>
                <div class="mtag pp-tag"  onclick="toggleStatus('angsh12','other','PP',this)">PP</div>
                <div class="mtag hp-tag"  onclick="toggleStatus('angsh12','other','HP',this)">HP</div>
              </div>
            </div>
            </div>
          </div>
          <textarea class="mob-notes" id="angsh12_notes" placeholder="Overall remarks‚Ä¶" style="margin-top:12px;"></textarea>
          <button class="mob-save-btn" onclick="saveAcceptance('ngsh12')">üíæ Save NGS-H12 Acceptance</button>
        </div>
      </div>
      <div class="sub-panel" id="accept-ngsh9">
        <div class="workflow-block" id="accept_ngsh9_wfblock"></div>
        <div class="cr-lookup">
          <div class="field"><label>CR Number</label>
            <input type="text" id="angsh9_cr" placeholder="CR-2024-0001" onkeydown="if(event.key==='Enter')loadForAcceptance('ngsh9')">
          </div>
          <button class="lookup-btn" onclick="loadForAcceptance('ngsh9')">üîç Load</button>
        </div>
        <div id="angsh9_wrap" class="hidden">
          <div class="patient-card" id="angsh9_pc"></div>
          <div class="ordered-summary" id="angsh9_ordered"></div>
          <div class="order-block" style="margin-top:14px;">
            <div class="order-block-title">Unique Lab ID <span class="req">*</span> <span style="font-size:10px;font-weight:400;color:var(--slate);">Assigned by NGS-H9 lab</span></div>
            <input type="text" id="angsh9_unique_id" placeholder="e.g. NGS-H9-2026-001" style="margin-bottom:4px;"
              oninput="checkUniqueLabId('ngsh9',this)">
            <div id="angsh9_uid_status" style="font-size:11px;min-height:16px;margin-bottom:8px;font-family:var(--mono);"></div>
          </div>

<div class="order-block" style="margin-top:14px;">
            <div class="order-block-title">A ¬∑ Test Status per Panel</div>
            <div style="display:flex;gap:12px;font-size:11px;font-family:var(--mono);margin-bottom:14px;flex-wrap:wrap;">
              <span style="color:#1a6a3a;font-weight:700;">‚ñ† OK</span> ‚Äî Test proceeding, payment OK &nbsp;
              <span style="color:#b8860b;font-weight:700;">‚ñ† PP</span> ‚Äî Payment Pending &nbsp;
              <span style="color:var(--crimson);font-weight:700;">‚ñ† HP</span> ‚Äî Hold for Payment
            </div>
            <div id="angsh9_panels">
            <div class="panel-result-block" id="angsh9_rna_fusion_panel_block">
              <div class="prb-title">RNA Fusion Panel</div>
              <div class="mobile-tag-grid" style="grid-template-columns:1fr 1fr 1fr;gap:6px;">
                <div class="mtag ok-tag"  onclick="toggleStatus('angsh9','rna_fusion_panel','OK',this)">OK</div>
                <div class="mtag pp-tag"  onclick="toggleStatus('angsh9','rna_fusion_panel','PP',this)">PP</div>
                <div class="mtag hp-tag"  onclick="toggleStatus('angsh9','rna_fusion_panel','HP',this)">HP</div>
              </div>
            </div>
            <div class="panel-result-block" id="angsh9_ibmfs_panel_block">
              <div class="prb-title">IBMFS Panel</div>
              <div class="mobile-tag-grid" style="grid-template-columns:1fr 1fr 1fr;gap:6px;">
                <div class="mtag ok-tag"  onclick="toggleStatus('angsh9','ibmfs_panel','OK',this)">OK</div>
                <div class="mtag pp-tag"  onclick="toggleStatus('angsh9','ibmfs_panel','PP',this)">PP</div>
                <div class="mtag hp-tag"  onclick="toggleStatus('angsh9','ibmfs_panel','HP',this)">HP</div>
              </div>
            </div>
            <div class="panel-result-block" id="angsh9_wes_with_cnv_block">
              <div class="prb-title">WES with CNV</div>
              <div class="mobile-tag-grid" style="grid-template-columns:1fr 1fr 1fr;gap:6px;">
                <div class="mtag ok-tag"  onclick="toggleStatus('angsh9','wes_with_cnv','OK',this)">OK</div>
                <div class="mtag pp-tag"  onclick="toggleStatus('angsh9','wes_with_cnv','PP',this)">PP</div>
                <div class="mtag hp-tag"  onclick="toggleStatus('angsh9','wes_with_cnv','HP',this)">HP</div>
              </div>
            </div>
            <div class="panel-result-block" id="angsh9_tcr_by_ngs_block">
              <div class="prb-title">TCR by NGS</div>
              <div class="mobile-tag-grid" style="grid-template-columns:1fr 1fr 1fr;gap:6px;">
                <div class="mtag ok-tag"  onclick="toggleStatus('angsh9','tcr_by_ngs','OK',this)">OK</div>
                <div class="mtag pp-tag"  onclick="toggleStatus('angsh9','tcr_by_ngs','PP',this)">PP</div>
                <div class="mtag hp-tag"  onclick="toggleStatus('angsh9','tcr_by_ngs','HP',this)">HP</div>
              </div>
            </div>
            <div class="panel-result-block" id="angsh9_t_all_somatic_block">
              <div class="prb-title">T-ALL Somatic</div>
              <div class="mobile-tag-grid" style="grid-template-columns:1fr 1fr 1fr;gap:6px;">
                <div class="mtag ok-tag"  onclick="toggleStatus('angsh9','t_all_somatic','OK',this)">OK</div>
                <div class="mtag pp-tag"  onclick="toggleStatus('angsh9','t_all_somatic','PP',this)">PP</div>
                <div class="mtag hp-tag"  onclick="toggleStatus('angsh9','t_all_somatic','HP',this)">HP</div>
              </div>
            </div>
            <div class="panel-result-block" id="angsh9_other_block">
              <div class="prb-title">Other</div>
              <div class="mobile-tag-grid" style="grid-template-columns:1fr 1fr 1fr;gap:6px;">
                <div class="mtag ok-tag"  onclick="toggleStatus('angsh9','other','OK',this)">OK</div>
                <div class="mtag pp-tag"  onclick="toggleStatus('angsh9','other','PP',this)">PP</div>
                <div class="mtag hp-tag"  onclick="toggleStatus('angsh9','other','HP',this)">HP</div>
              </div>
            </div>
            </div>
          </div>
          <textarea class="mob-notes" id="angsh9_notes" placeholder="Overall remarks‚Ä¶" style="margin-top:12px;"></textarea>
          <button class="mob-save-btn" onclick="saveAcceptance('ngsh9')">üíæ Save NGS-H9 Acceptance</button>
        </div>
      </div>
      <div class="sub-panel" id="accept-tcr">
        <div class="workflow-block" id="accept_tcr_wfblock"></div>
        <div class="cr-lookup">
          <div class="field"><label>CR Number</label>
            <input type="text" id="atcr_cr" placeholder="CR-2024-0001" onkeydown="if(event.key==='Enter')loadForAcceptance('tcr')">
          </div>
          <button class="lookup-btn" onclick="loadForAcceptance('tcr')">üîç Load</button>
        </div>
        <div id="atcr_wrap" class="hidden">
          <div class="patient-card" id="atcr_pc"></div>
          <div class="ordered-summary" id="atcr_ordered"></div>
                    <div class="order-block" style="margin-top:14px;">
            <div class="order-block-title">Unique Lab ID <span class="req">*</span> <span style="font-size:10px;font-weight:400;color:var(--slate);">Assigned by TCR lab</span></div>
            <input type="text" id="atcr_unique_id" placeholder="e.g. TCR-2026-001" style="margin-bottom:4px;"
              oninput="checkUniqueLabId('tcr',this)">
            <div id="atcr_uid_status" style="font-size:11px;min-height:16px;margin-bottom:8px;font-family:var(--mono);"></div>
          </div>

<div class="order-block" style="margin-top:14px;">
            <div class="order-block-title">A ¬∑ Test Status per Panel</div>
            <div style="display:flex;gap:12px;font-size:11px;font-family:var(--mono);margin-bottom:14px;flex-wrap:wrap;">
              <span style="color:#1a6a3a;font-weight:700;">‚ñ† OK</span> ‚Äî Test proceeding, payment OK &nbsp;
              <span style="color:#b8860b;font-weight:700;">‚ñ† PP</span> ‚Äî Payment Pending &nbsp;
              <span style="color:var(--crimson);font-weight:700;">‚ñ† HP</span> ‚Äî Hold for Payment
            </div>
            <div id="atcr_panels">
            <div class="panel-result-block" id="atcr_tcr_beta_block">
              <div class="prb-title">TCR Beta</div>
              <div class="mobile-tag-grid" style="grid-template-columns:1fr 1fr 1fr;gap:6px;">
                <div class="mtag ok-tag"  onclick="toggleStatus('atcr','tcr_beta','OK',this)">OK</div>
                <div class="mtag pp-tag"  onclick="toggleStatus('atcr','tcr_beta','PP',this)">PP</div>
                <div class="mtag hp-tag"  onclick="toggleStatus('atcr','tcr_beta','HP',this)">HP</div>
              </div>
            </div>
            <div class="panel-result-block" id="atcr_tcr_gamma_block">
              <div class="prb-title">TCR Gamma</div>
              <div class="mobile-tag-grid" style="grid-template-columns:1fr 1fr 1fr;gap:6px;">
                <div class="mtag ok-tag"  onclick="toggleStatus('atcr','tcr_gamma','OK',this)">OK</div>
                <div class="mtag pp-tag"  onclick="toggleStatus('atcr','tcr_gamma','PP',this)">PP</div>
                <div class="mtag hp-tag"  onclick="toggleStatus('atcr','tcr_gamma','HP',this)">HP</div>
              </div>
            </div>
            <div class="panel-result-block" id="atcr_other_block">
              <div class="prb-title">Other</div>
              <div class="mobile-tag-grid" style="grid-template-columns:1fr 1fr 1fr;gap:6px;">
                <div class="mtag ok-tag"  onclick="toggleStatus('atcr','other','OK',this)">OK</div>
                <div class="mtag pp-tag"  onclick="toggleStatus('atcr','other','PP',this)">PP</div>
                <div class="mtag hp-tag"  onclick="toggleStatus('atcr','other','HP',this)">HP</div>
              </div>
            </div>
            </div>
          </div>
          <textarea class="mob-notes" id="atcr_notes" placeholder="Overall remarks‚Ä¶" style="margin-top:12px;"></textarea>
          <button class="mob-save-btn" onclick="saveAcceptance('tcr')">üíæ Save TCR Acceptance</button>
        </div>
      </div>
    </div>
  </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODULE 4: RESULT ENTRY ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div id="screen-entry" class="panel">
    <div class="panel-header">
      <button class="back-btn" onclick="showScreen('screen-home')">‚Üê Back</button>
      <h2>Result Entry</h2>
      <span class="step-badge">Module 05</span>
    </div>
    <div class="panel-body">
      <div class="sub-tabs">
        <button class="sub-tab active" id="tab-btn-entry-fish" onclick="switchSubTab('entry','fish',this)">FISH</button>
        <button class="sub-tab" id="tab-btn-entry-fcm" onclick="switchSubTab('entry','fcm',this)">FCM</button>
        <button class="sub-tab" id="tab-btn-entry-rtpcr" onclick="switchSubTab('entry','rtpcr',this)">RT-PCR</button>
        <button class="sub-tab" id="tab-btn-entry-ngsh12" onclick="switchSubTab('entry','ngsh12',this)">NGS-H12</button>
        <button class="sub-tab" id="tab-btn-entry-ngsh9" onclick="switchSubTab('entry','ngsh9',this)">NGS-H9</button>
        <button class="sub-tab" id="tab-btn-entry-tcr" onclick="switchSubTab('entry','tcr',this)">TCR</button>
      </div>

      <div class="sub-panel active" id="entry-fish">
        <div class="workflow-block" id="entry_fish_wfblock"></div>
        <div class="cr-lookup">
          <div class="field"><label>CR Number</label>
            <input type="text" id="efish_cr" placeholder="CR-2024-0001" onkeydown="if(event.key==='Enter')loadForEntry('fish')">
          </div>
          <button class="lookup-btn" onclick="loadForEntry('fish')">üîç Load</button>
        </div>
        <div id="efish_wrap" class="hidden">
          <div class="patient-card" id="efish_pc"></div>
          <div class="ordered-summary" id="efish_ordered"></div>
          <div class="order-block" style="margin-top:14px;">
            <div class="order-block-title">Results per Panel</div>
            <p style="font-size:11px;color:var(--slate);margin-bottom:12px;">Status from Test Acceptance shown on each panel.</p>
            <div id="efish_panels">
            <div class="panel-result-block" id="efish_all_block">
              <div class="prb-title" style="display:flex;align-items:center;justify-content:space-between;">
                <span>ALL</span>
                <span class="status-badge-inline" id="efish_all_badge"></span>
              </div>
              <div class="mobile-tag-grid" id="efish_all_opts" style="grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:6px;margin-bottom:6px;">
                <div class="mtag result-opt" onclick="selectResult('efish','all',this)" data-val="Normal">Normal</div>
              <div class="mtag result-opt" onclick="selectResult('efish','all',this)" data-val="CNV gain">CNV gain</div>
              <div class="mtag result-opt" onclick="selectResult('efish','all',this)" data-val="CNV loss">CNV loss</div>
              <div class="mtag result-opt" onclick="selectResult('efish','all',this)" data-val="Amplification">Amplification</div>
              <div class="mtag result-opt" onclick="selectResult('efish','all',this)" data-val="Failed">Failed</div>
              <div class="mtag result-opt" onclick="selectResult('efish','all',this)" data-val="ETV6-RUNX1">ETV6-RUNX1</div>
              <div class="mtag result-opt" onclick="selectResult('efish','all',this)" data-val="BCR-ABL1">BCR-ABL1</div>
              <div class="mtag result-opt" onclick="selectResult('efish','all',this)" data-val="TCF3-PBX1">TCF3-PBX1</div>
              <div class="mtag result-opt" onclick="selectResult('efish','all',this)" data-val="iAMP21">iAMP21</div>
              <div class="mtag result-opt" onclick="selectResult('efish','all',this)" data-val="KMT2A-r">KMT2A-r</div>
              <div class="mtag result-opt" onclick="selectResult('efish','all',this)" data-val="IKZF1-r">IKZF1-r</div>
              <div class="mtag result-opt" onclick="selectResult('efish','all',this)" data-val="TP53del">TP53del</div>
              <div class="mtag result-opt" onclick="selectResult('efish','all',this)" data-val="CRLF2-r">CRLF2-r</div>
              <div class="mtag result-opt" onclick="selectResult('efish','all',this)" data-val="EPOR-r">EPOR-r</div>
              </div>
              <input type="hidden" id="efish_all_result" value="">
              <textarea class="mob-notes" id="efish_all_notes" placeholder="Additional remarks for ALL‚Ä¶" rows="2" style="margin-top:6px;"></textarea>
            </div>
            <div class="panel-result-block" id="efish_mds_block">
              <div class="prb-title" style="display:flex;align-items:center;justify-content:space-between;">
                <span>MDS</span>
                <span class="status-badge-inline" id="efish_mds_badge"></span>
              </div>
              <div class="mobile-tag-grid" id="efish_mds_opts" style="grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:6px;margin-bottom:6px;">
                <div class="mtag result-opt" onclick="selectResult('efish','mds',this)" data-val="Normal">Normal</div>
              <div class="mtag result-opt" onclick="selectResult('efish','mds',this)" data-val="Failed">Failed</div>
              <div class="mtag result-opt" onclick="selectResult('efish','mds',this)" data-val="CNV gain">CNV gain</div>
              <div class="mtag result-opt" onclick="selectResult('efish','mds',this)" data-val="CNV loss">CNV loss</div>
              <div class="mtag result-opt" onclick="selectResult('efish','mds',this)" data-val="5q-">5q-</div>
              <div class="mtag result-opt" onclick="selectResult('efish','mds',this)" data-val="-5">-5</div>
              <div class="mtag result-opt" onclick="selectResult('efish','mds',this)" data-val="7q-">7q-</div>
              <div class="mtag result-opt" onclick="selectResult('efish','mds',this)" data-val="-7">-7</div>
              <div class="mtag result-opt" onclick="selectResult('efish','mds',this)" data-val="+8">+8</div>
              <div class="mtag result-opt" onclick="selectResult('efish','mds',this)" data-val="-3q">-3q</div>
              <div class="mtag result-opt" onclick="selectResult('efish','mds',this)" data-val="MECOM-r">MECOM-r</div>
              <div class="mtag result-opt" onclick="selectResult('efish','mds',this)" data-val="KMT2A-r">KMT2A-r</div>
              <div class="mtag result-opt" onclick="selectResult('efish','mds',this)" data-val="TP53del">TP53del</div>
              <div class="mtag result-opt" onclick="selectResult('efish','mds',this)" data-val="DEK-NUP214-r">DEK-NUP214-r</div>
              <div class="mtag result-opt" onclick="selectResult('efish','mds',this)" data-val="NUP98-r">NUP98-r</div>
              <div class="mtag result-opt" onclick="selectResult('efish','mds',this)" data-val="20qdel">20qdel</div>
              <div class="mtag result-opt" onclick="selectResult('efish','mds',this)" data-val="iso20q">iso20q</div>
              <div class="mtag result-opt" onclick="selectResult('efish','mds',this)" data-val="iso7p">iso7p</div>
              <div class="mtag result-opt" onclick="selectResult('efish','mds',this)" data-val="iso17q">iso17q</div>
              </div>
              <input type="hidden" id="efish_mds_result" value="">
              <textarea class="mob-notes" id="efish_mds_notes" placeholder="Additional remarks for MDS‚Ä¶" rows="2" style="margin-top:6px;"></textarea>
            </div>
            <div class="panel-result-block" id="efish_mds_extended_block">
              <div class="prb-title" style="display:flex;align-items:center;justify-content:space-between;">
                <span>MDS-Extended</span>
                <span class="status-badge-inline" id="efish_mds_extended_badge"></span>
              </div>
              <div class="mobile-tag-grid" id="efish_mds_extended_opts" style="grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:6px;margin-bottom:6px;">
                <div class="mtag result-opt" onclick="selectResult('efish','mds_extended',this)" data-val="Normal">Normal</div>
              <div class="mtag result-opt" onclick="selectResult('efish','mds_extended',this)" data-val="CNV gain">CNV gain</div>
              <div class="mtag result-opt" onclick="selectResult('efish','mds_extended',this)" data-val="CNV loss">CNV loss</div>
              <div class="mtag result-opt" onclick="selectResult('efish','mds_extended',this)" data-val="5q-">5q-</div>
              <div class="mtag result-opt" onclick="selectResult('efish','mds_extended',this)" data-val="-5">-5</div>
              <div class="mtag result-opt" onclick="selectResult('efish','mds_extended',this)" data-val="7q-">7q-</div>
              <div class="mtag result-opt" onclick="selectResult('efish','mds_extended',this)" data-val="-7">-7</div>
              <div class="mtag result-opt" onclick="selectResult('efish','mds_extended',this)" data-val="+8">+8</div>
              <div class="mtag result-opt" onclick="selectResult('efish','mds_extended',this)" data-val="-3q">-3q</div>
              <div class="mtag result-opt" onclick="selectResult('efish','mds_extended',this)" data-val="MECOM-r">MECOM-r</div>
              <div class="mtag result-opt" onclick="selectResult('efish','mds_extended',this)" data-val="KMT2A-r">KMT2A-r</div>
              <div class="mtag result-opt" onclick="selectResult('efish','mds_extended',this)" data-val="TP53del">TP53del</div>
              <div class="mtag result-opt" onclick="selectResult('efish','mds_extended',this)" data-val="DEK-NUP214-r">DEK-NUP214-r</div>
              <div class="mtag result-opt" onclick="selectResult('efish','mds_extended',this)" data-val="NUP98-r">NUP98-r</div>
              <div class="mtag result-opt" onclick="selectResult('efish','mds_extended',this)" data-val="20qdel">20qdel</div>
              <div class="mtag result-opt" onclick="selectResult('efish','mds_extended',this)" data-val="iso20q">iso20q</div>
              <div class="mtag result-opt" onclick="selectResult('efish','mds_extended',this)" data-val="iso7p">iso7p</div>
              <div class="mtag result-opt" onclick="selectResult('efish','mds_extended',this)" data-val="iso17q">iso17q</div>
              <div class="mtag result-opt" onclick="selectResult('efish','mds_extended',this)" data-val="Amplification">Amplification</div>
              <div class="mtag result-opt" onclick="selectResult('efish','mds_extended',this)" data-val="Failed">Failed</div>
              </div>
              <input type="hidden" id="efish_mds_extended_result" value="">
              <textarea class="mob-notes" id="efish_mds_extended_notes" placeholder="Additional remarks for MDS-Extended‚Ä¶" rows="2" style="margin-top:6px;"></textarea>
            </div>
            <div class="panel-result-block" id="efish_acute_leuk_nos_block">
              <div class="prb-title" style="display:flex;align-items:center;justify-content:space-between;">
                <span>Acute Leuk-NOS</span>
                <span class="status-badge-inline" id="efish_acute_leuk_nos_badge"></span>
              </div>
              <div class="mobile-tag-grid" id="efish_acute_leuk_nos_opts" style="grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:6px;margin-bottom:6px;">
                <div class="mtag result-opt" onclick="selectResult('efish','acute_leuk_nos',this)" data-val="Amplification">Amplification</div>
              <div class="mtag result-opt" onclick="selectResult('efish','acute_leuk_nos',this)" data-val="BCR-ABL1">BCR-ABL1</div>
              <div class="mtag result-opt" onclick="selectResult('efish','acute_leuk_nos',this)" data-val="CNV gain">CNV gain</div>
              <div class="mtag result-opt" onclick="selectResult('efish','acute_leuk_nos',this)" data-val="CNV loss">CNV loss</div>
              <div class="mtag result-opt" onclick="selectResult('efish','acute_leuk_nos',this)" data-val="CRLF2-r">CRLF2-r</div>
              <div class="mtag result-opt" onclick="selectResult('efish','acute_leuk_nos',this)" data-val="EPOR-r">EPOR-r</div>
              <div class="mtag result-opt" onclick="selectResult('efish','acute_leuk_nos',this)" data-val="ETV6-RUNX1">ETV6-RUNX1</div>
              <div class="mtag result-opt" onclick="selectResult('efish','acute_leuk_nos',this)" data-val="Failed">Failed</div>
              <div class="mtag result-opt" onclick="selectResult('efish','acute_leuk_nos',this)" data-val="IKZF1-r">IKZF1-r</div>
              <div class="mtag result-opt" onclick="selectResult('efish','acute_leuk_nos',this)" data-val="KMT2A-r">KMT2A-r</div>
              <div class="mtag result-opt" onclick="selectResult('efish','acute_leuk_nos',this)" data-val="Normal">Normal</div>
              <div class="mtag result-opt" onclick="selectResult('efish','acute_leuk_nos',this)" data-val="TCF3-PBX1">TCF3-PBX1</div>
              <div class="mtag result-opt" onclick="selectResult('efish','acute_leuk_nos',this)" data-val="TP53del">TP53del</div>
              <div class="mtag result-opt" onclick="selectResult('efish','acute_leuk_nos',this)" data-val="iAMP21">iAMP21</div>
              <div class="mtag result-opt" onclick="selectResult('efish','acute_leuk_nos',this)" data-val="+8">+8</div>
              <div class="mtag result-opt" onclick="selectResult('efish','acute_leuk_nos',this)" data-val="-3q">-3q</div>
              <div class="mtag result-opt" onclick="selectResult('efish','acute_leuk_nos',this)" data-val="-5">-5</div>
              <div class="mtag result-opt" onclick="selectResult('efish','acute_leuk_nos',this)" data-val="-7">-7</div>
              <div class="mtag result-opt" onclick="selectResult('efish','acute_leuk_nos',this)" data-val="20qdel">20qdel</div>
              <div class="mtag result-opt" onclick="selectResult('efish','acute_leuk_nos',this)" data-val="5q-">5q-</div>
              <div class="mtag result-opt" onclick="selectResult('efish','acute_leuk_nos',this)" data-val="7q-">7q-</div>
              <div class="mtag result-opt" onclick="selectResult('efish','acute_leuk_nos',this)" data-val="DEK-NUP214-r">DEK-NUP214-r</div>
              <div class="mtag result-opt" onclick="selectResult('efish','acute_leuk_nos',this)" data-val="MECOM-r">MECOM-r</div>
              <div class="mtag result-opt" onclick="selectResult('efish','acute_leuk_nos',this)" data-val="NUP98-r">NUP98-r</div>
              <div class="mtag result-opt" onclick="selectResult('efish','acute_leuk_nos',this)" data-val="iso17q">iso17q</div>
              <div class="mtag result-opt" onclick="selectResult('efish','acute_leuk_nos',this)" data-val="iso20q">iso20q</div>
              <div class="mtag result-opt" onclick="selectResult('efish','acute_leuk_nos',this)" data-val="iso7p">iso7p</div>
              </div>
              <input type="hidden" id="efish_acute_leuk_nos_result" value="">
              <textarea class="mob-notes" id="efish_acute_leuk_nos_notes" placeholder="Additional remarks for Acute Leuk-NOS‚Ä¶" rows="2" style="margin-top:6px;"></textarea>
            </div>
            <div class="panel-result-block" id="efish_cml_mpn_block">
              <div class="prb-title" style="display:flex;align-items:center;justify-content:space-between;">
                <span>CML/MPN</span>
                <span class="status-badge-inline" id="efish_cml_mpn_badge"></span>
              </div>
              <div class="mobile-tag-grid" id="efish_cml_mpn_opts" style="grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:6px;margin-bottom:6px;">
                <div class="mtag result-opt" onclick="selectResult('efish','cml_mpn',this)" data-val="BCR-ABL1">BCR-ABL1</div>
              <div class="mtag result-opt" onclick="selectResult('efish','cml_mpn',this)" data-val="CNV gain">CNV gain</div>
              <div class="mtag result-opt" onclick="selectResult('efish','cml_mpn',this)" data-val="CNV loss">CNV loss</div>
              <div class="mtag result-opt" onclick="selectResult('efish','cml_mpn',this)" data-val="Failed">Failed</div>
              <div class="mtag result-opt" onclick="selectResult('efish','cml_mpn',this)" data-val="ETV6-r">ETV6-r</div>
              <div class="mtag result-opt" onclick="selectResult('efish','cml_mpn',this)" data-val="PDGFRB-r">PDGFRB-r</div>
              <div class="mtag result-opt" onclick="selectResult('efish','cml_mpn',this)" data-val="PDGFRA-r">PDGFRA-r</div>
              <div class="mtag result-opt" onclick="selectResult('efish','cml_mpn',this)" data-val="JAK2-r">JAK2-r</div>
              <div class="mtag result-opt" onclick="selectResult('efish','cml_mpn',this)" data-val="ABL1-r">ABL1-r</div>
              <div class="mtag result-opt" onclick="selectResult('efish','cml_mpn',this)" data-val="FGFR1-r">FGFR1-r</div>
              </div>
              <input type="hidden" id="efish_cml_mpn_result" value="">
              <textarea class="mob-notes" id="efish_cml_mpn_notes" placeholder="Additional remarks for CML/MPN‚Ä¶" rows="2" style="margin-top:6px;"></textarea>
            </div>
            <div class="panel-result-block" id="efish_jmml_block">
              <div class="prb-title" style="display:flex;align-items:center;justify-content:space-between;">
                <span>JMML</span>
                <span class="status-badge-inline" id="efish_jmml_badge"></span>
              </div>
              <div class="mobile-tag-grid" id="efish_jmml_opts" style="grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:6px;margin-bottom:6px;">
                <div class="mtag result-opt" onclick="selectResult('efish','jmml',this)" data-val="Normal">Normal</div>
              <div class="mtag result-opt" onclick="selectResult('efish','jmml',this)" data-val="CNV gain">CNV gain</div>
              <div class="mtag result-opt" onclick="selectResult('efish','jmml',this)" data-val="CNV loss">CNV loss</div>
              <div class="mtag result-opt" onclick="selectResult('efish','jmml',this)" data-val="5q-">5q-</div>
              <div class="mtag result-opt" onclick="selectResult('efish','jmml',this)" data-val="-5">-5</div>
              <div class="mtag result-opt" onclick="selectResult('efish','jmml',this)" data-val="7q-">7q-</div>
              <div class="mtag result-opt" onclick="selectResult('efish','jmml',this)" data-val="-7">-7</div>
              <div class="mtag result-opt" onclick="selectResult('efish','jmml',this)" data-val="+8">+8</div>
              <div class="mtag result-opt" onclick="selectResult('efish','jmml',this)" data-val="-3q">-3q</div>
              <div class="mtag result-opt" onclick="selectResult('efish','jmml',this)" data-val="MECOM-r">MECOM-r</div>
              <div class="mtag result-opt" onclick="selectResult('efish','jmml',this)" data-val="KMT2A-r">KMT2A-r</div>
              <div class="mtag result-opt" onclick="selectResult('efish','jmml',this)" data-val="TP53del">TP53del</div>
              <div class="mtag result-opt" onclick="selectResult('efish','jmml',this)" data-val="DEK-NUP214-r">DEK-NUP214-r</div>
              <div class="mtag result-opt" onclick="selectResult('efish','jmml',this)" data-val="NUP98-r">NUP98-r</div>
              <div class="mtag result-opt" onclick="selectResult('efish','jmml',this)" data-val="20qdel">20qdel</div>
              <div class="mtag result-opt" onclick="selectResult('efish','jmml',this)" data-val="iso20q">iso20q</div>
              <div class="mtag result-opt" onclick="selectResult('efish','jmml',this)" data-val="iso7p">iso7p</div>
              <div class="mtag result-opt" onclick="selectResult('efish','jmml',this)" data-val="iso17q">iso17q</div>
              <div class="mtag result-opt" onclick="selectResult('efish','jmml',this)" data-val="Amplification">Amplification</div>
              <div class="mtag result-opt" onclick="selectResult('efish','jmml',this)" data-val="Failed">Failed</div>
              </div>
              <input type="hidden" id="efish_jmml_result" value="">
              <textarea class="mob-notes" id="efish_jmml_notes" placeholder="Additional remarks for JMML‚Ä¶" rows="2" style="margin-top:6px;"></textarea>
            </div>
            <div class="panel-result-block" id="efish_cll_block">
              <div class="prb-title" style="display:flex;align-items:center;justify-content:space-between;">
                <span>CLL</span>
                <span class="status-badge-inline" id="efish_cll_badge"></span>
              </div>
              <div class="mobile-tag-grid" id="efish_cll_opts" style="grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:6px;margin-bottom:6px;">
                <div class="mtag result-opt" onclick="selectResult('efish','cll',this)" data-val="Normal">Normal</div>
              <div class="mtag result-opt" onclick="selectResult('efish','cll',this)" data-val="del13q">del13q</div>
              <div class="mtag result-opt" onclick="selectResult('efish','cll',this)" data-val="del17p">del17p</div>
              <div class="mtag result-opt" onclick="selectResult('efish','cll',this)" data-val="del11q">del11q</div>
              <div class="mtag result-opt" onclick="selectResult('efish','cll',this)" data-val="Trisomy 12">Trisomy 12</div>
              <div class="mtag result-opt" onclick="selectResult('efish','cll',this)" data-val="Failed">Failed</div>
              <div class="mtag result-opt" onclick="selectResult('efish','cll',this)" data-val="Others">Others</div>
              </div>
              <div id="efish_cll_other_wrap" class="other-input-wrap hidden" style="margin-top:8px;">
                <input type="text" id="efish_cll_other_text" class="other-input" placeholder="Specify result‚Ä¶">
              </div>
              <input type="hidden" id="efish_cll_result" value="">
              <textarea class="mob-notes" id="efish_cll_notes" placeholder="Additional remarks for CLL‚Ä¶" rows="2" style="margin-top:6px;"></textarea>
            </div>
            <div class="panel-result-block" id="efish_cll_ccnd1_block">
              <div class="prb-title" style="display:flex;align-items:center;justify-content:space-between;">
                <span>CLL+CCND1</span>
                <span class="status-badge-inline" id="efish_cll_ccnd1_badge"></span>
              </div>
              <div class="mobile-tag-grid" id="efish_cll_ccnd1_opts" style="grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:6px;margin-bottom:6px;">
                <div class="mtag result-opt" onclick="selectResult('efish','cll_ccnd1',this)" data-val="Normal">Normal</div>
              <div class="mtag result-opt" onclick="selectResult('efish','cll_ccnd1',this)" data-val="del13q">del13q</div>
              <div class="mtag result-opt" onclick="selectResult('efish','cll_ccnd1',this)" data-val="del17p">del17p</div>
              <div class="mtag result-opt" onclick="selectResult('efish','cll_ccnd1',this)" data-val="del11q">del11q</div>
              <div class="mtag result-opt" onclick="selectResult('efish','cll_ccnd1',this)" data-val="Trisomy 12">Trisomy 12</div>
              <div class="mtag result-opt" onclick="selectResult('efish','cll_ccnd1',this)" data-val="CCND1-r">CCND1-r</div>
              </div>
              <input type="hidden" id="efish_cll_ccnd1_result" value="">
              <textarea class="mob-notes" id="efish_cll_ccnd1_notes" placeholder="Additional remarks for CLL+CCND1‚Ä¶" rows="2" style="margin-top:6px;"></textarea>
            </div>
            <div class="panel-result-block" id="efish_lymphoma_not_cll_block">
              <div class="prb-title" style="display:flex;align-items:center;justify-content:space-between;">
                <span>Lymphoma-not CLL</span>
                <span class="status-badge-inline" id="efish_lymphoma_not_cll_badge"></span>
              </div>
              <div class="mobile-tag-grid" id="efish_lymphoma_not_cll_opts" style="grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:6px;margin-bottom:6px;">
                <div class="mtag result-opt" onclick="selectResult('efish','lymphoma_not_cll',this)" data-val="Normal">Normal</div>
              <div class="mtag result-opt" onclick="selectResult('efish','lymphoma_not_cll',this)" data-val="del17p">del17p</div>
              <div class="mtag result-opt" onclick="selectResult('efish','lymphoma_not_cll',this)" data-val="IGH-r">IGH-r</div>
              <div class="mtag result-opt" onclick="selectResult('efish','lymphoma_not_cll',this)" data-val="Failed">Failed</div>
              <div class="mtag result-opt" onclick="selectResult('efish','lymphoma_not_cll',this)" data-val="BCL-2r">BCL-2r</div>
              <div class="mtag result-opt" onclick="selectResult('efish','lymphoma_not_cll',this)" data-val="BCL-6r">BCL-6r</div>
              <div class="mtag result-opt" onclick="selectResult('efish','lymphoma_not_cll',this)" data-val="MYC-r">MYC-r</div>
              <div class="mtag result-opt" onclick="selectResult('efish','lymphoma_not_cll',this)" data-val="CCND1-r">CCND1-r</div>
              </div>
              <input type="hidden" id="efish_lymphoma_not_cll_result" value="">
              <textarea class="mob-notes" id="efish_lymphoma_not_cll_notes" placeholder="Additional remarks for Lymphoma-not CLL‚Ä¶" rows="2" style="margin-top:6px;"></textarea>
            </div>
            <div class="panel-result-block" id="efish_hes_block">
              <div class="prb-title" style="display:flex;align-items:center;justify-content:space-between;">
                <span>HES</span>
                <span class="status-badge-inline" id="efish_hes_badge"></span>
              </div>
              <div class="mobile-tag-grid" id="efish_hes_opts" style="grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:6px;margin-bottom:6px;">
                <div class="mtag result-opt" onclick="selectResult('efish','hes',this)" data-val="Normal">Normal</div>
              <div class="mtag result-opt" onclick="selectResult('efish','hes',this)" data-val="PDGFRA-r">PDGFRA-r</div>
              <div class="mtag result-opt" onclick="selectResult('efish','hes',this)" data-val="PDGFRB-r">PDGFRB-r</div>
              <div class="mtag result-opt" onclick="selectResult('efish','hes',this)" data-val="FGFR1-r">FGFR1-r</div>
              <div class="mtag result-opt" onclick="selectResult('efish','hes',this)" data-val="JAK2-r">JAK2-r</div>
              <div class="mtag result-opt" onclick="selectResult('efish','hes',this)" data-val="ETV6-r">ETV6-r</div>
              <div class="mtag result-opt" onclick="selectResult('efish','hes',this)" data-val="Failed">Failed</div>
              </div>
              <input type="hidden" id="efish_hes_result" value="">
              <textarea class="mob-notes" id="efish_hes_notes" placeholder="Additional remarks for HES‚Ä¶" rows="2" style="margin-top:6px;"></textarea>
            </div>
            <div class="panel-result-block" id="efish_t_pll_block">
              <div class="prb-title" style="display:flex;align-items:center;justify-content:space-between;">
                <span>T-PLL</span>
                <span class="status-badge-inline" id="efish_t_pll_badge"></span>
              </div>
              <div class="mobile-tag-grid" id="efish_t_pll_opts" style="grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:6px;margin-bottom:6px;">
                <div class="mtag result-opt" onclick="selectResult('efish','t_pll',this)" data-val="TCL1-r">TCL1-r</div>
              <div class="mtag result-opt" onclick="selectResult('efish','t_pll',this)" data-val="TP53del">TP53del</div>
              <div class="mtag result-opt" onclick="selectResult('efish','t_pll',this)" data-val="Normal">Normal</div>
              <div class="mtag result-opt" onclick="selectResult('efish','t_pll',this)" data-val="Failed">Failed</div>
              </div>
              <input type="hidden" id="efish_t_pll_result" value="">
              <textarea class="mob-notes" id="efish_t_pll_notes" placeholder="Additional remarks for T-PLL‚Ä¶" rows="2" style="margin-top:6px;"></textarea>
            </div>
            <div class="panel-result-block" id="efish_mm_block">
              <div class="prb-title" style="display:flex;align-items:center;justify-content:space-between;">
                <span>MM</span>
                <span class="status-badge-inline" id="efish_mm_badge"></span>
              </div>
              <div class="mobile-tag-grid" id="efish_mm_opts" style="grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:6px;margin-bottom:6px;">
                <div class="mtag result-opt" onclick="selectResult('efish','mm',this)" data-val="Normal">Normal</div>
              <div class="mtag result-opt" onclick="selectResult('efish','mm',this)" data-val="del17p">del17p</div>
              <div class="mtag result-opt" onclick="selectResult('efish','mm',this)" data-val="IGH-r">IGH-r</div>
              <div class="mtag result-opt" onclick="selectResult('efish','mm',this)" data-val="FGFR3-IGH">FGFR3-IGH</div>
              <div class="mtag result-opt" onclick="selectResult('efish','mm',this)" data-val="Failed">Failed</div>
              <div class="mtag result-opt" onclick="selectResult('efish','mm',this)" data-val="IGH-FGFR3">IGH-FGFR3</div>
              <div class="mtag result-opt" onclick="selectResult('efish','mm',this)" data-val="IGH-MAF">IGH-MAF</div>
              <div class="mtag result-opt" onclick="selectResult('efish','mm',this)" data-val="IGH-MAFB">IGH-MAFB</div>
              <div class="mtag result-opt" onclick="selectResult('efish','mm',this)" data-val="CCND1-r">CCND1-r</div>
              <div class="mtag result-opt" onclick="selectResult('efish','mm',this)" data-val="1q gain">1q gain</div>
              <div class="mtag result-opt" onclick="selectResult('efish','mm',this)" data-val="1p loss">1p loss</div>
              <div class="mtag result-opt" onclick="selectResult('efish','mm',this)" data-val="CNV loss">CNV loss</div>
              <div class="mtag result-opt" onclick="selectResult('efish','mm',this)" data-val="CNV gain">CNV gain</div>
              <div class="mtag result-opt" onclick="selectResult('efish','mm',this)" data-val="Others">Others</div>
              </div>
              <div id="efish_mm_other_wrap" class="other-input-wrap hidden" style="margin-top:8px;">
                <input type="text" id="efish_mm_other_text" class="other-input" placeholder="Specify result‚Ä¶">
              </div>
              <input type="hidden" id="efish_mm_result" value="">
              <textarea class="mob-notes" id="efish_mm_notes" placeholder="Additional remarks for MM‚Ä¶" rows="2" style="margin-top:6px;"></textarea>
            </div>
            <div class="panel-result-block" id="efish_other_block">
              <div class="prb-title" style="display:flex;align-items:center;justify-content:space-between;">
                <span>Other</span>
                <span class="status-badge-inline" id="efish_other_badge"></span>
              </div>
              <div class="mobile-tag-grid" id="efish_other_opts" style="grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:6px;margin-bottom:6px;">
                <div class="mtag result-opt" onclick="selectResult('efish','other',this)" data-val="Fusion">Fusion</div>
              <div class="mtag result-opt" onclick="selectResult('efish','other',this)" data-val="CNV gain">CNV gain</div>
              <div class="mtag result-opt" onclick="selectResult('efish','other',this)" data-val="CNV loss">CNV loss</div>
              <div class="mtag result-opt" onclick="selectResult('efish','other',this)" data-val="Failed">Failed</div>
              <div class="mtag result-opt" onclick="selectResult('efish','other',this)" data-val="Others">Others</div>
              </div>
              <div id="efish_other_other_wrap" class="other-input-wrap hidden" style="margin-top:8px;">
                <input type="text" id="efish_other_other_text" class="other-input" placeholder="Specify result‚Ä¶">
              </div>
              <input type="hidden" id="efish_other_result" value="">
              <textarea class="mob-notes" id="efish_other_notes" placeholder="Additional remarks for Other‚Ä¶" rows="2" style="margin-top:6px;"></textarea>
            </div>
            </div>
          </div>
          <textarea class="mob-notes" id="efish_overall_notes" placeholder="Overall remarks‚Ä¶" style="margin-top:12px;"></textarea>
          <button class="mob-save-btn" onclick="saveEntry('fish')">üíæ Save FISH Results</button>
        </div>
      </div>
      <div class="sub-panel" id="entry-fcm">
        <div class="workflow-block" id="entry_fcm_wfblock"></div>
        <div class="cr-lookup">
          <div class="field"><label>CR Number</label>
            <input type="text" id="efcm_cr" placeholder="CR-2024-0001" onkeydown="if(event.key==='Enter')loadForEntry('fcm')">
          </div>
          <button class="lookup-btn" onclick="loadForEntry('fcm')">üîç Load</button>
        </div>
        <div id="efcm_wrap" class="hidden">
          <div class="patient-card" id="efcm_pc"></div>
          <div class="ordered-summary" id="efcm_ordered"></div>
          <div class="order-block" style="margin-top:14px;">
            <div class="order-block-title">Results per Panel</div>
            <p style="font-size:11px;color:var(--slate);margin-bottom:12px;">Status from Test Acceptance shown on each panel.</p>
            <div id="efcm_panels">
            <div class="panel-result-block" id="efcm_acute_leuk_block">
              <div class="prb-title" style="display:flex;align-items:center;justify-content:space-between;">
                <span>Acute Leuk</span>
                <span class="status-badge-inline" id="efcm_acute_leuk_badge"></span>
              </div>
              <div class="mobile-tag-grid" id="efcm_acute_leuk_opts" style="grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:6px;margin-bottom:6px;">
                <div class="mtag result-opt" onclick="selectResult('efcm','acute_leuk',this)" data-val="B-ALL">B-ALL</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','acute_leuk',this)" data-val="T-ALL">T-ALL</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','acute_leuk',this)" data-val="AML">AML</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','acute_leuk',this)" data-val="APML">APML</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','acute_leuk',this)" data-val="T/Myeloid">T/Myeloid</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','acute_leuk',this)" data-val="B/Myeloid">B/Myeloid</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','acute_leuk',this)" data-val="NK-cell neoplasm">NK-cell neoplasm</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','acute_leuk',this)" data-val="B-NHL">B-NHL</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','acute_leuk',this)" data-val="T-NHL">T-NHL</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','acute_leuk',this)" data-val="LGL">LGL</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','acute_leuk',this)" data-val="GD-T-CLPD">GD-T-CLPD</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','acute_leuk',this)" data-val="HSTCL">HSTCL</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','acute_leuk',this)" data-val="Normal">Normal</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','acute_leuk',this)" data-val="Inconclusive">Inconclusive</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','acute_leuk',this)" data-val="Others">Others</div>
              </div>
              <div id="efcm_acute_leuk_other_wrap" class="other-input-wrap hidden" style="margin-top:8px;">
                <input type="text" id="efcm_acute_leuk_other_text" class="other-input" placeholder="Specify result‚Ä¶">
              </div>
              <input type="hidden" id="efcm_acute_leuk_result" value="">
              <textarea class="mob-notes" id="efcm_acute_leuk_notes" placeholder="Additional remarks for Acute Leuk‚Ä¶" rows="2" style="margin-top:6px;"></textarea>
            </div>
            <div class="panel-result-block" id="efcm_clpd_block">
              <div class="prb-title" style="display:flex;align-items:center;justify-content:space-between;">
                <span>CLPD</span>
                <span class="status-badge-inline" id="efcm_clpd_badge"></span>
              </div>
              <div class="mobile-tag-grid" id="efcm_clpd_opts" style="grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:6px;margin-bottom:6px;">
                <div class="mtag result-opt" onclick="selectResult('efcm','clpd',this)" data-val="Negative">Negative</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','clpd',this)" data-val="CLL">CLL</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','clpd',this)" data-val="MCL">MCL</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','clpd',this)" data-val="FL">FL</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','clpd',this)" data-val="MZL">MZL</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','clpd',this)" data-val="HCL">HCL</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','clpd',this)" data-val="LPL">LPL</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','clpd',this)" data-val="B-NHL">B-NHL</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','clpd',this)" data-val="T-cell CLPD">T-cell CLPD</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','clpd',this)" data-val="T-LGL">T-LGL</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','clpd',this)" data-val="NK-cell CLPD">NK-cell CLPD</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','clpd',this)" data-val="HSTCL">HSTCL</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','clpd',this)" data-val="AITL">AITL</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','clpd',this)" data-val="CLL Vs. MCL">CLL Vs. MCL</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','clpd',this)" data-val="5-10-CLPD">5-10-CLPD</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','clpd',this)" data-val="5+ CLPD">5+ CLPD</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','clpd',this)" data-val="Acute Leukemia">Acute Leukemia</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','clpd',this)" data-val="Inconclusive">Inconclusive</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','clpd',this)" data-val="Others">Others</div>
              </div>
              <div id="efcm_clpd_other_wrap" class="other-input-wrap hidden" style="margin-top:8px;">
                <input type="text" id="efcm_clpd_other_text" class="other-input" placeholder="Specify result‚Ä¶">
              </div>
              <input type="hidden" id="efcm_clpd_result" value="">
              <textarea class="mob-notes" id="efcm_clpd_notes" placeholder="Additional remarks for CLPD‚Ä¶" rows="2" style="margin-top:6px;"></textarea>
            </div>
            <div class="panel-result-block" id="efcm_mm_diagnosis_block">
              <div class="prb-title" style="display:flex;align-items:center;justify-content:space-between;">
                <span>MM-Diagnosis</span>
                <span class="status-badge-inline" id="efcm_mm_diagnosis_badge"></span>
              </div>
              <div class="mobile-tag-grid" id="efcm_mm_diagnosis_opts" style="grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:6px;margin-bottom:6px;">
                <div class="mtag result-opt" onclick="selectResult('efcm','mm_diagnosis',this)" data-val="Clonal PC">Clonal PC</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','mm_diagnosis',this)" data-val="Non-Clonal PC">Non-Clonal PC</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','mm_diagnosis',this)" data-val="Clonal B cells">Clonal B cells</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','mm_diagnosis',this)" data-val="Inconclusive">Inconclusive</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','mm_diagnosis',this)" data-val="Others">Others</div>
              </div>
              <div id="efcm_mm_diagnosis_other_wrap" class="other-input-wrap hidden" style="margin-top:8px;">
                <input type="text" id="efcm_mm_diagnosis_other_text" class="other-input" placeholder="Specify result‚Ä¶">
              </div>
              <input type="hidden" id="efcm_mm_diagnosis_result" value="">
              <textarea class="mob-notes" id="efcm_mm_diagnosis_notes" placeholder="Additional remarks for MM-Diagnosis‚Ä¶" rows="2" style="margin-top:6px;"></textarea>
            </div>
            <div class="panel-result-block" id="efcm_mm_mrd_block">
              <div class="prb-title" style="display:flex;align-items:center;justify-content:space-between;">
                <span>MM-MRD</span>
                <span class="status-badge-inline" id="efcm_mm_mrd_badge"></span>
              </div>
              <div class="mobile-tag-grid" id="efcm_mm_mrd_opts" style="grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:6px;margin-bottom:6px;">
                <div class="mtag result-opt" onclick="selectResult('efcm','mm_mrd',this)" data-val="MRD Negative">MRD Negative</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','mm_mrd',this)" data-val="MRD Positive <0.01%">MRD Positive <0.01%</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','mm_mrd',this)" data-val="MRD Positive 0.01-0.1%">MRD Positive 0.01-0.1%</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','mm_mrd',this)" data-val="MRD Positive >0.1%">MRD Positive >0.1%</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','mm_mrd',this)" data-val="Inconclusive">Inconclusive</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','mm_mrd',this)" data-val="Failed">Failed</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','mm_mrd',this)" data-val="Others">Others</div>
              </div>
              <div id="efcm_mm_mrd_other_wrap" class="other-input-wrap hidden" style="margin-top:8px;">
                <input type="text" id="efcm_mm_mrd_other_text" class="other-input" placeholder="Specify result‚Ä¶">
              </div>
              <input type="hidden" id="efcm_mm_mrd_result" value="">
              <textarea class="mob-notes" id="efcm_mm_mrd_notes" placeholder="Additional remarks for MM-MRD‚Ä¶" rows="2" style="margin-top:6px;"></textarea>
            </div>
            <div class="panel-result-block" id="efcm_b_all_mrd_block">
              <div class="prb-title" style="display:flex;align-items:center;justify-content:space-between;">
                <span>B-ALL-MRD</span>
                <span class="status-badge-inline" id="efcm_b_all_mrd_badge"></span>
              </div>
              <div class="mobile-tag-grid" id="efcm_b_all_mrd_opts" style="grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:6px;margin-bottom:6px;">
                <div class="mtag result-opt" onclick="selectResult('efcm','b_all_mrd',this)" data-val="MRD Negative">MRD Negative</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','b_all_mrd',this)" data-val="MRD Positive <0.01%">MRD Positive <0.01%</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','b_all_mrd',this)" data-val="MRD Positive 0.01-0.1%">MRD Positive 0.01-0.1%</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','b_all_mrd',this)" data-val="MRD Positive >0.1%">MRD Positive >0.1%</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','b_all_mrd',this)" data-val="Inconclusive">Inconclusive</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','b_all_mrd',this)" data-val="Failed">Failed</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','b_all_mrd',this)" data-val="Others">Others</div>
              </div>
              <div id="efcm_b_all_mrd_other_wrap" class="other-input-wrap hidden" style="margin-top:8px;">
                <input type="text" id="efcm_b_all_mrd_other_text" class="other-input" placeholder="Specify result‚Ä¶">
              </div>
              <input type="hidden" id="efcm_b_all_mrd_result" value="">
              <textarea class="mob-notes" id="efcm_b_all_mrd_notes" placeholder="Additional remarks for B-ALL-MRD‚Ä¶" rows="2" style="margin-top:6px;"></textarea>
            </div>
            <div class="panel-result-block" id="efcm_t_all_mrd_block">
              <div class="prb-title" style="display:flex;align-items:center;justify-content:space-between;">
                <span>T-ALL-MRD</span>
                <span class="status-badge-inline" id="efcm_t_all_mrd_badge"></span>
              </div>
              <div class="mobile-tag-grid" id="efcm_t_all_mrd_opts" style="grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:6px;margin-bottom:6px;">
                <div class="mtag result-opt" onclick="selectResult('efcm','t_all_mrd',this)" data-val="MRD Negative">MRD Negative</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','t_all_mrd',this)" data-val="MRD Positive <0.01%">MRD Positive <0.01%</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','t_all_mrd',this)" data-val="MRD Positive 0.01-0.1%">MRD Positive 0.01-0.1%</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','t_all_mrd',this)" data-val="MRD Positive >0.1%">MRD Positive >0.1%</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','t_all_mrd',this)" data-val="Inconclusive">Inconclusive</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','t_all_mrd',this)" data-val="Failed">Failed</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','t_all_mrd',this)" data-val="Others">Others</div>
              </div>
              <div id="efcm_t_all_mrd_other_wrap" class="other-input-wrap hidden" style="margin-top:8px;">
                <input type="text" id="efcm_t_all_mrd_other_text" class="other-input" placeholder="Specify result‚Ä¶">
              </div>
              <input type="hidden" id="efcm_t_all_mrd_result" value="">
              <textarea class="mob-notes" id="efcm_t_all_mrd_notes" placeholder="Additional remarks for T-ALL-MRD‚Ä¶" rows="2" style="margin-top:6px;"></textarea>
            </div>
            <div class="panel-result-block" id="efcm_mds_block">
              <div class="prb-title" style="display:flex;align-items:center;justify-content:space-between;">
                <span>MDS</span>
                <span class="status-badge-inline" id="efcm_mds_badge"></span>
              </div>
              <div class="mobile-tag-grid" id="efcm_mds_opts" style="grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:6px;margin-bottom:6px;">
                <div class="mtag result-opt" onclick="selectResult('efcm','mds',this)" data-val="Normal">Normal</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','mds',this)" data-val="Dysplastic">Dysplastic</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','mds',this)" data-val="Inconclusive">Inconclusive</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','mds',this)" data-val="Failed">Failed</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','mds',this)" data-val="Others">Others</div>
              </div>
              <div id="efcm_mds_other_wrap" class="other-input-wrap hidden" style="margin-top:8px;">
                <input type="text" id="efcm_mds_other_text" class="other-input" placeholder="Specify result‚Ä¶">
              </div>
              <input type="hidden" id="efcm_mds_result" value="">
              <textarea class="mob-notes" id="efcm_mds_notes" placeholder="Additional remarks for MDS‚Ä¶" rows="2" style="margin-top:6px;"></textarea>
            </div>
            <div class="panel-result-block" id="efcm_b_t_tubes_acute_leuk_block">
              <div class="prb-title" style="display:flex;align-items:center;justify-content:space-between;">
                <span>B & T Tubes</span>
                <span class="status-badge-inline" id="efcm_b_t_tubes_acute_leuk_badge"></span>
              </div>
              <div class="mobile-tag-grid" id="efcm_b_t_tubes_acute_leuk_opts" style="grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:6px;margin-bottom:6px;">
                <div class="mtag result-opt" onclick="selectResult('efcm','b_t_tubes_acute_leuk',this)" data-val="Normal">Normal</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','b_t_tubes_acute_leuk',this)" data-val="Clonal T cells">Clonal T cells</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','b_t_tubes_acute_leuk',this)" data-val="Clonal B cells">Clonal B cells</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','b_t_tubes_acute_leuk',this)" data-val="NK-cell neoplasm">NK-cell neoplasm</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','b_t_tubes_acute_leuk',this)" data-val="Inconclusive">Inconclusive</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','b_t_tubes_acute_leuk',this)" data-val="Failed">Failed</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','b_t_tubes_acute_leuk',this)" data-val="Others">Others</div>
              </div>
              <div id="efcm_b_t_tubes_acute_leuk_other_wrap" class="other-input-wrap hidden" style="margin-top:8px;">
                <input type="text" id="efcm_b_t_tubes_acute_leuk_other_text" class="other-input" placeholder="Specify result‚Ä¶">
              </div>
              <input type="hidden" id="efcm_b_t_tubes_acute_leuk_result" value="">
              <textarea class="mob-notes" id="efcm_b_t_tubes_acute_leuk_notes" placeholder="Additional remarks for B & T Tubes‚Ä¶" rows="2" style="margin-top:6px;"></textarea>
            </div>
            <div class="panel-result-block" id="efcm_clpd_mrd_block">
              <div class="prb-title" style="display:flex;align-items:center;justify-content:space-between;">
                <span>CLPD-MRD</span>
                <span class="status-badge-inline" id="efcm_clpd_mrd_badge"></span>
              </div>
              <div class="mobile-tag-grid" id="efcm_clpd_mrd_opts" style="grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:6px;margin-bottom:6px;">
                <div class="mtag result-opt" onclick="selectResult('efcm','clpd_mrd',this)" data-val="MRD Negative">MRD Negative</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','clpd_mrd',this)" data-val="MRD Positive <0.01%">MRD Positive <0.01%</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','clpd_mrd',this)" data-val="MRD Positive 0.01-0.1%">MRD Positive 0.01-0.1%</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','clpd_mrd',this)" data-val="MRD Positive >0.1%">MRD Positive >0.1%</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','clpd_mrd',this)" data-val="Inconclusive">Inconclusive</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','clpd_mrd',this)" data-val="Failed">Failed</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','clpd_mrd',this)" data-val="Others">Others</div>
              </div>
              <div id="efcm_clpd_mrd_other_wrap" class="other-input-wrap hidden" style="margin-top:8px;">
                <input type="text" id="efcm_clpd_mrd_other_text" class="other-input" placeholder="Specify result‚Ä¶">
              </div>
              <input type="hidden" id="efcm_clpd_mrd_result" value="">
              <textarea class="mob-notes" id="efcm_clpd_mrd_notes" placeholder="Additional remarks for CLPD-MRD‚Ä¶" rows="2" style="margin-top:6px;"></textarea>
            </div>
            <div class="panel-result-block" id="efcm_mast_cell_tube_block">
              <div class="prb-title" style="display:flex;align-items:center;justify-content:space-between;">
                <span>Mast Cell</span>
                <span class="status-badge-inline" id="efcm_mast_cell_tube_badge"></span>
              </div>
              <div class="mobile-tag-grid" id="efcm_mast_cell_tube_opts" style="grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:6px;margin-bottom:6px;">
                <div class="mtag result-opt" onclick="selectResult('efcm','mast_cell_tube',this)" data-val="Normal MC">Normal MC</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','mast_cell_tube',this)" data-val="Clonal MC">Clonal MC</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','mast_cell_tube',this)" data-val="Inconclusive">Inconclusive</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','mast_cell_tube',this)" data-val="Failed">Failed</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','mast_cell_tube',this)" data-val="Others">Others</div>
              </div>
              <div id="efcm_mast_cell_tube_other_wrap" class="other-input-wrap hidden" style="margin-top:8px;">
                <input type="text" id="efcm_mast_cell_tube_other_text" class="other-input" placeholder="Specify result‚Ä¶">
              </div>
              <input type="hidden" id="efcm_mast_cell_tube_result" value="">
              <textarea class="mob-notes" id="efcm_mast_cell_tube_notes" placeholder="Additional remarks for Mast Cell‚Ä¶" rows="2" style="margin-top:6px;"></textarea>
            </div>
            <div class="panel-result-block" id="efcm_neuroblastoma_block">
              <div class="prb-title" style="display:flex;align-items:center;justify-content:space-between;">
                <span>Neuroblastoma</span>
                <span class="status-badge-inline" id="efcm_neuroblastoma_badge"></span>
              </div>
              <div class="mobile-tag-grid" id="efcm_neuroblastoma_opts" style="grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:6px;margin-bottom:6px;">
                <div class="mtag result-opt" onclick="selectResult('efcm','neuroblastoma',this)" data-val="Negative">Negative</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','neuroblastoma',this)" data-val="Positive">Positive</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','neuroblastoma',this)" data-val="Inconclusive">Inconclusive</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','neuroblastoma',this)" data-val="Failed">Failed</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','neuroblastoma',this)" data-val="Others">Others</div>
              </div>
              <div id="efcm_neuroblastoma_other_wrap" class="other-input-wrap hidden" style="margin-top:8px;">
                <input type="text" id="efcm_neuroblastoma_other_text" class="other-input" placeholder="Specify result‚Ä¶">
              </div>
              <input type="hidden" id="efcm_neuroblastoma_result" value="">
              <textarea class="mob-notes" id="efcm_neuroblastoma_notes" placeholder="Additional remarks for Neuroblastoma‚Ä¶" rows="2" style="margin-top:6px;"></textarea>
            </div>
            <div class="panel-result-block" id="efcm_other_block">
              <div class="prb-title" style="display:flex;align-items:center;justify-content:space-between;">
                <span>Other</span>
                <span class="status-badge-inline" id="efcm_other_badge"></span>
              </div>
              <div class="mobile-tag-grid" id="efcm_other_opts" style="grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:6px;margin-bottom:6px;">
                <div class="mtag result-opt" onclick="selectResult('efcm','other',this)" data-val="Negative">Negative</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','other',this)" data-val="Positive">Positive</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','other',this)" data-val="Inconclusive">Inconclusive</div>
              <div class="mtag result-opt" onclick="selectResult('efcm','other',this)" data-val="Others">Others</div>
              </div>
              <div id="efcm_other_other_wrap" class="other-input-wrap hidden" style="margin-top:8px;">
                <input type="text" id="efcm_other_other_text" class="other-input" placeholder="Specify result‚Ä¶">
              </div>
              <input type="hidden" id="efcm_other_result" value="">
              <textarea class="mob-notes" id="efcm_other_notes" placeholder="Additional remarks for Other‚Ä¶" rows="2" style="margin-top:6px;"></textarea>
            </div>
            </div>
          </div>
          <textarea class="mob-notes" id="efcm_overall_notes" placeholder="Overall remarks‚Ä¶" style="margin-top:12px;"></textarea>
          <button class="mob-save-btn" onclick="saveEntry('fcm')">üíæ Save FCM Results</button>
        </div>
      </div>
      <div class="sub-panel" id="entry-rtpcr">
        <div class="workflow-block" id="entry_rtpcr_wfblock"></div>
        <div class="cr-lookup">
          <div class="field"><label>CR Number</label>
            <input type="text" id="ertpcr_cr" placeholder="CR-2024-0001" onkeydown="if(event.key==='Enter')loadForEntry('rtpcr')">
          </div>
          <button class="lookup-btn" onclick="loadForEntry('rtpcr')">üîç Load</button>
        </div>
        <div id="ertpcr_wrap" class="hidden">
          <div class="patient-card" id="ertpcr_pc"></div>
          <div class="ordered-summary" id="ertpcr_ordered"></div>
          <div class="order-block" style="margin-top:14px;">
            <div class="order-block-title">Results per Panel</div>
            <p style="font-size:11px;color:var(--slate);margin-bottom:12px;">Status from Test Acceptance shown on each panel.</p>
            <div id="ertpcr_panels">
            <div class="panel-result-block" id="ertpcr_acute_leukemia_panel_block">
              <div class="prb-title" style="display:flex;align-items:center;justify-content:space-between;">
                <span>Acute Leukemia Panel</span>
                <span class="status-badge-inline" id="ertpcr_acute_leukemia_panel_badge"></span>
              </div>
              <div class="mobile-tag-grid" id="ertpcr_acute_leukemia_panel_opts" style="grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:6px;margin-bottom:6px;">
                <div class="mtag result-opt" onclick="selectResult('ertpcr','acute_leukemia_panel',this)" data-val="Negative for BCR-ABL1">Negative for BCR-ABL1</div>
              <div class="mtag result-opt" onclick="selectResult('ertpcr','acute_leukemia_panel',this)" data-val="Negative for PML-RARA">Negative for PML-RARA</div>
              <div class="mtag result-opt" onclick="selectResult('ertpcr','acute_leukemia_panel',this)" data-val="Negative for AML-fusions">Negative for AML-fusions</div>
              <div class="mtag result-opt" onclick="selectResult('ertpcr','acute_leukemia_panel',this)" data-val="Negative for NPM1">Negative for NPM1</div>
              <div class="mtag result-opt" onclick="selectResult('ertpcr','acute_leukemia_panel',this)" data-val="Negative for FLT3-ITD">Negative for FLT3-ITD</div>
              <div class="mtag result-opt" onclick="selectResult('ertpcr','acute_leukemia_panel',this)" data-val="Negative for FLT3-TKD">Negative for FLT3-TKD</div>
              <div class="mtag result-opt" onclick="selectResult('ertpcr','acute_leukemia_panel',this)" data-val="BCR-ABL1 p190">BCR-ABL1 p190</div>
              <div class="mtag result-opt" onclick="selectResult('ertpcr','acute_leukemia_panel',this)" data-val="BCR-ABL1 p210">BCR-ABL1 p210</div>
              <div class="mtag result-opt" onclick="selectResult('ertpcr','acute_leukemia_panel',this)" data-val="BCR-ABL1 p230">BCR-ABL1 p230</div>
              <div class="mtag result-opt" onclick="selectResult('ertpcr','acute_leukemia_panel',this)" data-val="PML-RARA">PML-RARA</div>
              <div class="mtag result-opt" onclick="selectResult('ertpcr','acute_leukemia_panel',this)" data-val="RUNX1-RUNX1T1">RUNX1-RUNX1T1</div>
              <div class="mtag result-opt" onclick="selectResult('ertpcr','acute_leukemia_panel',this)" data-val="CBFB-MYH11">CBFB-MYH11</div>
              <div class="mtag result-opt" onclick="selectResult('ertpcr','acute_leukemia_panel',this)" data-val="KMT2A-r">KMT2A-r</div>
              <div class="mtag result-opt" onclick="selectResult('ertpcr','acute_leukemia_panel',this)" data-val="NPM1mut">NPM1mut</div>
              <div class="mtag result-opt" onclick="selectResult('ertpcr','acute_leukemia_panel',this)" data-val="FLT3-ITD">FLT3-ITD</div>
              <div class="mtag result-opt" onclick="selectResult('ertpcr','acute_leukemia_panel',this)" data-val="FLT3-TKD">FLT3-TKD</div>
              <div class="mtag result-opt" onclick="selectResult('ertpcr','acute_leukemia_panel',this)" data-val="Failed">Failed</div>
              <div class="mtag result-opt" onclick="selectResult('ertpcr','acute_leukemia_panel',this)" data-val="Others">Others</div>
              </div>
              <div id="ertpcr_acute_leukemia_panel_other_wrap" class="other-input-wrap hidden" style="margin-top:8px;">
                <input type="text" id="ertpcr_acute_leukemia_panel_other_text" class="other-input" placeholder="Specify result‚Ä¶">
              </div>
              <input type="hidden" id="ertpcr_acute_leukemia_panel_result" value="">
              <textarea class="mob-notes" id="ertpcr_acute_leukemia_panel_notes" placeholder="Additional remarks for RT-PCR Acute Panel‚Ä¶" rows="2" style="margin-top:6px;"></textarea>
            </div>
            <div class="panel-result-block" id="ertpcr_bcr_abl1_block">
              <div class="prb-title" style="display:flex;align-items:center;justify-content:space-between;">
                <span>BCR-ABL1</span>
                <span class="status-badge-inline" id="ertpcr_bcr_abl1_badge"></span>
              </div>
              <div class="mobile-tag-grid" id="ertpcr_bcr_abl1_opts" style="grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:6px;margin-bottom:6px;">
                <div class="mtag result-opt" onclick="selectResult('ertpcr','bcr_abl1',this)" data-val="Negative">Negative</div>
              <div class="mtag result-opt" onclick="selectResult('ertpcr','bcr_abl1',this)" data-val="BCR-ABL1 p190 Positive">BCR-ABL1 p190 Positive</div>
              <div class="mtag result-opt" onclick="selectResult('ertpcr','bcr_abl1',this)" data-val="BCR-ABL1 p210 Positive">BCR-ABL1 p210 Positive</div>
              <div class="mtag result-opt" onclick="selectResult('ertpcr','bcr_abl1',this)" data-val="BCR-ABL1 p230 Positive">BCR-ABL1 p230 Positive</div>
              <div class="mtag result-opt" onclick="selectResult('ertpcr','bcr_abl1',this)" data-val="Failed">Failed</div>
              <div class="mtag result-opt" onclick="selectResult('ertpcr','bcr_abl1',this)" data-val="Others">Others</div>
              </div>
              <div id="ertpcr_bcr_abl1_other_wrap" class="other-input-wrap hidden" style="margin-top:8px;">
                <input type="text" id="ertpcr_bcr_abl1_other_text" class="other-input" placeholder="Specify result‚Ä¶">
              </div>
              <input type="hidden" id="ertpcr_bcr_abl1_result" value="">
              <textarea class="mob-notes" id="ertpcr_bcr_abl1_notes" placeholder="Additional remarks for BCR-ABL1‚Ä¶" rows="2" style="margin-top:6px;"></textarea>
            </div>
            <div class="panel-result-block" id="ertpcr_jak2_block">
              <div class="prb-title" style="display:flex;align-items:center;justify-content:space-between;">
                <span>JAK2</span>
                <span class="status-badge-inline" id="ertpcr_jak2_badge"></span>
              </div>
              <div class="mobile-tag-grid" id="ertpcr_jak2_opts" style="grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:6px;margin-bottom:6px;">
                <div class="mtag result-opt" onclick="selectResult('ertpcr','jak2',this)" data-val="Negative">Negative</div>
              <div class="mtag result-opt" onclick="selectResult('ertpcr','jak2',this)" data-val="JAK2 V617F Positive">JAK2 V617F Positive</div>
              <div class="mtag result-opt" onclick="selectResult('ertpcr','jak2',this)" data-val="Failed">Failed</div>
              </div>
              <input type="hidden" id="ertpcr_jak2_result" value="">
              <textarea class="mob-notes" id="ertpcr_jak2_notes" placeholder="Additional remarks for JAK2‚Ä¶" rows="2" style="margin-top:6px;"></textarea>
            </div>
            <div class="panel-result-block" id="ertpcr_cml_mpn_panel_block">
              <div class="prb-title" style="display:flex;align-items:center;justify-content:space-between;">
                <span>CML/MPN Panel</span>
                <span class="status-badge-inline" id="ertpcr_cml_mpn_panel_badge"></span>
              </div>
              <div class="mobile-tag-grid" id="ertpcr_cml_mpn_panel_opts" style="grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:6px;margin-bottom:6px;">
                <div class="mtag result-opt" onclick="selectResult('ertpcr','cml_mpn_panel',this)" data-val="Negative for BCR-ABL1">Negative for BCR-ABL1</div>
              <div class="mtag result-opt" onclick="selectResult('ertpcr','cml_mpn_panel',this)" data-val="Negative for CALR">Negative for CALR</div>
              <div class="mtag result-opt" onclick="selectResult('ertpcr','cml_mpn_panel',this)" data-val="Negative for MPL">Negative for MPL</div>
              <div class="mtag result-opt" onclick="selectResult('ertpcr','cml_mpn_panel',this)" data-val="Negative for JAK2">Negative for JAK2</div>
              <div class="mtag result-opt" onclick="selectResult('ertpcr','cml_mpn_panel',this)" data-val="JAK2 V617F Positive">JAK2 V617F Positive</div>
              <div class="mtag result-opt" onclick="selectResult('ertpcr','cml_mpn_panel',this)" data-val="CALR Positive">CALR Positive</div>
              <div class="mtag result-opt" onclick="selectResult('ertpcr','cml_mpn_panel',this)" data-val="MPL Positive">MPL Positive</div>
              <div class="mtag result-opt" onclick="selectResult('ertpcr','cml_mpn_panel',this)" data-val="BCR-ABL1 Positive">BCR-ABL1 Positive</div>
              <div class="mtag result-opt" onclick="selectResult('ertpcr','cml_mpn_panel',this)" data-val="Failed">Failed</div>
              <div class="mtag result-opt" onclick="selectResult('ertpcr','cml_mpn_panel',this)" data-val="Others">Others</div>
              </div>
              <div id="ertpcr_cml_mpn_panel_other_wrap" class="other-input-wrap hidden" style="margin-top:8px;">
                <input type="text" id="ertpcr_cml_mpn_panel_other_text" class="other-input" placeholder="Specify result‚Ä¶">
              </div>
              <input type="hidden" id="ertpcr_cml_mpn_panel_result" value="">
              <textarea class="mob-notes" id="ertpcr_cml_mpn_panel_notes" placeholder="Additional remarks for CML/MPN Panel‚Ä¶" rows="2" style="margin-top:6px;"></textarea>
            </div>
            <div class="panel-result-block" id="ertpcr_myd88_block">
              <div class="prb-title" style="display:flex;align-items:center;justify-content:space-between;">
                <span>MYD88</span>
                <span class="status-badge-inline" id="ertpcr_myd88_badge"></span>
              </div>
              <div class="mobile-tag-grid" id="ertpcr_myd88_opts" style="grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:6px;margin-bottom:6px;">
                <div class="mtag result-opt" onclick="selectResult('ertpcr','myd88',this)" data-val="Negative">Negative</div>
              <div class="mtag result-opt" onclick="selectResult('ertpcr','myd88',this)" data-val="MYD88 L265P Positive">MYD88 L265P Positive</div>
              <div class="mtag result-opt" onclick="selectResult('ertpcr','myd88',this)" data-val="Failed">Failed</div>
              </div>
              <input type="hidden" id="ertpcr_myd88_result" value="">
              <textarea class="mob-notes" id="ertpcr_myd88_notes" placeholder="Additional remarks for MYD88‚Ä¶" rows="2" style="margin-top:6px;"></textarea>
            </div>
            <div class="panel-result-block" id="ertpcr_braf_block">
              <div class="prb-title" style="display:flex;align-items:center;justify-content:space-between;">
                <span>BRAF</span>
                <span class="status-badge-inline" id="ertpcr_braf_badge"></span>
              </div>
              <div class="mobile-tag-grid" id="ertpcr_braf_opts" style="grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:6px;margin-bottom:6px;">
                <div class="mtag result-opt" onclick="selectResult('ertpcr','braf',this)" data-val="Negative">Negative</div>
              <div class="mtag result-opt" onclick="selectResult('ertpcr','braf',this)" data-val="BRAF V600E Positive">BRAF V600E Positive</div>
              <div class="mtag result-opt" onclick="selectResult('ertpcr','braf',this)" data-val="Failed">Failed</div>
              </div>
              <input type="hidden" id="ertpcr_braf_result" value="">
              <textarea class="mob-notes" id="ertpcr_braf_notes" placeholder="Additional remarks for BRAF‚Ä¶" rows="2" style="margin-top:6px;"></textarea>
            </div>
            <div class="panel-result-block" id="ertpcr_ddpcr_mrd_block">
              <div class="prb-title" style="display:flex;align-items:center;justify-content:space-between;">
                <span>ddPCR-MRD</span>
                <span class="status-badge-inline" id="ertpcr_ddpcr_mrd_badge"></span>
              </div>
              <div class="mobile-tag-grid" id="ertpcr_ddpcr_mrd_opts" style="grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:6px;margin-bottom:6px;">
                <div class="mtag result-opt" onclick="selectResult('ertpcr','ddpcr_mrd',this)" data-val="Negative">Negative</div>
              <div class="mtag result-opt" onclick="selectResult('ertpcr','ddpcr_mrd',this)" data-val="Positive">Positive</div>
              <div class="mtag result-opt" onclick="selectResult('ertpcr','ddpcr_mrd',this)" data-val="Failed">Failed</div>
              </div>
              <input type="hidden" id="ertpcr_ddpcr_mrd_result" value="">
              <textarea class="mob-notes" id="ertpcr_ddpcr_mrd_notes" placeholder="Additional remarks for ddPCR-MRD‚Ä¶" rows="2" style="margin-top:6px;"></textarea>
            </div>
            <div class="panel-result-block" id="ertpcr_qpcr_mrd_block">
              <div class="prb-title" style="display:flex;align-items:center;justify-content:space-between;">
                <span>qPCR-MRD</span>
                <span class="status-badge-inline" id="ertpcr_qpcr_mrd_badge"></span>
              </div>
              <div class="mobile-tag-grid" id="ertpcr_qpcr_mrd_opts" style="grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:6px;margin-bottom:6px;">
                <div class="mtag result-opt" onclick="selectResult('ertpcr','qpcr_mrd',this)" data-val="Negative">Negative</div>
              <div class="mtag result-opt" onclick="selectResult('ertpcr','qpcr_mrd',this)" data-val="Positive">Positive</div>
              <div class="mtag result-opt" onclick="selectResult('ertpcr','qpcr_mrd',this)" data-val="Failed">Failed</div>
              </div>
              <input type="hidden" id="ertpcr_qpcr_mrd_result" value="">
              <textarea class="mob-notes" id="ertpcr_qpcr_mrd_notes" placeholder="Additional remarks for qPCR-MRD‚Ä¶" rows="2" style="margin-top:6px;"></textarea>
            </div>
            <div class="panel-result-block" id="ertpcr_other_block">
              <div class="prb-title" style="display:flex;align-items:center;justify-content:space-between;">
                <span>Other</span>
                <span class="status-badge-inline" id="ertpcr_other_badge"></span>
              </div>
              <div class="mobile-tag-grid" id="ertpcr_other_opts" style="grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:6px;margin-bottom:6px;">
                <div class="mtag result-opt" onclick="selectResult('ertpcr','other',this)" data-val="Negative">Negative</div>
              <div class="mtag result-opt" onclick="selectResult('ertpcr','other',this)" data-val="Positive">Positive</div>
              <div class="mtag result-opt" onclick="selectResult('ertpcr','other',this)" data-val="Failed">Failed</div>
              </div>
              <input type="hidden" id="ertpcr_other_result" value="">
              <textarea class="mob-notes" id="ertpcr_other_notes" placeholder="Additional remarks for Other‚Ä¶" rows="2" style="margin-top:6px;"></textarea>
            </div>
            </div>
          </div>
          <textarea class="mob-notes" id="ertpcr_overall_notes" placeholder="Overall remarks‚Ä¶" style="margin-top:12px;"></textarea>
          <button class="mob-save-btn" onclick="saveEntry('rtpcr')">üíæ Save RT-PCR Results</button>
        </div>
      </div>
      <div class="sub-panel" id="entry-ngsh12">
        <div class="workflow-block" id="entry_ngsh12_wfblock"></div>
        <div class="cr-lookup">
          <div class="field"><label>CR Number</label>
            <input type="text" id="engsh12_cr" placeholder="CR-2024-0001" onkeydown="if(event.key==='Enter')loadForEntry('ngsh12')">
          </div>
          <button class="lookup-btn" onclick="loadForEntry('ngsh12')">üîç Load</button>
        </div>
        <div id="engsh12_wrap" class="hidden">
          <div class="patient-card" id="engsh12_pc"></div>
          <div class="ordered-summary" id="engsh12_ordered"></div>
          <div class="order-block" style="margin-top:14px;">
            <div class="order-block-title">Results per Panel</div>
            <p style="font-size:11px;color:var(--slate);margin-bottom:12px;">Status from Test Acceptance shown on each panel.</p>
            <div id="engsh12_panels">
            <div class="panel-result-block" id="engsh12_myeloid_mutation_panel_block">
              <div class="prb-title" style="display:flex;align-items:center;justify-content:space-between;">
                <span>Myeloid Mutation Panel</span>
                <span class="status-badge-inline" id="engsh12_myeloid_mutation_panel_badge"></span>
              </div>
              <div class="mobile-tag-grid" id="engsh12_myeloid_mutation_panel_opts" style="grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:6px;margin-bottom:6px;">
                <div class="mtag result-opt" onclick="selectResult('engsh12','myeloid_mutation_panel',this)" data-val="No mutation detected">No mutation detected</div>
              <div class="mtag result-opt" onclick="selectResult('engsh12','myeloid_mutation_panel',this)" data-val="Mutation detected">Mutation detected</div>
              <div class="mtag result-opt" onclick="selectResult('engsh12','myeloid_mutation_panel',this)" data-val="VUS detected">VUS detected</div>
              <div class="mtag result-opt" onclick="selectResult('engsh12','myeloid_mutation_panel',this)" data-val="Inconclusive">Inconclusive</div>
              </div>
              <input type="hidden" id="engsh12_myeloid_mutation_panel_result" value="">
              <textarea class="mob-notes" id="engsh12_myeloid_mutation_panel_notes" placeholder="Additional remarks for Myeloid Mutation Panel‚Ä¶" rows="2" style="margin-top:6px;"></textarea>
            </div>
            <div class="panel-result-block" id="engsh12_lymphoid_mutation_panel_block">
              <div class="prb-title" style="display:flex;align-items:center;justify-content:space-between;">
                <span>Lymphoid Mutation Panel</span>
                <span class="status-badge-inline" id="engsh12_lymphoid_mutation_panel_badge"></span>
              </div>
              <div class="mobile-tag-grid" id="engsh12_lymphoid_mutation_panel_opts" style="grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:6px;margin-bottom:6px;">
                <div class="mtag result-opt" onclick="selectResult('engsh12','lymphoid_mutation_panel',this)" data-val="No mutation detected">No mutation detected</div>
              <div class="mtag result-opt" onclick="selectResult('engsh12','lymphoid_mutation_panel',this)" data-val="Mutation detected">Mutation detected</div>
              <div class="mtag result-opt" onclick="selectResult('engsh12','lymphoid_mutation_panel',this)" data-val="VUS detected">VUS detected</div>
              <div class="mtag result-opt" onclick="selectResult('engsh12','lymphoid_mutation_panel',this)" data-val="Inconclusive">Inconclusive</div>
              </div>
              <input type="hidden" id="engsh12_lymphoid_mutation_panel_result" value="">
              <textarea class="mob-notes" id="engsh12_lymphoid_mutation_panel_notes" placeholder="Additional remarks for Lymphoid Mutation Panel‚Ä¶" rows="2" style="margin-top:6px;"></textarea>
            </div>
            <div class="panel-result-block" id="engsh12_tp53_only_block">
              <div class="prb-title" style="display:flex;align-items:center;justify-content:space-between;">
                <span>TP53 Only</span>
                <span class="status-badge-inline" id="engsh12_tp53_only_badge"></span>
              </div>
              <div class="mobile-tag-grid" id="engsh12_tp53_only_opts" style="grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:6px;margin-bottom:6px;">
                <div class="mtag result-opt" onclick="selectResult('engsh12','tp53_only',this)" data-val="TP53 Wild Type">TP53 Wild Type</div>
              <div class="mtag result-opt" onclick="selectResult('engsh12','tp53_only',this)" data-val="TP53 Mutated">TP53 Mutated</div>
              <div class="mtag result-opt" onclick="selectResult('engsh12','tp53_only',this)" data-val="Biallelic TP53">Biallelic TP53</div>
              <div class="mtag result-opt" onclick="selectResult('engsh12','tp53_only',this)" data-val="VUS">VUS</div>
              <div class="mtag result-opt" onclick="selectResult('engsh12','tp53_only',this)" data-val="Inconclusive">Inconclusive</div>
              </div>
              <input type="hidden" id="engsh12_tp53_only_result" value="">
              <textarea class="mob-notes" id="engsh12_tp53_only_notes" placeholder="Additional remarks for TP53 Only‚Ä¶" rows="2" style="margin-top:6px;"></textarea>
            </div>
            <div class="panel-result-block" id="engsh12_other_block">
              <div class="prb-title" style="display:flex;align-items:center;justify-content:space-between;">
                <span>Other</span>
                <span class="status-badge-inline" id="engsh12_other_badge"></span>
              </div>
              <div class="mobile-tag-grid" id="engsh12_other_opts" style="grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:6px;margin-bottom:6px;">
                <div class="mtag result-opt" onclick="selectResult('engsh12','other',this)" data-val="No mutation detected">No mutation detected</div>
              <div class="mtag result-opt" onclick="selectResult('engsh12','other',this)" data-val="Mutation detected">Mutation detected</div>
              <div class="mtag result-opt" onclick="selectResult('engsh12','other',this)" data-val="VUS detected">VUS detected</div>
              <div class="mtag result-opt" onclick="selectResult('engsh12','other',this)" data-val="Inconclusive">Inconclusive</div>
              </div>
              <input type="hidden" id="engsh12_other_result" value="">
              <textarea class="mob-notes" id="engsh12_other_notes" placeholder="Additional remarks for Other‚Ä¶" rows="2" style="margin-top:6px;"></textarea>
            </div>
            </div>
          </div>
          <textarea class="mob-notes" id="engsh12_overall_notes" placeholder="Overall remarks‚Ä¶" style="margin-top:12px;"></textarea>
          <button class="mob-save-btn" onclick="saveEntry('ngsh12')">üíæ Save NGS-H12 Results</button>
        </div>
      </div>
      <div class="sub-panel" id="entry-ngsh9">
        <div class="workflow-block" id="entry_ngsh9_wfblock"></div>
        <div class="cr-lookup">
          <div class="field"><label>CR Number</label>
            <input type="text" id="engsh9_cr" placeholder="CR-2024-0001" onkeydown="if(event.key==='Enter')loadForEntry('ngsh9')">
          </div>
          <button class="lookup-btn" onclick="loadForEntry('ngsh9')">üîç Load</button>
        </div>
        <div id="engsh9_wrap" class="hidden">
          <div class="patient-card" id="engsh9_pc"></div>
          <div class="ordered-summary" id="engsh9_ordered"></div>
          <div class="order-block" style="margin-top:14px;">
            <div class="order-block-title">Results per Panel</div>
            <p style="font-size:11px;color:var(--slate);margin-bottom:12px;">Status from Test Acceptance shown on each panel.</p>
            <div id="engsh9_panels">
            <div class="panel-result-block" id="engsh9_rna_fusion_panel_block">
              <div class="prb-title" style="display:flex;align-items:center;justify-content:space-between;">
                <span>RNA Fusion Panel</span>
                <span class="status-badge-inline" id="engsh9_rna_fusion_panel_badge"></span>
              </div>
              <div class="mobile-tag-grid" id="engsh9_rna_fusion_panel_opts" style="grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:6px;margin-bottom:6px;">
                <div class="mtag result-opt" onclick="selectResult('engsh9','rna_fusion_panel',this)" data-val="No fusion detected">No fusion detected</div>
              <div class="mtag result-opt" onclick="selectResult('engsh9','rna_fusion_panel',this)" data-val="Fusion detected">Fusion detected</div>
              <div class="mtag result-opt" onclick="selectResult('engsh9','rna_fusion_panel',this)" data-val="Inconclusive">Inconclusive</div>
              </div>
              <input type="hidden" id="engsh9_rna_fusion_panel_result" value="">
              <textarea class="mob-notes" id="engsh9_rna_fusion_panel_notes" placeholder="Additional remarks for RNA Fusion Panel‚Ä¶" rows="2" style="margin-top:6px;"></textarea>
            </div>
            <div class="panel-result-block" id="engsh9_ibmfs_panel_block">
              <div class="prb-title" style="display:flex;align-items:center;justify-content:space-between;">
                <span>IBMFS Panel</span>
                <span class="status-badge-inline" id="engsh9_ibmfs_panel_badge"></span>
              </div>
              <div class="mobile-tag-grid" id="engsh9_ibmfs_panel_opts" style="grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:6px;margin-bottom:6px;">
                <div class="mtag result-opt" onclick="selectResult('engsh9','ibmfs_panel',this)" data-val="No mutation detected">No mutation detected</div>
              <div class="mtag result-opt" onclick="selectResult('engsh9','ibmfs_panel',this)" data-val="Mutation detected">Mutation detected</div>
              <div class="mtag result-opt" onclick="selectResult('engsh9','ibmfs_panel',this)" data-val="VUS detected">VUS detected</div>
              <div class="mtag result-opt" onclick="selectResult('engsh9','ibmfs_panel',this)" data-val="Inconclusive">Inconclusive</div>
              </div>
              <input type="hidden" id="engsh9_ibmfs_panel_result" value="">
              <textarea class="mob-notes" id="engsh9_ibmfs_panel_notes" placeholder="Additional remarks for IBMFS Panel‚Ä¶" rows="2" style="margin-top:6px;"></textarea>
            </div>
            <div class="panel-result-block" id="engsh9_wes_with_cnv_block">
              <div class="prb-title" style="display:flex;align-items:center;justify-content:space-between;">
                <span>WES with CNV</span>
                <span class="status-badge-inline" id="engsh9_wes_with_cnv_badge"></span>
              </div>
              <div class="mobile-tag-grid" id="engsh9_wes_with_cnv_opts" style="grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:6px;margin-bottom:6px;">
                <div class="mtag result-opt" onclick="selectResult('engsh9','wes_with_cnv',this)" data-val="No CNV detected">No CNV detected</div>
              <div class="mtag result-opt" onclick="selectResult('engsh9','wes_with_cnv',this)" data-val="CNV detected">CNV detected</div>
              <div class="mtag result-opt" onclick="selectResult('engsh9','wes_with_cnv',this)" data-val="No mutation detected">No mutation detected</div>
              <div class="mtag result-opt" onclick="selectResult('engsh9','wes_with_cnv',this)" data-val="Mutation detected">Mutation detected</div>
              <div class="mtag result-opt" onclick="selectResult('engsh9','wes_with_cnv',this)" data-val="VUS detected">VUS detected</div>
              <div class="mtag result-opt" onclick="selectResult('engsh9','wes_with_cnv',this)" data-val="Inconclusive">Inconclusive</div>
              </div>
              <input type="hidden" id="engsh9_wes_with_cnv_result" value="">
              <textarea class="mob-notes" id="engsh9_wes_with_cnv_notes" placeholder="Additional remarks for WES with CNV‚Ä¶" rows="2" style="margin-top:6px;"></textarea>
            </div>
            <div class="panel-result-block" id="engsh9_tcr_by_ngs_block">
              <div class="prb-title" style="display:flex;align-items:center;justify-content:space-between;">
                <span>TCR by NGS</span>
                <span class="status-badge-inline" id="engsh9_tcr_by_ngs_badge"></span>
              </div>
              <div class="mobile-tag-grid" id="engsh9_tcr_by_ngs_opts" style="grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:6px;margin-bottom:6px;">
                <div class="mtag result-opt" onclick="selectResult('engsh9','tcr_by_ngs',this)" data-val="Clonal">Clonal</div>
              <div class="mtag result-opt" onclick="selectResult('engsh9','tcr_by_ngs',this)" data-val="Polyclonal">Polyclonal</div>
              <div class="mtag result-opt" onclick="selectResult('engsh9','tcr_by_ngs',this)" data-val="Inconclusive">Inconclusive</div>
              </div>
              <input type="hidden" id="engsh9_tcr_by_ngs_result" value="">
              <textarea class="mob-notes" id="engsh9_tcr_by_ngs_notes" placeholder="Additional remarks for TCR by NGS‚Ä¶" rows="2" style="margin-top:6px;"></textarea>
            </div>
            <div class="panel-result-block" id="engsh9_t_all_somatic_block">
              <div class="prb-title" style="display:flex;align-items:center;justify-content:space-between;">
                <span>T-ALL Somatic</span>
                <span class="status-badge-inline" id="engsh9_t_all_somatic_badge"></span>
              </div>
              <div class="mobile-tag-grid" id="engsh9_t_all_somatic_opts" style="grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:6px;margin-bottom:6px;">
                <div class="mtag result-opt" onclick="selectResult('engsh9','t_all_somatic',this)" data-val="No mutation detected">No mutation detected</div>
              <div class="mtag result-opt" onclick="selectResult('engsh9','t_all_somatic',this)" data-val="Mutation detected">Mutation detected</div>
              <div class="mtag result-opt" onclick="selectResult('engsh9','t_all_somatic',this)" data-val="VUS detected">VUS detected</div>
              <div class="mtag result-opt" onclick="selectResult('engsh9','t_all_somatic',this)" data-val="Inconclusive">Inconclusive</div>
              </div>
              <input type="hidden" id="engsh9_t_all_somatic_result" value="">
              <textarea class="mob-notes" id="engsh9_t_all_somatic_notes" placeholder="Additional remarks for T-ALL Somatic‚Ä¶" rows="2" style="margin-top:6px;"></textarea>
            </div>
            <div class="panel-result-block" id="engsh9_other_block">
              <div class="prb-title" style="display:flex;align-items:center;justify-content:space-between;">
                <span>Other</span>
                <span class="status-badge-inline" id="engsh9_other_badge"></span>
              </div>
              <div class="mobile-tag-grid" id="engsh9_other_opts" style="grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:6px;margin-bottom:6px;">
                <div class="mtag result-opt" onclick="selectResult('engsh9','other',this)" data-val="No mutation detected">No mutation detected</div>
              <div class="mtag result-opt" onclick="selectResult('engsh9','other',this)" data-val="Mutation detected">Mutation detected</div>
              <div class="mtag result-opt" onclick="selectResult('engsh9','other',this)" data-val="Inconclusive">Inconclusive</div>
              </div>
              <input type="hidden" id="engsh9_other_result" value="">
              <textarea class="mob-notes" id="engsh9_other_notes" placeholder="Additional remarks for Other‚Ä¶" rows="2" style="margin-top:6px;"></textarea>
            </div>
            </div>
          </div>
          <textarea class="mob-notes" id="engsh9_overall_notes" placeholder="Overall remarks‚Ä¶" style="margin-top:12px;"></textarea>
          <button class="mob-save-btn" onclick="saveEntry('ngsh9')">üíæ Save NGS-H9 Results</button>
        </div>
      </div>
      <div class="sub-panel" id="entry-tcr">
        <div class="workflow-block" id="entry_tcr_wfblock"></div>
        <div class="cr-lookup">
          <div class="field"><label>CR Number</label>
            <input type="text" id="etcr_cr" placeholder="CR-2024-0001" onkeydown="if(event.key==='Enter')loadForEntry('tcr')">
          </div>
          <button class="lookup-btn" onclick="loadForEntry('tcr')">üîç Load</button>
        </div>
        <div id="etcr_wrap" class="hidden">
          <div class="patient-card" id="etcr_pc"></div>
          <div class="ordered-summary" id="etcr_ordered"></div>
          <div class="order-block" style="margin-top:14px;">
            <div class="order-block-title">Results per Panel</div>
            <p style="font-size:11px;color:var(--slate);margin-bottom:12px;">Status from Test Acceptance shown on each panel.</p>
            <div id="etcr_panels">
            <div class="panel-result-block" id="etcr_tcr_beta_block">
              <div class="prb-title" style="display:flex;align-items:center;justify-content:space-between;">
                <span>TCR Beta</span>
                <span class="status-badge-inline" id="etcr_tcr_beta_badge"></span>
              </div>
              <div class="mobile-tag-grid" id="etcr_tcr_beta_opts" style="grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:6px;margin-bottom:6px;">
                <div class="mtag result-opt" onclick="selectResult('etcr','tcr_beta',this)" data-val="Clonal">Clonal</div>
              <div class="mtag result-opt" onclick="selectResult('etcr','tcr_beta',this)" data-val="Polyclonal">Polyclonal</div>
              <div class="mtag result-opt" onclick="selectResult('etcr','tcr_beta',this)" data-val="Inconclusive">Inconclusive</div>
              </div>
              <input type="hidden" id="etcr_tcr_beta_result" value="">
              <textarea class="mob-notes" id="etcr_tcr_beta_notes" placeholder="Additional remarks for TCR Beta‚Ä¶" rows="2" style="margin-top:6px;"></textarea>
            </div>
            <div class="panel-result-block" id="etcr_tcr_gamma_block">
              <div class="prb-title" style="display:flex;align-items:center;justify-content:space-between;">
                <span>TCR Gamma</span>
                <span class="status-badge-inline" id="etcr_tcr_gamma_badge"></span>
              </div>
              <div class="mobile-tag-grid" id="etcr_tcr_gamma_opts" style="grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:6px;margin-bottom:6px;">
                <div class="mtag result-opt" onclick="selectResult('etcr','tcr_gamma',this)" data-val="Clonal">Clonal</div>
              <div class="mtag result-opt" onclick="selectResult('etcr','tcr_gamma',this)" data-val="Polyclonal">Polyclonal</div>
              <div class="mtag result-opt" onclick="selectResult('etcr','tcr_gamma',this)" data-val="Inconclusive">Inconclusive</div>
              </div>
              <input type="hidden" id="etcr_tcr_gamma_result" value="">
              <textarea class="mob-notes" id="etcr_tcr_gamma_notes" placeholder="Additional remarks for TCR Gamma‚Ä¶" rows="2" style="margin-top:6px;"></textarea>
            </div>
            <div class="panel-result-block" id="etcr_other_block">
              <div class="prb-title" style="display:flex;align-items:center;justify-content:space-between;">
                <span>Other</span>
                <span class="status-badge-inline" id="etcr_other_badge"></span>
              </div>
              <div class="mobile-tag-grid" id="etcr_other_opts" style="grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:6px;margin-bottom:6px;">
                <div class="mtag result-opt" onclick="selectResult('etcr','other',this)" data-val="Clonal">Clonal</div>
              <div class="mtag result-opt" onclick="selectResult('etcr','other',this)" data-val="Polyclonal">Polyclonal</div>
              <div class="mtag result-opt" onclick="selectResult('etcr','other',this)" data-val="Inconclusive">Inconclusive</div>
              </div>
              <input type="hidden" id="etcr_other_result" value="">
              <textarea class="mob-notes" id="etcr_other_notes" placeholder="Additional remarks for Other‚Ä¶" rows="2" style="margin-top:6px;"></textarea>
            </div>
            </div>
          </div>
          <textarea class="mob-notes" id="etcr_overall_notes" placeholder="Overall remarks‚Ä¶" style="margin-top:12px;"></textarea>
          <button class="mob-save-btn" onclick="saveEntry('tcr')">üíæ Save TCR Results</button>
        </div>
      </div>
    </div>
  </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODULE 05: INTEGRATED REPORT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div id="screen-report" class="panel">
    <div class="panel-header">
      <button class="back-btn" onclick="showScreen('screen-home')">‚Üê Back</button>
      <h2>Integrated Report</h2>
      <span class="step-badge">Module 06</span>
    </div>
    <div class="panel-body">

      <div class="cr-lookup">
        <div class="field">
          <label>CR Number</label>
          <input type="text" id="rpt_cr" placeholder="e.g. 202600012345"
            inputmode="numeric" maxlength="12"
            onkeydown="if(event.key==='Enter')loadReport()">
        </div>
        <button class="lookup-btn" onclick="loadReport()">üîç Load Patient</button>
      </div>

      <div id="rpt_content" class="hidden">
        <div class="patient-card" id="rpt_patient_card" style="margin-bottom:16px;"></div>

        <div style="background:#f0f4ff;border:1.5px solid #1a3a6a;border-radius:12px;padding:18px 16px;text-align:center;">
          <div style="font-size:28px;margin-bottom:8px;">üìÑ</div>
          <div style="font-family:var(--mono);font-size:13px;font-weight:700;color:#1a3a6a;margin-bottom:4px;">PRISM Integrated Report</div>
          <div style="font-size:11px;color:#888;margin-bottom:16px;">Includes BM Morphology + all ancillary results</div>
          <button onclick="downloadTxt()" style="background:#1a3a6a;color:white;border:none;border-radius:10px;padding:13px 28px;font-family:var(--mono);font-size:14px;font-weight:700;cursor:pointer;letter-spacing:0.06em;">
            ‚¨á Download .txt Report
          </button>
        </div>
      </div>

    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODULE 07: PROVISIONAL BM REPORT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div id="screen-provbm" class="panel">
    <div class="panel-header">
      <button class="back-btn" onclick="showScreen('screen-home')">‚Üê Back</button>
      <h2>Provisional BM Report</h2>
      <span class="step-badge">Module 07</span>
    </div>
    <div class="panel-body">

      <div class="cr-lookup">
        <div class="field">
          <label>CR Number</label>
          <input type="text" id="provbm_cr" placeholder="e.g. 202600012345"
            inputmode="numeric" maxlength="12"
            onkeydown="if(event.key==='Enter')loadForProvBM()">
        </div>
        <button class="lookup-btn" onclick="loadForProvBM()">üîç Load</button>
      </div>

      <div id="provbm_wrap" class="hidden">
        <div class="patient-card" id="provbm_pc" style="margin-bottom:16px;"></div>

        <!-- Rider warning -->
        <div style="background:#fff8e1;border:1.5px solid #f59e0b;border-radius:10px;padding:12px 14px;margin-bottom:16px;">
          <div style="font-size:12px;font-weight:700;color:#92400e;margin-bottom:4px;">‚ö†Ô∏è PROVISIONAL REPORT</div>
          <div style="font-size:11px;color:#78350f;line-height:1.6;">
            This report is provisional and not validated. The report in HIS will be the final one.
          </div>
        </div>

        <div class="order-block">
          <div class="order-block-title">Bone Marrow Report <span class="req">*</span></div>
          <textarea id="provbm_report"
            style="width:100%;min-height:200px;padding:14px;border:1.5px solid var(--border);border-radius:10px;font-size:14px;font-family:inherit;line-height:1.7;resize:vertical;background:white;color:var(--dark);outline:none;"
            placeholder="Enter provisional bone marrow findings and diagnosis..."></textarea>
        </div>

        <div style="background:#f0f4ff;border:1.5px solid #1a3a6a;border-radius:12px;padding:16px;text-align:center;margin-top:14px;">
          <div style="font-size:11px;color:#888;margin-bottom:12px;">Downloads a .txt provisional report with date, time and rider</div>
          <button onclick="downloadProvBM()" style="background:#1a3a6a;color:white;border:none;border-radius:10px;padding:13px 28px;font-family:var(--mono);font-size:14px;font-weight:700;cursor:pointer;letter-spacing:0.06em;">
            ‚¨á Download Provisional Report
          </button>
        </div>

      </div>
    </div>
  </div>

</div><!-- /main -->

<!-- ‚îÄ‚îÄ‚îÄ CONFIG BUTTON ‚îÄ‚îÄ‚îÄ -->
<button class="config-btn" onclick="promptConfig()">‚öô Config</button>

<!-- Config password prompt -->
<div id="config-pwd-overlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:99998;align-items:center;justify-content:center;">
  <div style="background:#1a1a1a;border:1.5px solid var(--crimson);border-radius:16px;padding:28px 24px;width:90%;max-width:320px;">
    <div style="font-family:var(--mono);font-size:14px;font-weight:700;color:white;margin-bottom:4px;">‚öô Config Access</div>
    <div style="font-size:11px;color:#888;margin-bottom:16px;">Enter administrator password</div>
    <input type="password" id="config-pwd-input" placeholder="Password"
      style="width:100%;padding:10px 12px;border-radius:8px;border:1.5px solid #444;background:#111;color:white;font-size:14px;font-family:var(--mono);outline:none;box-sizing:border-box;margin-bottom:8px;"
      onkeydown="if(event.key==='Enter')verifyConfig();if(event.key==='Escape')closeConfigPrompt()">
    <div id="config-pwd-error" style="color:var(--crimson);font-size:11px;min-height:16px;margin-bottom:12px;font-family:var(--mono);"></div>
    <div style="display:flex;gap:8px;">
      <button onclick="closeConfigPrompt()" style="flex:1;padding:10px;background:#333;color:#aaa;border:none;border-radius:8px;font-family:var(--mono);cursor:pointer;">Cancel</button>
      <button onclick="verifyConfig()" style="flex:1;padding:10px;background:var(--crimson);color:white;border:none;border-radius:8px;font-family:var(--mono);font-weight:700;cursor:pointer;">Unlock ‚Üí</button>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ‚îÄ CONFIG MODAL ‚îÄ‚îÄ‚îÄ -->
<div class="config-modal" id="configModal">
  <div class="config-box">
    <button class="close-modal" onclick="closeConfig()">√ó</button>
    <h3>Google Sheets Setup</h3>
    <p>This app sends data to a Google Sheet via Google Apps Script. Follow these steps once:</p>
    <ol>
      <li>Open your Google Sheet ‚Üí <strong>Extensions ‚Üí Apps Script</strong></li>
      <li>Paste the provided Apps Script code (see below)</li>
      <li>Click <strong>Deploy ‚Üí New Deployment ‚Üí Web App</strong></li>
      <li>Set <em>"Who has access"</em> to <strong>Anyone</strong></li>
      <li>Copy the deployment URL and paste it below</li>
    </ol>
    <div class="field">
      <label>Apps Script Deployment URL</label>
      <div class="config-row">
        <input type="text" id="scriptUrl" placeholder="https://script.google.com/macros/s/.../exec">
        <button class="config-save" onclick="saveConfig()">Save</button>
        <button class="config-save" onclick="testConnection()" style="background:#1a6a3a;margin-left:8px;">üîó Test</button>
        <div id="conn-test-result" style="margin-top:8px;font-size:11px;font-family:var(--mono);min-height:16px;"></div>
      </div>
    </div>
    <div style="margin-top:20px;background:var(--light);border-radius:8px;padding:16px;font-size:11px;font-family:var(--mono);color:var(--slate);overflow:auto;max-height:200px;white-space:pre-wrap;" id="scriptCode"></div>
  </div>
</div>

<!-- ‚îÄ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ -->
<div class="toast" id="toast"></div>

<script>
// ‚îÄ‚îÄ‚îÄ TOAST NOTIFICATIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showToast(msg, type) {
  var toast = document.getElementById('toast');
  if (!toast) return;
  toast.textContent = msg;
  toast.className = 'toast' + (type ? ' ' + type : '');
  toast.classList.add('show');
  clearTimeout(window._toastTimer);
  window._toastTimer = setTimeout(function() {
    toast.classList.remove('show');
  }, type === 'error' ? 4000 : 2500);
}


// ‚îÄ‚îÄ‚îÄ CONFIG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const APPS_SCRIPT_CODE = `// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PRISM ‚Äî PGIMER HemePath Registry
// ONE sheet per lab: orders + acceptance + results in same row
// Columns: Timestamp | CR | Lab ID | Unique Lab ID | Name | Payment | Notes | Panels | [Status|Result]...
// Deploy ‚Üí Web App | Execute as: Me | Access: Anyone
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function doGet(e) {
  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var callback = e.parameter.callback;
    if (e.parameter.write === '1' && e.parameter.data) {
      var data = JSON.parse(decodeURIComponent(e.parameter.data));
      var result = writeData(ss, data);
      var json = JSON.stringify(result);
      if (callback) return ContentService.createTextOutput(callback+'('+json+')').setMimeType(ContentService.MimeType.JAVASCRIPT);
      return ContentService.createTextOutput(json).setMimeType(ContentService.MimeType.JSON);
    }
    var cr = e.parameter.cr;
    var type = e.parameter.type || 'patient';

    // ping: simple connectivity test
    if (type === 'ping') {
      result = {status:'ok', message:'PRISM server connected', time: new Date().toISOString()};
      var json = JSON.stringify(result);
      if (callback) return ContentService.createTextOutput(callback+'('+json+')').setMimeType(ContentService.MimeType.JAVASCRIPT);
      return ContentService.createTextOutput(json).setMimeType(ContentService.MimeType.JSON);
    }

    // fetch_all: returns patient + all lab data for a CR in one call
    if (type === 'fetch_all' && cr) {
      var allData = {};
      // Patient ‚Äî return ALL rows for this CR (multiple visits)
      var pSheet = ss.getSheetByName('Patients');
      if (pSheet) {
        var pRows = findAllVisitRows(pSheet, cr);
        if (pRows.length === 1) {
          var pVals = pSheet.getRange(pRows[0],1,1,pSheet.getLastColumn()).getValues()[0];
          pVals = pVals.map(function(v){ return v instanceof Date ? v.toISOString() : v; });
          allData.patient = pVals;
        } else if (pRows.length > 1) {
          allData.patients = pRows.map(function(r) {
            var vals = pSheet.getRange(r,1,1,pSheet.getLastColumn()).getValues()[0];
            return vals.map(function(v){ return v instanceof Date ? v.toISOString() : v; });
          });
        }
      }
      // Morphology
      var mSheet = ss.getSheetByName('Morphology');
      if (mSheet) {
        var mRows = findAllVisitRows(mSheet, cr);
        if (mRows.length === 1) {
          var mVals = mSheet.getRange(mRows[0],1,1,mSheet.getLastColumn()).getValues()[0];
          mVals = mVals.map(function(v){ return v instanceof Date ? v.toISOString() : v; });
          allData.morph = mVals;
        } else if (mRows.length > 1) {
          allData.morph_all = mRows.map(function(r) {
            var vals = mSheet.getRange(r,1,1,mSheet.getLastColumn()).getValues()[0];
            return vals.map(function(v){ return v instanceof Date ? v.toISOString() : v; });
          });
          var lastVals = mSheet.getRange(mRows[mRows.length-1],1,1,mSheet.getLastColumn()).getValues()[0];
          allData.morph = lastVals.map(function(v){ return v instanceof Date ? v.toISOString() : v; });
        }
      }
      // Each lab sheet ‚Äî return ALL rows for this CR
      var labSheets = ['FISH','FCM','RT-PCR','NGS-H12','NGS-H9','TCR'];
      labSheets.forEach(function(lab) {
        var lSheet = ss.getSheetByName(lab);
        if (lSheet) {
          var lRows = findAllVisitRows(lSheet, cr);
          var key = lab.toLowerCase().replace(/-/g,'');
          if (lRows.length === 1) {
            var lVals = lSheet.getRange(lRows[0],1,1,lSheet.getLastColumn()).getValues()[0];
            lVals = lVals.map(function(v){ return v instanceof Date ? v.toISOString() : v; });
            allData[key] = lVals;
          } else if (lRows.length > 1) {
            allData[key + '_all'] = lRows.map(function(r) {
              var vals = lSheet.getRange(r,1,1,lSheet.getLastColumn()).getValues()[0];
              return vals.map(function(v){ return v instanceof Date ? v.toISOString() : v; });
            });
          }
        }
      });
      result = {status:'ok', type:'fetch_all', data:allData};
    } else {
      var sheetName = type === 'patient' ? 'Patients' : type.toUpperCase();
      var sheet = ss.getSheetByName(sheetName);
      if (!sheet) { result = {status:'error', error:'Sheet not found: '+sheetName}; }
      else {
        var row = findRow(sheet, cr, 2);
        if (row < 1) { result = {status:'error', error:'Not found'}; }
        else {
          var vals = sheet.getRange(row,1,1,sheet.getLastColumn()).getValues()[0];
          vals = vals.map(function(v){ return v instanceof Date ? v.toISOString() : v; });
          result = {status:'ok', data:vals};
        }
      }
    }
    var json = JSON.stringify(result);
    if (callback) return ContentService.createTextOutput(callback+'('+json+')').setMimeType(ContentService.MimeType.JAVASCRIPT);
    return ContentService.createTextOutput(json).setMimeType(ContentService.MimeType.JSON);
  } catch(err) {
    var errJson = JSON.stringify({status:'error',message:err.toString()});
    var cb = e.parameter ? e.parameter.callback : null;
    if (cb) return ContentService.createTextOutput(cb+'('+errJson+')').setMimeType(ContentService.MimeType.JAVASCRIPT);
    return ContentService.createTextOutput(errJson).setMimeType(ContentService.MimeType.JSON);
  }
}

function doPost(e) {
  try {
    var raw = (e.parameter && e.parameter.data) ? e.parameter.data : e.postData.contents;
    var data = JSON.parse(raw);
    return ContentService.createTextOutput(JSON.stringify(writeData(SpreadsheetApp.getActiveSpreadsheet(), data))).setMimeType(ContentService.MimeType.JSON);
  } catch(err) {
    return ContentService.createTextOutput(JSON.stringify({status:'error',message:err.toString()})).setMimeType(ContentService.MimeType.JSON);
  }
}

function writeData(ss, data) {
  var sheetName = data.sheet || 'Patients';
  var sheet = ss.getSheetByName(sheetName) || ss.insertSheet(sheetName);

  if (data.action === 'register') {
    if (sheet.getLastRow() === 0) {
      sheet.appendRow(['Timestamp','CR Number','Lab ID','Date','Name','Age','Sex','Faculty','JR','SR','Sample','TLC','BM Quality','Blasts%','Eos%','Plasma%','Right Imprint','Left Imprint','Suspicion']);
    }
    // Duplicate Lab ID check in Patients sheet
    if (data.labid) {
      var labIdCol = sheet.getLastRow() > 1 ? sheet.getRange(2, 3, sheet.getLastRow()-1, 1).getValues() : [];
      var crCol    = sheet.getLastRow() > 1 ? sheet.getRange(2, 2, sheet.getLastRow()-1, 1).getValues() : [];
      for (var di=0; di<labIdCol.length; di++) {
        if (String(labIdCol[di][0]).trim().toLowerCase() === String(data.labid).trim().toLowerCase()
            && String(crCol[di][0]).trim() !== String(data.cr).trim()) {
          return {status:'duplicate', message:'Lab ID already registered for a different CR number'};
        }
      }
    }
    // Always append ‚Äî never overwrite, keep full history
    var row = [new Date(),data.cr,data.labid,data.date,data.name,data.age,data.sex,data.faculty,data.jr,data.sr,data.sample,data.tlc,data.bmQuality,data.blasts,data.eos,data.plasma,data.rightImprint,data.leftImprint,data.suspicion];
    sheet.appendRow(row);
    return {status:'ok',cr:data.cr};
  }

    if ((data.action === 'order' || data.action === 'save_acceptance' || data.action === 'save_results') && data.lab === 'fish') {
      if (sheet.getLastRow() === 0) sheet.appendRow(["Timestamp", "CR Number", "Lab ID", "Unique Lab ID", "Name", "Payment", "Notes", "Panels Ordered", "ALL ‚Äî Status", "ALL ‚Äî Result", "MDS ‚Äî Status", "MDS ‚Äî Result", "MDS-Extended ‚Äî Status", "MDS-Extended ‚Äî Result", "Acute Leuk-NOS ‚Äî Status", "Acute Leuk-NOS ‚Äî Result", "CML/MPN ‚Äî Status", "CML/MPN ‚Äî Result", "JMML ‚Äî Status", "JMML ‚Äî Result", "CLL ‚Äî Status", "CLL ‚Äî Result", "CLL+CCND1 ‚Äî Status", "CLL+CCND1 ‚Äî Result", "Lymphoma-not CLL ‚Äî Status", "Lymphoma-not CLL ‚Äî Result", "HES ‚Äî Status", "HES ‚Äî Result", "T-PLL ‚Äî Status", "T-PLL ‚Äî Result", "MM ‚Äî Status", "MM ‚Äî Result", "Other ‚Äî Status", "Other ‚Äî Result"]);

      // Duplicate Unique Lab ID check (for save_acceptance only)
      if (data.action === 'save_acceptance' && data.uniqueLabId) {
        var allRows = sheet.getLastRow() > 1 ? sheet.getRange(2, 4, sheet.getLastRow()-1, 1).getValues() : [];
        var existingCRs = sheet.getLastRow() > 1 ? sheet.getRange(2, 2, sheet.getLastRow()-1, 1).getValues() : [];
        for (var di=0; di<allRows.length; di++) {
          if (String(allRows[di][0]).trim().toLowerCase() === String(data.uniqueLabId).trim().toLowerCase()
              && String(existingCRs[di][0]).trim() !== String(data.cr).trim()) {
            return {status:'duplicate', message:'Unique Lab ID already exists for another case in FISH', cr:data.cr};
          }
        }
      }

      // Find latest row for this CR+LabID ‚Äî append if not found
      var tRow = findRowByCrLabId(sheet, data.cr, data.labid||'');
      if (tRow < 0) {
        var blankRow = [new Date(), data.cr, data.labid||"", data.uniqueLabId||"", data.name||""];
        for (var bi=5; bi<34; bi++) blankRow.push("");
        sheet.appendRow(blankRow);
        tRow = sheet.getLastRow();
      }
      if (data.action === 'order') {
        sheet.getRange(tRow,1,1,1).setValue(new Date());
        sheet.getRange(tRow,3,1,1).setValue(data.labid||"");
        sheet.getRange(tRow,5,1,1).setValue(data.name||"");
        sheet.getRange(tRow,6,1,1).setValue(data.payment||"");
        sheet.getRange(tRow,7,1,1).setValue(data.notes||"");
        sheet.getRange(tRow,8,1,1).setValue(data.panels||"");
      }
      if (data.action === 'save_acceptance') {
        var ps = data.panelStatus || {};
        if (data.labid)       sheet.getRange(tRow,3,1,1).setValue(data.labid);
        if (data.uniqueLabId) sheet.getRange(tRow,4,1,1).setValue(data.uniqueLabId);
        if (data.name)        sheet.getRange(tRow,5,1,1).setValue(data.name);
        if (data.notes)       sheet.getRange(tRow,7,1,1).setValue(data.notes);
        if (ps["ALL"]) sheet.getRange(tRow,9,1,1).setValue(ps["ALL"]);
        if (ps["MDS"]) sheet.getRange(tRow,11,1,1).setValue(ps["MDS"]);
        if (ps["MDS-Extended"]) sheet.getRange(tRow,13,1,1).setValue(ps["MDS-Extended"]);
        if (ps["Acute Leuk-NOS"]) sheet.getRange(tRow,15,1,1).setValue(ps["Acute Leuk-NOS"]);
        if (ps["CML/MPN"]) sheet.getRange(tRow,17,1,1).setValue(ps["CML/MPN"]);
        if (ps["JMML"]) sheet.getRange(tRow,19,1,1).setValue(ps["JMML"]);
        if (ps["CLL"]) sheet.getRange(tRow,21,1,1).setValue(ps["CLL"]);
        if (ps["CLL+CCND1"]) sheet.getRange(tRow,23,1,1).setValue(ps["CLL+CCND1"]);
        if (ps["Lymphoma-not CLL"]) sheet.getRange(tRow,25,1,1).setValue(ps["Lymphoma-not CLL"]);
        if (ps["HES"]) sheet.getRange(tRow,27,1,1).setValue(ps["HES"]);
        if (ps["T-PLL"]) sheet.getRange(tRow,29,1,1).setValue(ps["T-PLL"]);
        if (ps["MM"]) sheet.getRange(tRow,31,1,1).setValue(ps["MM"]);
        if (ps["Other"]) sheet.getRange(tRow,33,1,1).setValue(ps["Other"]);
      }
      if (data.action === 'save_results') {
        var pr = data.panelResults || {};
        if (data.labid)       sheet.getRange(tRow,3,1,1).setValue(data.labid);
        if (data.name)        sheet.getRange(tRow,5,1,1).setValue(data.name);
        if (data.overallNotes) sheet.getRange(tRow,7,1,1).setValue(data.overallNotes);
        if (pr["ALL"]) sheet.getRange(tRow,10,1,1).setValue(pr["ALL"]);
        if (pr["MDS"]) sheet.getRange(tRow,12,1,1).setValue(pr["MDS"]);
        if (pr["MDS-Extended"]) sheet.getRange(tRow,14,1,1).setValue(pr["MDS-Extended"]);
        if (pr["Acute Leuk-NOS"]) sheet.getRange(tRow,16,1,1).setValue(pr["Acute Leuk-NOS"]);
        if (pr["CML/MPN"]) sheet.getRange(tRow,18,1,1).setValue(pr["CML/MPN"]);
        if (pr["JMML"]) sheet.getRange(tRow,20,1,1).setValue(pr["JMML"]);
        if (pr["CLL"]) sheet.getRange(tRow,22,1,1).setValue(pr["CLL"]);
        if (pr["CLL+CCND1"]) sheet.getRange(tRow,24,1,1).setValue(pr["CLL+CCND1"]);
        if (pr["Lymphoma-not CLL"]) sheet.getRange(tRow,26,1,1).setValue(pr["Lymphoma-not CLL"]);
        if (pr["HES"]) sheet.getRange(tRow,28,1,1).setValue(pr["HES"]);
        if (pr["T-PLL"]) sheet.getRange(tRow,30,1,1).setValue(pr["T-PLL"]);
        if (pr["MM"]) sheet.getRange(tRow,32,1,1).setValue(pr["MM"]);
        if (pr["Other"]) sheet.getRange(tRow,34,1,1).setValue(pr["Other"]);
      }
      return {status:'ok', lab:'fish', cr:data.cr};
    }

    if ((data.action === 'order' || data.action === 'save_acceptance' || data.action === 'save_results') && data.lab === 'fcm') {
      if (sheet.getLastRow() === 0) sheet.appendRow(["Timestamp", "CR Number", "Lab ID", "Unique Lab ID", "Name", "Payment", "Notes", "Panels Ordered", "Acute Leuk ‚Äî Status", "Acute Leuk ‚Äî Result", "CLPD ‚Äî Status", "CLPD ‚Äî Result", "MM-Diagnosis ‚Äî Status", "MM-Diagnosis ‚Äî Result", "MM-MRD ‚Äî Status", "MM-MRD ‚Äî Result", "B-ALL-MRD ‚Äî Status", "B-ALL-MRD ‚Äî Result", "T-ALL-MRD ‚Äî Status", "T-ALL-MRD ‚Äî Result", "MDS ‚Äî Status", "MDS ‚Äî Result", "B & T Tubes Acute Leuk ‚Äî Status", "B & T Tubes Acute Leuk ‚Äî Result", "CLPD-MRD ‚Äî Status", "CLPD-MRD ‚Äî Result", "Mast Cell Tube ‚Äî Status", "Mast Cell Tube ‚Äî Result", "Neuroblastoma ‚Äî Status", "Neuroblastoma ‚Äî Result", "Other ‚Äî Status", "Other ‚Äî Result"]);

      // Duplicate Unique Lab ID check (for save_acceptance only)
      if (data.action === 'save_acceptance' && data.uniqueLabId) {
        var allRows = sheet.getLastRow() > 1 ? sheet.getRange(2, 4, sheet.getLastRow()-1, 1).getValues() : [];
        var existingCRs = sheet.getLastRow() > 1 ? sheet.getRange(2, 2, sheet.getLastRow()-1, 1).getValues() : [];
        for (var di=0; di<allRows.length; di++) {
          if (String(allRows[di][0]).trim().toLowerCase() === String(data.uniqueLabId).trim().toLowerCase()
              && String(existingCRs[di][0]).trim() !== String(data.cr).trim()) {
            return {status:'duplicate', message:'Unique Lab ID already exists for another case in FCM', cr:data.cr};
          }
        }
      }

      // Find latest row for this CR+LabID ‚Äî append if not found
      var tRow = findRowByCrLabId(sheet, data.cr, data.labid||'');
      if (tRow < 0) {
        var blankRow = [new Date(), data.cr, data.labid||"", data.uniqueLabId||"", data.name||""];
        for (var bi=5; bi<32; bi++) blankRow.push("");
        sheet.appendRow(blankRow);
        tRow = sheet.getLastRow();
      }
      if (data.action === 'order') {
        sheet.getRange(tRow,1,1,1).setValue(new Date());
        sheet.getRange(tRow,3,1,1).setValue(data.labid||"");
        sheet.getRange(tRow,5,1,1).setValue(data.name||"");
        sheet.getRange(tRow,6,1,1).setValue(data.payment||"");
        sheet.getRange(tRow,7,1,1).setValue(data.notes||"");
        sheet.getRange(tRow,8,1,1).setValue(data.panels||"");
      }
      if (data.action === 'save_acceptance') {
        var ps = data.panelStatus || {};
        if (data.labid)       sheet.getRange(tRow,3,1,1).setValue(data.labid);
        if (data.uniqueLabId) sheet.getRange(tRow,4,1,1).setValue(data.uniqueLabId);
        if (data.name)        sheet.getRange(tRow,5,1,1).setValue(data.name);
        if (data.notes)       sheet.getRange(tRow,7,1,1).setValue(data.notes);
        if (ps["Acute Leuk"]) sheet.getRange(tRow,9,1,1).setValue(ps["Acute Leuk"]);
        if (ps["CLPD"]) sheet.getRange(tRow,11,1,1).setValue(ps["CLPD"]);
        if (ps["MM-Diagnosis"]) sheet.getRange(tRow,13,1,1).setValue(ps["MM-Diagnosis"]);
        if (ps["MM-MRD"]) sheet.getRange(tRow,15,1,1).setValue(ps["MM-MRD"]);
        if (ps["B-ALL-MRD"]) sheet.getRange(tRow,17,1,1).setValue(ps["B-ALL-MRD"]);
        if (ps["T-ALL-MRD"]) sheet.getRange(tRow,19,1,1).setValue(ps["T-ALL-MRD"]);
        if (ps["MDS"]) sheet.getRange(tRow,21,1,1).setValue(ps["MDS"]);
        if (ps["B & T Tubes Acute Leuk"]) sheet.getRange(tRow,23,1,1).setValue(ps["B & T Tubes Acute Leuk"]);
        if (ps["CLPD-MRD"]) sheet.getRange(tRow,25,1,1).setValue(ps["CLPD-MRD"]);
        if (ps["Mast Cell Tube"]) sheet.getRange(tRow,27,1,1).setValue(ps["Mast Cell Tube"]);
        if (ps["Neuroblastoma"]) sheet.getRange(tRow,29,1,1).setValue(ps["Neuroblastoma"]);
        if (ps["Other"]) sheet.getRange(tRow,31,1,1).setValue(ps["Other"]);
      }
      if (data.action === 'save_results') {
        var pr = data.panelResults || {};
        if (data.labid)       sheet.getRange(tRow,3,1,1).setValue(data.labid);
        if (data.name)        sheet.getRange(tRow,5,1,1).setValue(data.name);
        if (data.overallNotes) sheet.getRange(tRow,7,1,1).setValue(data.overallNotes);
        if (pr["Acute Leuk"]) sheet.getRange(tRow,10,1,1).setValue(pr["Acute Leuk"]);
        if (pr["CLPD"]) sheet.getRange(tRow,12,1,1).setValue(pr["CLPD"]);
        if (pr["MM-Diagnosis"]) sheet.getRange(tRow,14,1,1).setValue(pr["MM-Diagnosis"]);
        if (pr["MM-MRD"]) sheet.getRange(tRow,16,1,1).setValue(pr["MM-MRD"]);
        if (pr["B-ALL-MRD"]) sheet.getRange(tRow,18,1,1).setValue(pr["B-ALL-MRD"]);
        if (pr["T-ALL-MRD"]) sheet.getRange(tRow,20,1,1).setValue(pr["T-ALL-MRD"]);
        if (pr["MDS"]) sheet.getRange(tRow,22,1,1).setValue(pr["MDS"]);
        if (pr["B & T Tubes Acute Leuk"]) sheet.getRange(tRow,24,1,1).setValue(pr["B & T Tubes Acute Leuk"]);
        if (pr["CLPD-MRD"]) sheet.getRange(tRow,26,1,1).setValue(pr["CLPD-MRD"]);
        if (pr["Mast Cell Tube"]) sheet.getRange(tRow,28,1,1).setValue(pr["Mast Cell Tube"]);
        if (pr["Neuroblastoma"]) sheet.getRange(tRow,30,1,1).setValue(pr["Neuroblastoma"]);
        if (pr["Other"]) sheet.getRange(tRow,32,1,1).setValue(pr["Other"]);
      }
      return {status:'ok', lab:'fcm', cr:data.cr};
    }

    if ((data.action === 'order' || data.action === 'save_acceptance' || data.action === 'save_results') && data.lab === 'rtpcr') {
      if (sheet.getLastRow() === 0) sheet.appendRow(["Timestamp", "CR Number", "Lab ID", "Unique Lab ID", "Name", "Payment", "Notes", "Panels Ordered", "RT-PCR Acute Panel ‚Äî Status", "RT-PCR Acute Panel ‚Äî Result", "BCR-ABL1 ‚Äî Status", "BCR-ABL1 ‚Äî Result", "JAK2 ‚Äî Status", "JAK2 ‚Äî Result", "CML/MPN Panel ‚Äî Status", "CML/MPN Panel ‚Äî Result", "MYD88 ‚Äî Status", "MYD88 ‚Äî Result", "BRAF ‚Äî Status", "BRAF ‚Äî Result", "ddPCR-MRD ‚Äî Status", "ddPCR-MRD ‚Äî Result", "qPCR-MRD ‚Äî Status", "qPCR-MRD ‚Äî Result", "Other ‚Äî Status", "Other ‚Äî Result"]);

      // Duplicate Unique Lab ID check (for save_acceptance only)
      if (data.action === 'save_acceptance' && data.uniqueLabId) {
        var allRows = sheet.getLastRow() > 1 ? sheet.getRange(2, 4, sheet.getLastRow()-1, 1).getValues() : [];
        var existingCRs = sheet.getLastRow() > 1 ? sheet.getRange(2, 2, sheet.getLastRow()-1, 1).getValues() : [];
        for (var di=0; di<allRows.length; di++) {
          if (String(allRows[di][0]).trim().toLowerCase() === String(data.uniqueLabId).trim().toLowerCase()
              && String(existingCRs[di][0]).trim() !== String(data.cr).trim()) {
            return {status:'duplicate', message:'Unique Lab ID already exists for another case in RTPCR', cr:data.cr};
          }
        }
      }

      // Find latest row for this CR+LabID ‚Äî append if not found
      var tRow = findRowByCrLabId(sheet, data.cr, data.labid||'');
      if (tRow < 0) {
        var blankRow = [new Date(), data.cr, data.labid||"", data.uniqueLabId||"", data.name||""];
        for (var bi=5; bi<26; bi++) blankRow.push("");
        sheet.appendRow(blankRow);
        tRow = sheet.getLastRow();
      }
      if (data.action === 'order') {
        sheet.getRange(tRow,1,1,1).setValue(new Date());
        sheet.getRange(tRow,3,1,1).setValue(data.labid||"");
        sheet.getRange(tRow,5,1,1).setValue(data.name||"");
        sheet.getRange(tRow,6,1,1).setValue(data.payment||"");
        sheet.getRange(tRow,7,1,1).setValue(data.notes||"");
        sheet.getRange(tRow,8,1,1).setValue(data.panels||"");
      }
      if (data.action === 'save_acceptance') {
        var ps = data.panelStatus || {};
        if (data.labid)       sheet.getRange(tRow,3,1,1).setValue(data.labid);
        if (data.uniqueLabId) sheet.getRange(tRow,4,1,1).setValue(data.uniqueLabId);
        if (data.name)        sheet.getRange(tRow,5,1,1).setValue(data.name);
        if (data.notes)       sheet.getRange(tRow,7,1,1).setValue(data.notes);
        if (ps["Acute Leukemia Panel"]) sheet.getRange(tRow,9,1,1).setValue(ps["Acute Leukemia Panel"]);
        if (ps["BCR-ABL1"]) sheet.getRange(tRow,11,1,1).setValue(ps["BCR-ABL1"]);
        if (ps["JAK2"]) sheet.getRange(tRow,13,1,1).setValue(ps["JAK2"]);
        if (ps["CML/MPN Panel"]) sheet.getRange(tRow,15,1,1).setValue(ps["CML/MPN Panel"]);
        if (ps["MYD88"]) sheet.getRange(tRow,17,1,1).setValue(ps["MYD88"]);
        if (ps["BRAF"]) sheet.getRange(tRow,19,1,1).setValue(ps["BRAF"]);
        if (ps["ddPCR-MRD"]) sheet.getRange(tRow,21,1,1).setValue(ps["ddPCR-MRD"]);
        if (ps["qPCR-MRD"]) sheet.getRange(tRow,23,1,1).setValue(ps["qPCR-MRD"]);
        if (ps["Other"]) sheet.getRange(tRow,25,1,1).setValue(ps["Other"]);
      }
      if (data.action === 'save_results') {
        var pr = data.panelResults || {};
        if (data.labid)       sheet.getRange(tRow,3,1,1).setValue(data.labid);
        if (data.name)        sheet.getRange(tRow,5,1,1).setValue(data.name);
        if (data.overallNotes) sheet.getRange(tRow,7,1,1).setValue(data.overallNotes);
        if (pr["Acute Leukemia Panel"]) sheet.getRange(tRow,10,1,1).setValue(pr["Acute Leukemia Panel"]);
        if (pr["BCR-ABL1"]) sheet.getRange(tRow,12,1,1).setValue(pr["BCR-ABL1"]);
        if (pr["JAK2"]) sheet.getRange(tRow,14,1,1).setValue(pr["JAK2"]);
        if (pr["CML/MPN Panel"]) sheet.getRange(tRow,16,1,1).setValue(pr["CML/MPN Panel"]);
        if (pr["MYD88"]) sheet.getRange(tRow,18,1,1).setValue(pr["MYD88"]);
        if (pr["BRAF"]) sheet.getRange(tRow,20,1,1).setValue(pr["BRAF"]);
        if (pr["ddPCR-MRD"]) sheet.getRange(tRow,22,1,1).setValue(pr["ddPCR-MRD"]);
        if (pr["qPCR-MRD"]) sheet.getRange(tRow,24,1,1).setValue(pr["qPCR-MRD"]);
        if (pr["Other"]) sheet.getRange(tRow,26,1,1).setValue(pr["Other"]);
      }
      return {status:'ok', lab:'rtpcr', cr:data.cr};
    }

    if ((data.action === 'order' || data.action === 'save_acceptance' || data.action === 'save_results') && data.lab === 'ngsh12') {
      if (sheet.getLastRow() === 0) sheet.appendRow(["Timestamp", "CR Number", "Lab ID", "Unique Lab ID", "Name", "Payment", "Notes", "Panels Ordered", "Myeloid Mutation Panel ‚Äî Status", "Myeloid Mutation Panel ‚Äî Result", "Lymphoid Mutation Panel ‚Äî Status", "Lymphoid Mutation Panel ‚Äî Result", "TP53 Only ‚Äî Status", "TP53 Only ‚Äî Result", "Other ‚Äî Status", "Other ‚Äî Result"]);

      // Duplicate Unique Lab ID check (for save_acceptance only)
      if (data.action === 'save_acceptance' && data.uniqueLabId) {
        var allRows = sheet.getLastRow() > 1 ? sheet.getRange(2, 4, sheet.getLastRow()-1, 1).getValues() : [];
        var existingCRs = sheet.getLastRow() > 1 ? sheet.getRange(2, 2, sheet.getLastRow()-1, 1).getValues() : [];
        for (var di=0; di<allRows.length; di++) {
          if (String(allRows[di][0]).trim().toLowerCase() === String(data.uniqueLabId).trim().toLowerCase()
              && String(existingCRs[di][0]).trim() !== String(data.cr).trim()) {
            return {status:'duplicate', message:'Unique Lab ID already exists for another case in NGSH12', cr:data.cr};
          }
        }
      }

      // Find latest row for this CR+LabID ‚Äî append if not found
      var tRow = findRowByCrLabId(sheet, data.cr, data.labid||'');
      if (tRow < 0) {
        var blankRow = [new Date(), data.cr, data.labid||"", data.uniqueLabId||"", data.name||""];
        for (var bi=5; bi<16; bi++) blankRow.push("");
        sheet.appendRow(blankRow);
        tRow = sheet.getLastRow();
      }
      if (data.action === 'order') {
        sheet.getRange(tRow,1,1,1).setValue(new Date());
        sheet.getRange(tRow,3,1,1).setValue(data.labid||"");
        sheet.getRange(tRow,5,1,1).setValue(data.name||"");
        sheet.getRange(tRow,6,1,1).setValue(data.payment||"");
        sheet.getRange(tRow,7,1,1).setValue(data.notes||"");
        sheet.getRange(tRow,8,1,1).setValue(data.panels||"");
      }
      if (data.action === 'save_acceptance') {
        var ps = data.panelStatus || {};
        if (data.labid)       sheet.getRange(tRow,3,1,1).setValue(data.labid);
        if (data.uniqueLabId) sheet.getRange(tRow,4,1,1).setValue(data.uniqueLabId);
        if (data.name)        sheet.getRange(tRow,5,1,1).setValue(data.name);
        if (data.notes)       sheet.getRange(tRow,7,1,1).setValue(data.notes);
        if (ps["Myeloid Mutation Panel"]) sheet.getRange(tRow,9,1,1).setValue(ps["Myeloid Mutation Panel"]);
        if (ps["Lymphoid Mutation Panel"]) sheet.getRange(tRow,11,1,1).setValue(ps["Lymphoid Mutation Panel"]);
        if (ps["TP53 Only"]) sheet.getRange(tRow,13,1,1).setValue(ps["TP53 Only"]);
        if (ps["Other"]) sheet.getRange(tRow,15,1,1).setValue(ps["Other"]);
      }
      if (data.action === 'save_results') {
        var pr = data.panelResults || {};
        if (data.labid)       sheet.getRange(tRow,3,1,1).setValue(data.labid);
        if (data.name)        sheet.getRange(tRow,5,1,1).setValue(data.name);
        if (data.overallNotes) sheet.getRange(tRow,7,1,1).setValue(data.overallNotes);
        if (pr["Myeloid Mutation Panel"]) sheet.getRange(tRow,10,1,1).setValue(pr["Myeloid Mutation Panel"]);
        if (pr["Lymphoid Mutation Panel"]) sheet.getRange(tRow,12,1,1).setValue(pr["Lymphoid Mutation Panel"]);
        if (pr["TP53 Only"]) sheet.getRange(tRow,14,1,1).setValue(pr["TP53 Only"]);
        if (pr["Other"]) sheet.getRange(tRow,16,1,1).setValue(pr["Other"]);
      }
      return {status:'ok', lab:'ngsh12', cr:data.cr};
    }

    if ((data.action === 'order' || data.action === 'save_acceptance' || data.action === 'save_results') && data.lab === 'ngsh9') {
      if (sheet.getLastRow() === 0) sheet.appendRow(["Timestamp", "CR Number", "Lab ID", "Unique Lab ID", "Name", "Payment", "Notes", "Panels Ordered", "RNA Fusion Panel ‚Äî Status", "RNA Fusion Panel ‚Äî Result", "IBMFS Panel ‚Äî Status", "IBMFS Panel ‚Äî Result", "WES with CNV ‚Äî Status", "WES with CNV ‚Äî Result", "TCR by NGS ‚Äî Status", "TCR by NGS ‚Äî Result", "T-ALL Somatic ‚Äî Status", "T-ALL Somatic ‚Äî Result", "Other ‚Äî Status", "Other ‚Äî Result"]);

      // Duplicate Unique Lab ID check (for save_acceptance only)
      if (data.action === 'save_acceptance' && data.uniqueLabId) {
        var allRows = sheet.getLastRow() > 1 ? sheet.getRange(2, 4, sheet.getLastRow()-1, 1).getValues() : [];
        var existingCRs = sheet.getLastRow() > 1 ? sheet.getRange(2, 2, sheet.getLastRow()-1, 1).getValues() : [];
        for (var di=0; di<allRows.length; di++) {
          if (String(allRows[di][0]).trim().toLowerCase() === String(data.uniqueLabId).trim().toLowerCase()
              && String(existingCRs[di][0]).trim() !== String(data.cr).trim()) {
            return {status:'duplicate', message:'Unique Lab ID already exists for another case in NGSH9', cr:data.cr};
          }
        }
      }

      // Find latest row for this CR+LabID ‚Äî append if not found
      var tRow = findRowByCrLabId(sheet, data.cr, data.labid||'');
      if (tRow < 0) {
        var blankRow = [new Date(), data.cr, data.labid||"", data.uniqueLabId||"", data.name||""];
        for (var bi=5; bi<20; bi++) blankRow.push("");
        sheet.appendRow(blankRow);
        tRow = sheet.getLastRow();
      }
      if (data.action === 'order') {
        sheet.getRange(tRow,1,1,1).setValue(new Date());
        sheet.getRange(tRow,3,1,1).setValue(data.labid||"");
        sheet.getRange(tRow,5,1,1).setValue(data.name||"");
        sheet.getRange(tRow,6,1,1).setValue(data.payment||"");
        sheet.getRange(tRow,7,1,1).setValue(data.notes||"");
        sheet.getRange(tRow,8,1,1).setValue(data.panels||"");
      }
      if (data.action === 'save_acceptance') {
        var ps = data.panelStatus || {};
        if (data.labid)       sheet.getRange(tRow,3,1,1).setValue(data.labid);
        if (data.uniqueLabId) sheet.getRange(tRow,4,1,1).setValue(data.uniqueLabId);
        if (data.name)        sheet.getRange(tRow,5,1,1).setValue(data.name);
        if (data.notes)       sheet.getRange(tRow,7,1,1).setValue(data.notes);
        if (ps["RNA Fusion Panel"]) sheet.getRange(tRow,9,1,1).setValue(ps["RNA Fusion Panel"]);
        if (ps["IBMFS Panel"]) sheet.getRange(tRow,11,1,1).setValue(ps["IBMFS Panel"]);
        if (ps["WES with CNV"]) sheet.getRange(tRow,13,1,1).setValue(ps["WES with CNV"]);
        if (ps["TCR by NGS"]) sheet.getRange(tRow,15,1,1).setValue(ps["TCR by NGS"]);
        if (ps["T-ALL Somatic"]) sheet.getRange(tRow,17,1,1).setValue(ps["T-ALL Somatic"]);
        if (ps["Other"]) sheet.getRange(tRow,19,1,1).setValue(ps["Other"]);
      }
      if (data.action === 'save_results') {
        var pr = data.panelResults || {};
        if (data.labid)       sheet.getRange(tRow,3,1,1).setValue(data.labid);
        if (data.name)        sheet.getRange(tRow,5,1,1).setValue(data.name);
        if (data.overallNotes) sheet.getRange(tRow,7,1,1).setValue(data.overallNotes);
        if (pr["RNA Fusion Panel"]) sheet.getRange(tRow,10,1,1).setValue(pr["RNA Fusion Panel"]);
        if (pr["IBMFS Panel"]) sheet.getRange(tRow,12,1,1).setValue(pr["IBMFS Panel"]);
        if (pr["WES with CNV"]) sheet.getRange(tRow,14,1,1).setValue(pr["WES with CNV"]);
        if (pr["TCR by NGS"]) sheet.getRange(tRow,16,1,1).setValue(pr["TCR by NGS"]);
        if (pr["T-ALL Somatic"]) sheet.getRange(tRow,18,1,1).setValue(pr["T-ALL Somatic"]);
        if (pr["Other"]) sheet.getRange(tRow,20,1,1).setValue(pr["Other"]);
      }
      return {status:'ok', lab:'ngsh9', cr:data.cr};
    }

    if ((data.action === 'order' || data.action === 'save_acceptance' || data.action === 'save_results') && data.lab === 'tcr') {
      if (sheet.getLastRow() === 0) sheet.appendRow(["Timestamp", "CR Number", "Lab ID", "Unique Lab ID", "Name", "Payment", "Notes", "Panels Ordered", "TCR Beta ‚Äî Status", "TCR Beta ‚Äî Result", "TCR Gamma ‚Äî Status", "TCR Gamma ‚Äî Result", "Other ‚Äî Status", "Other ‚Äî Result"]);

      // Duplicate Unique Lab ID check (for save_acceptance only)
      if (data.action === 'save_acceptance' && data.uniqueLabId) {
        var allRows = sheet.getLastRow() > 1 ? sheet.getRange(2, 4, sheet.getLastRow()-1, 1).getValues() : [];
        var existingCRs = sheet.getLastRow() > 1 ? sheet.getRange(2, 2, sheet.getLastRow()-1, 1).getValues() : [];
        for (var di=0; di<allRows.length; di++) {
          if (String(allRows[di][0]).trim().toLowerCase() === String(data.uniqueLabId).trim().toLowerCase()
              && String(existingCRs[di][0]).trim() !== String(data.cr).trim()) {
            return {status:'duplicate', message:'Unique Lab ID already exists for another case in TCR', cr:data.cr};
          }
        }
      }

      // Find latest row for this CR+LabID ‚Äî append if not found
      var tRow = findRowByCrLabId(sheet, data.cr, data.labid||'');
      if (tRow < 0) {
        var blankRow = [new Date(), data.cr, data.labid||"", data.uniqueLabId||"", data.name||""];
        for (var bi=5; bi<14; bi++) blankRow.push("");
        sheet.appendRow(blankRow);
        tRow = sheet.getLastRow();
      }
      if (data.action === 'order') {
        sheet.getRange(tRow,1,1,1).setValue(new Date());
        sheet.getRange(tRow,3,1,1).setValue(data.labid||"");
        sheet.getRange(tRow,5,1,1).setValue(data.name||"");
        sheet.getRange(tRow,6,1,1).setValue(data.payment||"");
        sheet.getRange(tRow,7,1,1).setValue(data.notes||"");
        sheet.getRange(tRow,8,1,1).setValue(data.panels||"");
      }
      if (data.action === 'save_acceptance') {
        var ps = data.panelStatus || {};
        if (data.labid)       sheet.getRange(tRow,3,1,1).setValue(data.labid);
        if (data.uniqueLabId) sheet.getRange(tRow,4,1,1).setValue(data.uniqueLabId);
        if (data.name)        sheet.getRange(tRow,5,1,1).setValue(data.name);
        if (data.notes)       sheet.getRange(tRow,7,1,1).setValue(data.notes);
        if (ps["TCR Beta"]) sheet.getRange(tRow,9,1,1).setValue(ps["TCR Beta"]);
        if (ps["TCR Gamma"]) sheet.getRange(tRow,11,1,1).setValue(ps["TCR Gamma"]);
        if (ps["Other"]) sheet.getRange(tRow,13,1,1).setValue(ps["Other"]);
      }
      if (data.action === 'save_results') {
        var pr = data.panelResults || {};
        if (data.labid)       sheet.getRange(tRow,3,1,1).setValue(data.labid);
        if (data.name)        sheet.getRange(tRow,5,1,1).setValue(data.name);
        if (data.overallNotes) sheet.getRange(tRow,7,1,1).setValue(data.overallNotes);
        if (pr["TCR Beta"]) sheet.getRange(tRow,10,1,1).setValue(pr["TCR Beta"]);
        if (pr["TCR Gamma"]) sheet.getRange(tRow,12,1,1).setValue(pr["TCR Gamma"]);
        if (pr["Other"]) sheet.getRange(tRow,14,1,1).setValue(pr["Other"]);
      }
      return {status:'ok', lab:'tcr', cr:data.cr};
    }

  if (data.action === 'morphology') {
    if (sheet.getLastRow() === 0) sheet.appendRow(['Timestamp','CR Number','Lab ID','Name','BM Morphology Report']);
    // Find by CR+LabID ‚Äî append if not found
    var mRow = findRowByCrLabId(sheet, data.cr, data.labid||'');
    var row = [new Date(), data.cr, data.labid||"", data.name||"", data.report||""];
    if (mRow > 0) { sheet.getRange(mRow,1,1,row.length).setValues([row]); }
    else { sheet.appendRow(row); }
    return {status:'ok',cr:data.cr};
  }

  if (data.action === 'report') {
    if (sheet.getLastRow() === 0) sheet.appendRow(['Timestamp','CR Number','Lab ID','Name','Report JSON']);
    // Always append
    var row = [new Date(), data.cr, data.labid||"", data.name||"", JSON.stringify(data.reportData||{})];
    sheet.appendRow(row);
    return {status:'ok',cr:data.cr};
  }

  return {status:'error', message:'Unknown action: '+data.action};
}

function findRow(sheet, value, col) {
  if (!sheet || sheet.getLastRow() < 2) return -1;
  var data = sheet.getDataRange().getValues();
  for (var i = 1; i < data.length; i++) {
    if (String(data[i][col-1]).trim() === String(value).trim()) return i+1;
  }
  return -1;
}
function findAllRows(sheet, value, col) {
  if (!sheet || sheet.getLastRow() < 2) return [];
  var data = sheet.getDataRange().getValues();
  var rows = [];
  for (var i = 1; i < data.length; i++) {
    if (String(data[i][col-1]).trim() === String(value).trim()) rows.push(i+1);
  }
  return rows;
}
function findRowByCrLabId(sheet, cr, labid) {
  if (!sheet || sheet.getLastRow() < 2) return -1;
  var data = sheet.getDataRange().getValues();
  var found = -1;
  for (var i = 1; i < data.length; i++) {
    if (String(data[i][1]).trim() === String(cr).trim() &&
        String(data[i][2]).trim() === String(labid).trim()) {
      found = i + 1; // keep last match
    }
  }
  return found;
}
function findAllVisitRows(sheet, cr) {
  if (!sheet || sheet.getLastRow() < 2) return [];
  var data = sheet.getDataRange().getValues();
  var seen = {};
  for (var i = 1; i < data.length; i++) {
    if (String(data[i][1]).trim() === String(cr).trim()) {
      var key = String(data[i][2]).trim();
      seen[key] = i + 1; // last row per LabID
    }
  }
  return Object.values(seen);
}`;

let SCRIPT_URL = localStorage.getItem('hemepath_script_url') || 'https://script.google.com/macros/s/AKfycbxZLGjdSsmDxiONY91JVLyF26qYfFg0nekK5dTOdIiAnooxkzK_6b3fCPn697zHYDnD/exec';

function openConfig() {
  document.getElementById('configModal').classList.add('open');
  document.getElementById('scriptUrl').value = SCRIPT_URL;
  document.getElementById('scriptCode').textContent = APPS_SCRIPT_CODE;
}
function closeConfig() {
  document.getElementById('configModal').classList.remove('open');
}
function saveConfig() {
  SCRIPT_URL = document.getElementById('scriptUrl').value.trim();
  localStorage.setItem('hemepath_script_url', SCRIPT_URL);
  var banner = document.getElementById('setup-url-banner');
  if (banner) banner.remove();
  closeConfig();
  showToast('‚úÖ Script URL saved!', 'success');
}



// ‚îÄ‚îÄ Ready for next patient banner ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showReadyBanner(screenId, msg) {
  resetModule(screenId);
  var panel = document.getElementById(screenId);
  if (!panel) return;
  var old = document.getElementById('ready-banner');
  if (old && old.parentNode) old.parentNode.removeChild(old);
  var banner = document.createElement('div');
  banner.id = 'ready-banner';
  banner.style.cssText = 'background:#1a6a3a;color:white;padding:16px 20px;border-radius:12px;font-family:var(--mono);font-size:14px;font-weight:700;text-align:center;margin:20px 0;letter-spacing:0.05em;';
  banner.textContent = msg || '‚úÖ Saved ‚Äî Ready for next patient';
  var body = panel.querySelector('.panel-body') || panel;
  var first = body.firstElementChild;
  if (first) body.insertBefore(banner, first);
  else body.appendChild(banner);
  setTimeout(function() {
    if (banner.parentNode) banner.parentNode.removeChild(banner);
  }, 3000);
}

// ‚îÄ‚îÄ‚îÄ RESET MODULE AFTER SAVE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function resetModule(screenId) {
  var panel = document.getElementById(screenId);
  if (!panel) return;

  // ‚îÄ‚îÄ Text, number, textarea inputs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  panel.querySelectorAll('input[type="text"], input[type="number"], textarea').forEach(function(el) {
    el.value = '';
  });

  // ‚îÄ‚îÄ Select dropdowns ‚Üí reset to first option ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  panel.querySelectorAll('select').forEach(function(el) {
    el.selectedIndex = 0;
  });

  // ‚îÄ‚îÄ Radio buttons ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  panel.querySelectorAll('input[type="radio"]').forEach(function(el) {
    el.checked = false;
  });

  // ‚îÄ‚îÄ Date inputs ‚Üí reset to today ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  panel.querySelectorAll('input[type="date"]').forEach(function(el) {
    el.valueAsDate = new Date();
  });

  // ‚îÄ‚îÄ Tags / buttons / result options ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  panel.querySelectorAll('.mtag, .panel-tag, .result-opt, .tag, .ok-tag, .pp-tag, .hp-tag').forEach(function(el) {
    el.classList.remove('selected','selected-positive','selected-negative','selected-inconclusive');
  });

  // ‚îÄ‚îÄ Status classes on blocks ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  panel.querySelectorAll('.prb').forEach(function(el) {
    el.classList.remove('ok-status','pp-status','hp-status','inactive');
  });

  // ‚îÄ‚îÄ Hide card/wrap areas ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  panel.querySelectorAll('[id$="_wrap"],[id$="_card_wrap"]').forEach(function(el) {
    el.classList.add('hidden');
  });

  // ‚îÄ‚îÄ Remove visit selectors ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  panel.querySelectorAll('.visit-selector').forEach(function(el) { el.remove(); });

  // ‚îÄ‚îÄ Hide other-input wraps ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  panel.querySelectorAll('.other-input-wrap').forEach(function(el) { el.classList.add('hidden'); });

  // ‚îÄ‚îÄ Hide/clear summaries, pay bars, hints ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  panel.querySelectorAll('[id$="_summary"],[id$="_pay_status"]').forEach(function(el) {
    el.classList.add('hidden'); el.textContent = '';
  });
  panel.querySelectorAll('[id$="_pc"]').forEach(function(el) { el.innerHTML = ''; });
  panel.querySelectorAll('[id$="_uid_status"],[id$="_ordered"],[id$="_hint"]').forEach(function(el) {
    el.textContent = '';
  });
  panel.querySelectorAll('.workflow-block').forEach(function(el) {
    el.classList.remove('visible'); el.innerHTML = '';
  });

  // ‚îÄ‚îÄ Previews and hints (spans and divs) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  panel.querySelectorAll('span[id], div[id*="preview"], div[id*="hint"], div[id*="status"]').forEach(function(el) {
    el.textContent = ''; el.innerHTML = '';
  });

  // ‚îÄ‚îÄ Other suspicion input ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  var otherInp = panel.querySelector('#otherSuspicionInput');
  if (otherInp) { otherInp.value = ''; otherInp.style.display = 'none'; }

  // ‚îÄ‚îÄ Registration-specific resets ‚Äî explicit field by field ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if (screenId === 'screen-register') {

    // Identifiers
    ['reg_cr','reg_labid','reg_labid_num','reg_labid_year','reg_name',
     'reg_age','reg_jr','reg_sr','reg_tlc','reg_blasts','reg_eos',
     'reg_plasma','reg_right_imprint','reg_left_imprint'].forEach(function(id) {
      var el = document.getElementById(id);
      if (el) el.value = '';
    });
    // Year ‚Üí current year
    var yearEl = document.getElementById('reg_labid_year');
    if (yearEl) yearEl.value = new Date().getFullYear();
    // Date ‚Üí today
    var dateEl = document.getElementById('reg_date');
    if (dateEl) dateEl.valueAsDate = new Date();
    // Dropdowns ‚Üí first option
    var typeEl = document.getElementById('reg_labid_type');
    if (typeEl) typeEl.selectedIndex = 0;
    var facEl = document.getElementById('reg_faculty');
    if (facEl) facEl.selectedIndex = 0;
    // Radio buttons
    document.querySelectorAll('input[name="reg_sex"], input[name="reg_sample"]').forEach(function(el) {
      el.checked = false;
    });
    // Radio-opt selected styles
    document.querySelectorAll('#screen-register .radio-opt').forEach(function(el) {
      el.classList.remove('selected');
    });
    // CR styling
    var crEl = document.getElementById('reg_cr');
    if (crEl) crEl.classList.remove('cr-ok','cr-error');
    var hintEl = document.getElementById('cr_hint');
    if (hintEl) hintEl.textContent = '';
    // LabID preview
    var prevEl = document.getElementById('labid_preview');
    if (prevEl) { prevEl.textContent = ''; prevEl.innerHTML = ''; }
    // Other suspicion
    var otherInp = document.getElementById('otherSuspicionInput');
    if (otherInp) { otherInp.value = ''; otherInp.style.display = 'none'; }
    // All tags in register
    document.querySelectorAll('#screen-register .tag').forEach(function(el) {
      el.classList.remove('selected');
    });
    // Update preview
    setTimeout(updateLabIdPreview, 50);
  }

  // ‚îÄ‚îÄ In-memory selected lab IDs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  Object.keys(_selectedLabId).forEach(function(k) { delete _selectedLabId[k]; });
}

// ‚îÄ‚îÄ‚îÄ NAVIGATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showScreen(id) {
  // Block access to restricted screens based on role
  if (currentRole && id !== 'screen-home') {
    const roleData = ROLE_ACCESS[currentRole] || { screens: [] };
    const allowed = roleData.screens || [];
    if (!allowed.includes(id)) {
      showToast('‚ö†Ô∏è Access restricted for your role', 'error');
      return;
    }
  }
  document.querySelectorAll('.home-screen, .panel').forEach(el => {
    el.classList.remove('active');
    el.style.display = '';
  });
  const target = document.getElementById(id);
  if (id === 'screen-home') {
    target.style.display = 'block';
  } else {
    target.classList.add('active');
  }
  setTimeout(function() {
    var t = document.getElementById(id);
    if (t) t.scrollIntoView({behavior:'auto', block:'start'});
    window.scrollTo(0,0); document.documentElement.scrollTop=0; document.body.scrollTop=0;
  }, 30);
}

// ‚îÄ‚îÄ‚îÄ TAG TOGGLE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleTag(el) {
  el.classList.toggle('selected');
}
function toggleTagOther(el) {
  el.classList.toggle('selected');
  const inp = document.getElementById('otherSuspicionInput');
  inp.style.display = el.classList.contains('selected') ? 'block' : 'none';
}

function getSelectedTags() {
  const tags = Array.from(document.querySelectorAll('#suspicionTags .tag.selected'))
    .map(t => t.dataset.val);
  const other = document.getElementById('otherSuspicionInput').value.trim();
  if (other) tags.push(other);
  return tags.join(', ');
}

function getTagGroupValues(containerId) {
  return Array.from(document.querySelectorAll('#' + containerId + ' .tag.selected'))
    .map(t => t.dataset.val).join(', ');
}

// ‚îÄ‚îÄ‚îÄ PANEL TOGGLE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function togglePanel(el) { el.classList.toggle('selected'); }
function toggleMTag(el) { el.classList.toggle('selected'); }

function getSelectedPanels(containerId) {
  return Array.from(document.querySelectorAll(`#${containerId} .panel-tag.selected`))
    .map(t => t.textContent).join(', ');
}

function toggleAnc(btn, id) {
  const body = document.getElementById('anc-' + id);
  body.classList.toggle('open');
  btn.classList.toggle('open');
  if (body.classList.contains('open')) btn.classList.add('enabled');
}

// ‚îÄ‚îÄ‚îÄ PATIENT DATA STORE (in-memory + localStorage) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function saveLocal(key, obj) {
  try { localStorage.setItem('hemepath_' + key, JSON.stringify(obj)); } catch(e) {}
}
function loadLocal(key) {
  try { return JSON.parse(localStorage.getItem('hemepath_' + key)); } catch(e) { return null; }
}

// ‚îÄ‚îÄ‚îÄ VISIT KEY HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Visit-scoped key: e.g. order_fish_202600012345__A_1_2026
function vKey(type, cr, labid) {
  return type + '_' + cr + '__' + labid;
}
// Get all registrations for a CR
function getVisits(cr) {
  return loadLocal('visits_' + cr) || [];
}
// Save a visit registration
function saveVisit(cr, reg) {
  var visits = getVisits(cr);
  var idx = visits.findIndex(function(v) { return v.labid === reg.labid; });
  if (idx >= 0) visits[idx] = reg; else visits.push(reg);
  visits.sort(function(a,b) { return (a.date||'').localeCompare(b.date||''); });
  saveLocal('visits_' + cr, visits);
  saveLocal('pt_' + cr, reg); // keep latest for backwards compat
}
// Get latest visit for a CR
function getLatestVisit(cr) {
  var visits = getVisits(cr);
  return visits.length ? visits[visits.length - 1] : loadLocal('pt_' + cr);
}
// Current selected Lab ID per module (set when user picks a visit)
var _selectedLabId = {};
function getSelectedLabId(context, cr) {
  return _selectedLabId[context + '_' + cr] || (getLatestVisit(cr) || {}).labid || '';
}
function setSelectedLabId(context, cr, labid) {
  _selectedLabId[context + '_' + cr] = labid;
}


// ‚îÄ‚îÄ‚îÄ PATIENT CARD HTML ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function patientCardHTML(p) {
  return `
    <div class="pc-field"><label>CR Number</label><div class="val">${p.cr || '‚Äî'}</div></div>
    <div class="pc-field"><label>Lab ID</label><div class="val">${p.labid || '‚Äî'}</div></div>
    <div class="pc-field"><label>Name</label><div class="val">${p.name || '‚Äî'}</div></div>
    <div class="pc-field"><label>Age / Sex</label><div class="val">${p.age || '?'} yr / ${p.sex || '?'}</div></div>
    <div class="pc-field"><label>Faculty</label><div class="val">${p.faculty || '‚Äî'}</div></div>
    <div class="pc-field"><label>Reporting JR</label><div class="val">${p.jr || '‚Äî'}</div></div>
    <div class="pc-field"><label>Reporting SR</label><div class="val">${p.sr || '‚Äî'}</div></div>
    <div class="pc-field"><label>Sample / TLC</label><div class="val">${p.sample || '‚Äî'} / ${p.tlc ? p.tlc + ' √ó10‚Åπ/L' : '‚Äî'}</div></div>
    <div class="pc-field"><label>Blasts %</label><div class="val">${p.blasts !== '' && p.blasts !== undefined ? p.blasts + '%' : '‚Äî'}</div></div>
    <div class="pc-field"><label>Suspicion</label><div class="val" style="font-size:11px;">${p.suspicion || '‚Äî'}</div></div>
  `;
}

// ‚îÄ‚îÄ‚îÄ MODULE 1: REGISTER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function registerPatient() {
  const cr = document.getElementById('reg_cr').value.trim();
  // Build composite Lab ID (done inside validation below)
  updateLabIdPreview();
  const date = document.getElementById('reg_date').value;
  const name = document.getElementById('reg_name').value.trim();
  const age = document.getElementById('reg_age').value;
  const sexEl = document.querySelector('input[name="reg_sex"]:checked');
  const sex = sexEl ? sexEl.value : '';
  const sampleEl = document.querySelector('input[name="reg_sample"]:checked');
  const sample = sampleEl ? sampleEl.value : '';
  const suspicion = getSelectedTags();
  const bmQuality = getTagGroupValues('bmQualityTags');

  // ‚îÄ‚îÄ Hard validation ‚Äî every field mandatory ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const labidNum  = document.getElementById('reg_labid_num').value.trim();
  const labidYear = document.getElementById('reg_labid_year').value.trim();
  const labidType = document.getElementById('reg_labid_type').value;

  const errors = [];

  // Identifiers
  if (!cr)
    errors.push({ msg: '‚ö†Ô∏è CR Number is required', el: 'reg_cr' });
  else if (cr.length !== 12 || cr.split('').some(c => c < '0' || c > '9'))
    errors.push({ msg: '‚ö†Ô∏è CR Number must be exactly 12 digits', el: 'reg_cr' });
  if (!labidNum)
    errors.push({ msg: '‚ö†Ô∏è Lab ID ‚Äî Number is required', el: 'reg_labid_num' });
  if (!labidYear || labidYear.length !== 4)
    errors.push({ msg: '‚ö†Ô∏è Lab ID ‚Äî Year must be 4 digits', el: 'reg_labid_year' });
  if (!date)
    errors.push({ msg: '‚ö†Ô∏è Date Received is required', el: 'reg_date' });

  // Demographics
  if (!name)
    errors.push({ msg: '‚ö†Ô∏è Patient name is required', el: 'reg_name' });
  if (!age)
    errors.push({ msg: '‚ö†Ô∏è Age is required', el: 'reg_age' });
  if (!sex)
    errors.push({ msg: '‚ö†Ô∏è Sex must be selected', el: null });
  if (!document.getElementById('reg_faculty').value)
    errors.push({ msg: '‚ö†Ô∏è Faculty must be selected', el: 'reg_faculty' });
  if (!document.getElementById('reg_jr').value.trim())
    errors.push({ msg: '‚ö†Ô∏è JR name is required', el: 'reg_jr' });
  if (!document.getElementById('reg_sr').value.trim())
    errors.push({ msg: '‚ö†Ô∏è SR name is required', el: 'reg_sr' });
  if (!sample)
    errors.push({ msg: '‚ö†Ô∏è Sample type must be selected (PB or BM)', el: null });
  if (!document.getElementById('reg_tlc').value)
    errors.push({ msg: '‚ö†Ô∏è TLC is required', el: 'reg_tlc' });

  // BM Quality
  if (!bmQuality || bmQuality === '')
    errors.push({ msg: '‚ö†Ô∏è BM Quality must be selected', el: null });

  // Morphology
  if (document.getElementById('reg_blasts').value === '')
    errors.push({ msg: '‚ö†Ô∏è Blasts % is required', el: 'reg_blasts' });
  if (document.getElementById('reg_eos').value === '')
    errors.push({ msg: '‚ö†Ô∏è Eosinophils % is required', el: 'reg_eos' });
  if (document.getElementById('reg_plasma').value === '')
    errors.push({ msg: '‚ö†Ô∏è Plasma cells % is required', el: 'reg_plasma' });
  if (!document.getElementById('reg_right_imprint').value.trim())
    errors.push({ msg: '‚ö†Ô∏è Right Imprint value is required', el: 'reg_right_imprint' });
  if (!document.getElementById('reg_left_imprint').value.trim())
    errors.push({ msg: '‚ö†Ô∏è Left Imprint value is required', el: 'reg_left_imprint' });

  // Suspicion
  if (!suspicion || suspicion === '')
    errors.push({ msg: '‚ö†Ô∏è Clinical Suspicion must be selected', el: null });

  if (errors.length > 0) {
    showToast(errors[0].msg, 'error');
    const el = errors[0].el ? document.getElementById(errors[0].el) : null;
    if (el) {
      el.focus();
      el.classList.add('cr-error');
      setTimeout(() => el.classList.remove('cr-error'), 2000);
    }
    return;
  }

  // Build final labid value
  const labid = labidType + '_' + labidNum + '_' + labidYear;
  document.getElementById('reg_labid').value = labid;

  const payload = {
    sheet: 'Patients', action: 'register',
    cr, labid, date, name, age, sex, suspicion,
    faculty: document.getElementById('reg_faculty').value,
    jr: document.getElementById('reg_jr').value,
    sr: document.getElementById('reg_sr').value,
    sample,
    tlc: document.getElementById('reg_tlc').value,
    bmQuality,
    blasts: document.getElementById('reg_blasts').value,
    eos: document.getElementById('reg_eos').value,
    plasma: document.getElementById('reg_plasma').value,
    rightImprint: document.getElementById('reg_right_imprint').value,
    leftImprint: document.getElementById('reg_left_imprint').value
  };

  // Check if CR already exists with a DIFFERENT Lab ID
  const existingVisits = getVisits(cr);
  const existingLabIds = existingVisits.map(function(v){ return v.labid; });
  if (existingLabIds.length > 0 && existingLabIds.indexOf(labid) === -1) {
    // Show inline confirm banner instead of browser confirm()
    var existList = existingLabIds.join(', ');
    showDuplicateCRBanner(cr, labid, existList, payload);
    return;
  }

  saveVisit(cr, payload);
  sendToSheet(payload, '‚úÖ Patient registered successfully!');
  window.scrollTo(0,0); document.documentElement.scrollTop=0; document.body.scrollTop=0;
}

function showDuplicateCRBanner(cr, labid, existList, payload) {
  var existing = document.getElementById('dup-cr-banner');
  if (existing) existing.remove();
  var banner = document.createElement('div');
  banner.id = 'dup-cr-banner';
  banner.style.cssText = 'position:fixed;top:0;left:0;right:0;z-index:99998;background:#1a1a1a;color:white;padding:20px 24px;font-family:var(--mono);font-size:13px;box-shadow:0 4px 20px rgba(0,0,0,0.5);';
  banner.innerHTML = '<div style="margin-bottom:12px;">‚ö†Ô∏è CR <strong>' + cr + '</strong> already exists with Lab ID(s): <strong>' + existList + '</strong></div>' +
    '<div style="margin-bottom:14px;">Save as <strong>NEW visit</strong> with Lab ID: <strong style="color:var(--crimson);">' + labid + '</strong>?</div>' +
    '<div style="display:flex;gap:10px;">' +
    '<button onclick="confirmNewVisit()" style="background:var(--crimson);color:white;border:none;border-radius:8px;padding:10px 20px;font-family:var(--mono);font-weight:700;cursor:pointer;font-size:13px;">‚úÖ Yes ‚Äî New Visit</button>' +
    '<button onclick="cancelNewVisit()" style="background:#333;color:white;border:none;border-radius:8px;padding:10px 20px;font-family:var(--mono);font-weight:700;cursor:pointer;font-size:13px;">‚úó Cancel</button>' +
    '</div>';
  document.body.appendChild(banner);
  window._pendingVisitPayload = payload;
}

function cancelNewVisit() {
  var banner = document.getElementById('dup-cr-banner');
  if (banner) banner.remove();
  window._pendingVisitPayload = null;
}
function confirmNewVisit() {
  var banner = document.getElementById('dup-cr-banner');
  if (banner) banner.remove();
  var payload = window._pendingVisitPayload;
  if (!payload) return;
  saveVisit(payload.cr, payload);
  sendToSheet(payload, '‚úÖ New visit registered!');
  window._pendingVisitPayload = null;
  // Ensure register panel is active and visible
  var panel = document.getElementById('screen-register');
  if (panel) { panel.classList.add('active'); }
  window.scrollTo(0,0); document.documentElement.scrollTop=0; document.body.scrollTop=0;
}

// ‚îÄ‚îÄ‚îÄ ORDER INTERACTIONS (shared across all labs) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function togglePayment(lab, type, el) {
  const container = document.getElementById(lab + '-payment');
  container.querySelectorAll('.mtag').forEach(t => t.classList.remove('selected'));
  el.classList.add('selected');
  const bar = document.getElementById(lab + '_pay_status');
  bar.classList.remove('hidden', 'paid', 'notpaid');
  if (type === 'paid') {
    bar.textContent = '‚úÖ Payment confirmed: ' + el.textContent.trim();
    bar.classList.add('paid');
  } else {
    bar.textContent = '‚ùå Not Paid ‚Äî order will be requested only';
    bar.classList.add('notpaid');
  }
  updateLabSummary(lab);
}

// Generic panel toggle (used by rtpcr, fcm, ngsh12, ngsh9, tcr)
function toggleLabPanel(lab, el) {
  el.classList.toggle('selected');
  updateLabSummary(lab);
}

// Generic Other toggle
function toggleLabOther(lab, el) {
  el.classList.toggle('selected');
  const wrap = document.getElementById(lab + '_other_wrap');
  if (wrap) wrap.classList.toggle('hidden', !el.classList.contains('selected'));
  if (el.classList.contains('selected')) {
    document.getElementById(lab + '_other_text')?.focus();
  }
  updateLabSummary(lab);
}

// Generic summary updater
function updateLabSummary(lab) {
  const payEl = document.querySelector('#' + lab + '-payment .mtag.selected');
  const panels = Array.from(document.querySelectorAll('#' + lab + '-panels .panel-tag.selected'))
    .map(t => t.dataset.val);
  const otherInput = document.getElementById(lab + '_other_text');
  const otherText = otherInput ? otherInput.value.trim() : '';
  if (otherText && document.querySelector('#' + lab + '-panels .other-trigger.selected')) {
    panels.push('Other: ' + otherText);
  }
  const summary = document.getElementById(lab + '_summary');
  if (!summary) return;
  if (!payEl && panels.length === 0) { summary.classList.add('hidden'); return; }
  let html = '';
  if (payEl) html += '<strong>Payment</strong>' + payEl.textContent.trim();
  if (panels.length) html += (html ? '<br>' : '') + '<strong>Panels</strong>' + panels.join(' ¬∑ ');
  summary.innerHTML = html;
  summary.classList.remove('hidden');
}

// FISH-specific toggles (keep for backward compat)
function toggleFishPanel(el) {
  el.classList.toggle('selected');
  updateLabSummary('fish');
}
function toggleFishOther(el) {
  toggleLabOther('fish', el);
}
function updateFishSummary() { updateLabSummary('fish'); }

// Listen for typing in any other-text field
document.addEventListener('input', function(e) {
  if (e.target.id && e.target.id.endsWith('_other_text')) {
    const lab = e.target.id.replace('_other_text','');
    updateLabSummary(lab);
  }
});

// ‚îÄ‚îÄ‚îÄ SUB-TAB SWITCHING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function switchSubTab(module, name, btn) {
  // Scope entirely to the nearest panel-body ancestor of the clicked button
  // This prevents cross-module interference
  const panelBody = btn.closest('.panel-body');
  if (!panelBody) return;

  // Deactivate all sub-panels and sub-tabs within THIS panel-body only
  panelBody.querySelectorAll('.sub-panel').forEach(p => p.classList.remove('active'));
  panelBody.querySelectorAll('.sub-tab').forEach(t => t.classList.remove('active'));

  // Build the correct panel id prefix
  const prefixMap = { order:'order-', results:'accept-', accept:'accept-', entry:'entry-' };
  const prefix = prefixMap[module] || (module + '-');

  const el = document.getElementById(prefix + name);
  if (el) el.classList.add('active');
  btn.classList.add('active');
}



function isPanelOrdered(p, orderedPanels) {
  if (!orderedPanels.length) return true; // no order found ‚Äî show all
  const pLower = p.trim().toLowerCase();
  return orderedPanels.some(op => {
    const opClean = op.trim().replace(/^Other: /i, '').toLowerCase();
    return opClean === pLower ||
      (pLower === 'other' && op.trim().toLowerCase().startsWith('other'));
  });
}



// Consultant/admin auth now handled by verifyRolePwd()

// ‚îÄ‚îÄ‚îÄ ROLE-BASED ACCESS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const ROLE_ACCESS = {
  resident:    { screens: ['screen-register', 'screen-morph', 'screen-order'], lab: null },
  fish:        { screens: ['screen-results', 'screen-entry'], lab: 'fish' },
  fcm:         { screens: ['screen-results', 'screen-entry'], lab: 'fcm' },
  rtpcr:       { screens: ['screen-results', 'screen-entry'], lab: 'rtpcr' },
  ngsh12:      { screens: ['screen-results', 'screen-entry'], lab: 'ngsh12' },
  ngsh9:       { screens: ['screen-results', 'screen-entry'], lab: 'ngsh9' },
  tcr:         { screens: ['screen-results', 'screen-entry'], lab: 'tcr' },
  consultant:  { screens: ['screen-provbm', 'screen-report'], lab: null },
  admin:       { screens: ['screen-register', 'screen-morph', 'screen-order', 'screen-results', 'screen-entry', 'screen-provbm', 'screen-report'], lab: null },
};

const ROLE_PASSWORDS = {
  fish:       'FISH@2026',
  fcm:        'FCM@2026',
  rtpcr:      'RTPCR@2026',
  ngsh12:     'NGSH12@2026',
  ngsh9:      'NGSH9@2026',
  tcr:        'TCR@2026',
  consultant: 'Hemat@2026',
  admin:      'Sree@Feb2026',
};

const ROLE_MODULE_MAP = {
  'screen-register': 'Module 01',
  'screen-order':    'Module 03',
  'screen-results':  'Module 04',
  'screen-entry':    'Module 05',
  'screen-report':   'Module 06'
};

let currentRole = null;

function togglePwdPrompt(role) {
  const prompt = document.getElementById('pwd-prompt-' + role);
  if (!prompt) return;
  const isOpen = prompt.style.display !== 'none';
  // Close all others
  ['fish','fcm','rtpcr','ngsh12','ngsh9','tcr','consultant','admin'].forEach(r => {
    const p = document.getElementById('pwd-prompt-' + r);
    if (p) p.style.display = 'none';
  });
  if (!isOpen) {
    prompt.style.display = 'block';
    const inp = document.getElementById('pwd-input-' + role);
    if (inp) { inp.value = ''; setTimeout(() => inp.focus(), 100); }
    const err = document.getElementById('pwd-err-' + role);
    if (err) err.textContent = '';
  }
}

function verifyRolePwd(role) {
  const input = document.getElementById('pwd-input-' + role);
  const err   = document.getElementById('pwd-err-' + role);
  if (!input) return;
  if (input.value === ROLE_PASSWORDS[role]) {
    input.value = '';
    selectRole(role);
  } else {
    err.textContent = '‚ùå Incorrect password';
    input.value = '';
    input.focus();
  }
}

function selectRole(role) {
  currentRole = role;
  var roleData = ROLE_ACCESS[role] || { screens: [], lab: null };
  var allowedScreens = roleData.screens;
  var allowedLab = roleData.lab;

  // Hide role screen
  var roleEl = document.getElementById('screen-role');
  if (roleEl) roleEl.style.display = 'none';

  // Show home screen
  var homeEl = document.getElementById('screen-home');
  if (homeEl) homeEl.style.display = 'block';

  // Lock home cards
  document.querySelectorAll('.home-card').forEach(function(card) {
    var onclick = card.getAttribute('onclick') || '';
    var match = onclick.match(/showScreen\('(.+?)'\)/);
    var screen = match ? match[1] : null;
    if (screen && allowedScreens.indexOf(screen) === -1) {
      card.classList.add('locked');
    } else {
      card.classList.remove('locked');
    }
  });

  // Show/hide lab tabs based on role
  var allLabs = ['fish','fcm','rtpcr','ngsh12','ngsh9','tcr'];
  allLabs.forEach(function(lab) {
    var showTab = (!allowedLab || lab === allowedLab);
    // Acceptance tabs
    var accBtn = document.getElementById('tab-btn-accept-' + lab);
    if (accBtn) accBtn.style.display = showTab ? '' : 'none';
    // Entry tabs
    var entBtn = document.getElementById('tab-btn-entry-' + lab);
    if (entBtn) entBtn.style.display = showTab ? '' : 'none';
  });

  // Auto-click the allowed lab tab
  if (allowedLab) {
    setTimeout(function() {
      var accBtn = document.getElementById('tab-btn-accept-' + allowedLab);
      if (accBtn) accBtn.click();
      var entBtn = document.getElementById('tab-btn-entry-' + allowedLab);
      if (entBtn) entBtn.click();
    }, 150);
  }

  // Role badge
  var roleLabels = {
    resident: 'ü©∫ Resident', fish: 'üî¨ FISH', fcm: 'üî¨ FCM',
    rtpcr: 'üî¨ RT-PCR', ngsh12: 'üî¨ NGS-H12', ngsh9: 'üî¨ NGS-H9',
    tcr: 'üî¨ TCR', consultant: 'üë®‚Äç‚öïÔ∏è Consultant', admin: 'üîë Admin'
  };
  var badge = document.getElementById('role-badge');
  if (badge) {
    badge.textContent = roleLabels[role] || role;
    badge.className = 'role-badge ' + (['fish','fcm','rtpcr','ngsh12','ngsh9','tcr'].indexOf(role) >= 0 ? 'lab' : role === 'admin' ? 'senior' : role === 'consultant' ? 'senior' : 'resident');
    badge.style.display = 'block';
  }

  showScreen('screen-home');
}


function switchRole() {
  currentRole = null;
  // Reset all home cards
  document.querySelectorAll('.home-card').forEach(function(c) { c.classList.remove('locked'); });
  // Restore all lab tabs
  var allLabs = ['fish','fcm','rtpcr','ngsh12','ngsh9','tcr'];
  allLabs.forEach(function(lab) {
    var accBtn = document.getElementById('tab-btn-accept-' + lab);
    if (accBtn) accBtn.style.display = '';
    var entBtn = document.getElementById('tab-btn-entry-' + lab);
    if (entBtn) entBtn.style.display = '';
  });
  // Close any open pwd prompts
  ['fish','fcm','rtpcr','ngsh12','ngsh9','tcr','consultant','admin'].forEach(function(r) {
    var p = document.getElementById('pwd-prompt-' + r);
    if (p) p.style.display = 'none';
  });
  var badge = document.getElementById('role-badge');
  if (badge) badge.style.display = 'none';
  var homeEl = document.getElementById('screen-home');
  if (homeEl) homeEl.style.display = 'none';
  document.querySelectorAll('.panel').forEach(function(p) { p.classList.remove('active'); });
  var roleEl = document.getElementById('screen-role');
  if (roleEl) { roleEl.style.display = 'flex'; roleEl.style.zIndex = '99999'; }
}


function showScreen(id) {
  // Block access to restricted screens based on role
  if (currentRole && id !== 'screen-home') {
    const roleData = ROLE_ACCESS[currentRole] || { screens: [] };
    const allowed = roleData.screens || [];
    if (!allowed.includes(id)) {
      showToast('‚ö†Ô∏è Access restricted for your role', 'error');
      return;
    }
  }
  document.querySelectorAll('.home-screen, .panel').forEach(el => {
    el.classList.remove('active');
    el.style.display = '';
  });
  const target = document.getElementById(id);
  if (id === 'screen-home') {
    target.style.display = 'block';
  } else {
    target.classList.add('active');
  }
  setTimeout(function() {
    var t = document.getElementById(id);
    if (t) t.scrollIntoView({behavior:'auto', block:'start'});
    window.scrollTo(0,0); document.documentElement.scrollTop=0; document.body.scrollTop=0;
  }, 30);
}

// ‚îÄ‚îÄ‚îÄ TAG TOGGLE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleTag(el) {
  el.classList.toggle('selected');
}
function toggleTagOther(el) {
  el.classList.toggle('selected');
  const inp = document.getElementById('otherSuspicionInput');
  inp.style.display = el.classList.contains('selected') ? 'block' : 'none';
}

function getSelectedTags() {
  const tags = Array.from(document.querySelectorAll('#suspicionTags .tag.selected'))
    .map(t => t.dataset.val);
  const other = document.getElementById('otherSuspicionInput').value.trim();
  if (other) tags.push(other);
  return tags.join(', ');
}

function getTagGroupValues(containerId) {
  return Array.from(document.querySelectorAll('#' + containerId + ' .tag.selected'))
    .map(t => t.dataset.val).join(', ');
}

// ‚îÄ‚îÄ‚îÄ PANEL TOGGLE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function togglePanel(el) { el.classList.toggle('selected'); }
function toggleMTag(el) { el.classList.toggle('selected'); }

function getSelectedPanels(containerId) {
  return Array.from(document.querySelectorAll(`#${containerId} .panel-tag.selected`))
    .map(t => t.textContent).join(', ');
}

function toggleAnc(btn, id) {
  const body = document.getElementById('anc-' + id);
  body.classList.toggle('open');
  btn.classList.toggle('open');
  if (body.classList.contains('open')) btn.classList.add('enabled');
}

// ‚îÄ‚îÄ‚îÄ PATIENT DATA STORE (in-memory + localStorage) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function saveLocal(key, obj) {
  try { localStorage.setItem('hemepath_' + key, JSON.stringify(obj)); } catch(e) {}
}
function loadLocal(key) {
  try { return JSON.parse(localStorage.getItem('hemepath_' + key)); } catch(e) { return null; }
}

// ‚îÄ‚îÄ‚îÄ VISIT KEY HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Visit-scoped key: e.g. order_fish_202600012345__A_1_2026
function vKey(type, cr, labid) {
  return type + '_' + cr + '__' + labid;
}
// Get all registrations for a CR
function getVisits(cr) {
  return loadLocal('visits_' + cr) || [];
}
// Save a visit registration
function saveVisit(cr, reg) {
  var visits = getVisits(cr);
  var idx = visits.findIndex(function(v) { return v.labid === reg.labid; });
  if (idx >= 0) visits[idx] = reg; else visits.push(reg);
  visits.sort(function(a,b) { return (a.date||'').localeCompare(b.date||''); });
  saveLocal('visits_' + cr, visits);
  saveLocal('pt_' + cr, reg); // keep latest for backwards compat
}
// Get latest visit for a CR
function getLatestVisit(cr) {
  var visits = getVisits(cr);
  return visits.length ? visits[visits.length - 1] : loadLocal('pt_' + cr);
}
// Current selected Lab ID per module (set when user picks a visit)
var _selectedLabId = {};
function getSelectedLabId(context, cr) {
  return _selectedLabId[context + '_' + cr] || (getLatestVisit(cr) || {}).labid || '';
}
function setSelectedLabId(context, cr, labid) {
  _selectedLabId[context + '_' + cr] = labid;
}


// ‚îÄ‚îÄ‚îÄ PATIENT CARD HTML ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function patientCardHTML(p) {
  return `
    <div class="pc-field"><label>CR Number</label><div class="val">${p.cr || '‚Äî'}</div></div>
    <div class="pc-field"><label>Lab ID</label><div class="val">${p.labid || '‚Äî'}</div></div>
    <div class="pc-field"><label>Name</label><div class="val">${p.name || '‚Äî'}</div></div>
    <div class="pc-field"><label>Age / Sex</label><div class="val">${p.age || '?'} yr / ${p.sex || '?'}</div></div>
    <div class="pc-field"><label>Faculty</label><div class="val">${p.faculty || '‚Äî'}</div></div>
    <div class="pc-field"><label>Reporting JR</label><div class="val">${p.jr || '‚Äî'}</div></div>
    <div class="pc-field"><label>Reporting SR</label><div class="val">${p.sr || '‚Äî'}</div></div>
    <div class="pc-field"><label>Sample / TLC</label><div class="val">${p.sample || '‚Äî'} / ${p.tlc ? p.tlc + ' √ó10‚Åπ/L' : '‚Äî'}</div></div>
    <div class="pc-field"><label>Blasts %</label><div class="val">${p.blasts !== '' && p.blasts !== undefined ? p.blasts + '%' : '‚Äî'}</div></div>
    <div class="pc-field"><label>Suspicion</label><div class="val" style="font-size:11px;">${p.suspicion || '‚Äî'}</div></div>
  `;
}

// ‚îÄ‚îÄ‚îÄ MODULE 1: REGISTER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function registerPatient() {
  const cr = document.getElementById('reg_cr').value.trim();
  // Build composite Lab ID (done inside validation below)
  updateLabIdPreview();
  const date = document.getElementById('reg_date').value;
  const name = document.getElementById('reg_name').value.trim();
  const age = document.getElementById('reg_age').value;
  const sexEl = document.querySelector('input[name="reg_sex"]:checked');
  const sex = sexEl ? sexEl.value : '';
  const sampleEl = document.querySelector('input[name="reg_sample"]:checked');
  const sample = sampleEl ? sampleEl.value : '';
  const suspicion = getSelectedTags();
  const bmQuality = getTagGroupValues('bmQualityTags');

  // ‚îÄ‚îÄ Hard validation ‚Äî every field mandatory ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const labidNum  = document.getElementById('reg_labid_num').value.trim();
  const labidYear = document.getElementById('reg_labid_year').value.trim();
  const labidType = document.getElementById('reg_labid_type').value;

  const errors = [];

  // Identifiers
  if (!cr)
    errors.push({ msg: '‚ö†Ô∏è CR Number is required', el: 'reg_cr' });
  else if (cr.length !== 12 || cr.split('').some(c => c < '0' || c > '9'))
    errors.push({ msg: '‚ö†Ô∏è CR Number must be exactly 12 digits', el: 'reg_cr' });
  if (!labidNum)
    errors.push({ msg: '‚ö†Ô∏è Lab ID ‚Äî Number is required', el: 'reg_labid_num' });
  if (!labidYear || labidYear.length !== 4)
    errors.push({ msg: '‚ö†Ô∏è Lab ID ‚Äî Year must be 4 digits', el: 'reg_labid_year' });
  if (!date)
    errors.push({ msg: '‚ö†Ô∏è Date Received is required', el: 'reg_date' });

  // Demographics
  if (!name)
    errors.push({ msg: '‚ö†Ô∏è Patient name is required', el: 'reg_name' });
  if (!age)
    errors.push({ msg: '‚ö†Ô∏è Age is required', el: 'reg_age' });
  if (!sex)
    errors.push({ msg: '‚ö†Ô∏è Sex must be selected', el: null });
  if (!document.getElementById('reg_faculty').value)
    errors.push({ msg: '‚ö†Ô∏è Faculty must be selected', el: 'reg_faculty' });
  if (!document.getElementById('reg_jr').value.trim())
    errors.push({ msg: '‚ö†Ô∏è JR name is required', el: 'reg_jr' });
  if (!document.getElementById('reg_sr').value.trim())
    errors.push({ msg: '‚ö†Ô∏è SR name is required', el: 'reg_sr' });
  if (!sample)
    errors.push({ msg: '‚ö†Ô∏è Sample type must be selected (PB or BM)', el: null });
  if (!document.getElementById('reg_tlc').value)
    errors.push({ msg: '‚ö†Ô∏è TLC is required', el: 'reg_tlc' });

  // BM Quality
  if (!bmQuality || bmQuality === '')
    errors.push({ msg: '‚ö†Ô∏è BM Quality must be selected', el: null });

  // Morphology
  if (document.getElementById('reg_blasts').value === '')
    errors.push({ msg: '‚ö†Ô∏è Blasts % is required', el: 'reg_blasts' });
  if (document.getElementById('reg_eos').value === '')
    errors.push({ msg: '‚ö†Ô∏è Eosinophils % is required', el: 'reg_eos' });
  if (document.getElementById('reg_plasma').value === '')
    errors.push({ msg: '‚ö†Ô∏è Plasma cells % is required', el: 'reg_plasma' });
  if (!document.getElementById('reg_right_imprint').value.trim())
    errors.push({ msg: '‚ö†Ô∏è Right Imprint value is required', el: 'reg_right_imprint' });
  if (!document.getElementById('reg_left_imprint').value.trim())
    errors.push({ msg: '‚ö†Ô∏è Left Imprint value is required', el: 'reg_left_imprint' });

  // Suspicion
  if (!suspicion || suspicion === '')
    errors.push({ msg: '‚ö†Ô∏è Clinical Suspicion must be selected', el: null });

  if (errors.length > 0) {
    showToast(errors[0].msg, 'error');
    const el = errors[0].el ? document.getElementById(errors[0].el) : null;
    if (el) {
      el.focus();
      el.classList.add('cr-error');
      setTimeout(() => el.classList.remove('cr-error'), 2000);
    }
    return;
  }

  // Build final labid value
  const labid = labidType + '_' + labidNum + '_' + labidYear;
  document.getElementById('reg_labid').value = labid;

  const payload = {
    sheet: 'Patients', action: 'register',
    cr, labid, date, name, age, sex, suspicion,
    faculty: document.getElementById('reg_faculty').value,
    jr: document.getElementById('reg_jr').value,
    sr: document.getElementById('reg_sr').value,
    sample,
    tlc: document.getElementById('reg_tlc').value,
    bmQuality,
    blasts: document.getElementById('reg_blasts').value,
    eos: document.getElementById('reg_eos').value,
    plasma: document.getElementById('reg_plasma').value,
    rightImprint: document.getElementById('reg_right_imprint').value,
    leftImprint: document.getElementById('reg_left_imprint').value
  };

  // Check if CR already exists with a DIFFERENT Lab ID
  const existingVisits = getVisits(cr);
  const existingLabIds = existingVisits.map(function(v){ return v.labid; });
  if (existingLabIds.length > 0 && existingLabIds.indexOf(labid) === -1) {
    // Show inline confirm banner instead of browser confirm()
    var existList = existingLabIds.join(', ');
    showDuplicateCRBanner(cr, labid, existList, payload);
    return;
  }

  saveVisit(cr, payload);
  sendToSheet(payload, '‚úÖ Patient registered successfully!');
}

function showDuplicateCRBanner(cr, labid, existList, payload) {
  var existing = document.getElementById('dup-cr-banner');
  if (existing) existing.remove();
  var banner = document.createElement('div');
  banner.id = 'dup-cr-banner';
  banner.style.cssText = 'position:fixed;top:0;left:0;right:0;z-index:99998;background:#1a1a1a;color:white;padding:20px 24px;font-family:var(--mono);font-size:13px;box-shadow:0 4px 20px rgba(0,0,0,0.5);';
  banner.innerHTML = '<div style="margin-bottom:12px;">‚ö†Ô∏è CR <strong>' + cr + '</strong> already exists with Lab ID(s): <strong>' + existList + '</strong></div>' +
    '<div style="margin-bottom:14px;">Save as <strong>NEW visit</strong> with Lab ID: <strong style="color:var(--crimson);">' + labid + '</strong>?</div>' +
    '<div style="display:flex;gap:10px;">' +
    '<button onclick="confirmNewVisit()" style="background:var(--crimson);color:white;border:none;border-radius:8px;padding:10px 20px;font-family:var(--mono);font-weight:700;cursor:pointer;font-size:13px;">‚úÖ Yes ‚Äî New Visit</button>' +
    '<button onclick="cancelNewVisit()" style="background:#333;color:white;border:none;border-radius:8px;padding:10px 20px;font-family:var(--mono);font-weight:700;cursor:pointer;font-size:13px;">‚úó Cancel</button>' +
    '</div>';
  document.body.appendChild(banner);
  window._pendingVisitPayload = payload;
}

function cancelNewVisit() {
  var banner = document.getElementById('dup-cr-banner');
  if (banner) banner.remove();
  window._pendingVisitPayload = null;
}
function confirmNewVisit() {
  var banner = document.getElementById('dup-cr-banner');
  if (banner) banner.remove();
  var payload = window._pendingVisitPayload;
  if (!payload) return;
  saveVisit(payload.cr, payload);
  sendToSheet(payload, '‚úÖ New visit registered!');
  window._pendingVisitPayload = null;
}

// ‚îÄ‚îÄ‚îÄ ORDER INTERACTIONS (shared across all labs) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function togglePayment(lab, type, el) {
  const container = document.getElementById(lab + '-payment');
  container.querySelectorAll('.mtag').forEach(t => t.classList.remove('selected'));
  el.classList.add('selected');
  const bar = document.getElementById(lab + '_pay_status');
  bar.classList.remove('hidden', 'paid', 'notpaid');
  if (type === 'paid') {
    bar.textContent = '‚úÖ Payment confirmed: ' + el.textContent.trim();
    bar.classList.add('paid');
  } else {
    bar.textContent = '‚ùå Not Paid ‚Äî order will be requested only';
    bar.classList.add('notpaid');
  }
  updateLabSummary(lab);
}

// Generic panel toggle (used by rtpcr, fcm, ngsh12, ngsh9, tcr)
function toggleLabPanel(lab, el) {
  el.classList.toggle('selected');
  updateLabSummary(lab);
}

// Generic Other toggle
function toggleLabOther(lab, el) {
  el.classList.toggle('selected');
  const wrap = document.getElementById(lab + '_other_wrap');
  if (wrap) wrap.classList.toggle('hidden', !el.classList.contains('selected'));
  if (el.classList.contains('selected')) {
    document.getElementById(lab + '_other_text')?.focus();
  }
  updateLabSummary(lab);
}

// Generic summary updater
function updateLabSummary(lab) {
  const payEl = document.querySelector('#' + lab + '-payment .mtag.selected');
  const panels = Array.from(document.querySelectorAll('#' + lab + '-panels .panel-tag.selected'))
    .map(t => t.dataset.val);
  const otherInput = document.getElementById(lab + '_other_text');
  const otherText = otherInput ? otherInput.value.trim() : '';
  if (otherText && document.querySelector('#' + lab + '-panels .other-trigger.selected')) {
    panels.push('Other: ' + otherText);
  }
  const summary = document.getElementById(lab + '_summary');
  if (!summary) return;
  if (!payEl && panels.length === 0) { summary.classList.add('hidden'); return; }
  let html = '';
  if (payEl) html += '<strong>Payment</strong>' + payEl.textContent.trim();
  if (panels.length) html += (html ? '<br>' : '') + '<strong>Panels</strong>' + panels.join(' ¬∑ ');
  summary.innerHTML = html;
  summary.classList.remove('hidden');
}

// FISH-specific toggles (keep for backward compat)
function toggleFishPanel(el) {
  el.classList.toggle('selected');
  updateLabSummary('fish');
}
function toggleFishOther(el) {
  toggleLabOther('fish', el);
}
function updateFishSummary() { updateLabSummary('fish'); }

// Listen for typing in any other-text field
document.addEventListener('input', function(e) {
  if (e.target.id && e.target.id.endsWith('_other_text')) {
    const lab = e.target.id.replace('_other_text','');
    updateLabSummary(lab);
  }
});

// ‚îÄ‚îÄ‚îÄ SUB-TAB SWITCHING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function switchSubTab(module, name, btn) {
  // Scope entirely to the nearest panel-body ancestor of the clicked button
  // This prevents cross-module interference
  const panelBody = btn.closest('.panel-body');
  if (!panelBody) return;

  // Deactivate all sub-panels and sub-tabs within THIS panel-body only
  panelBody.querySelectorAll('.sub-panel').forEach(p => p.classList.remove('active'));
  panelBody.querySelectorAll('.sub-tab').forEach(t => t.classList.remove('active'));

  // Build the correct panel id prefix
  const prefixMap = { order:'order-', results:'accept-', accept:'accept-', entry:'entry-' };
  const prefix = prefixMap[module] || (module + '-');

  const el = document.getElementById(prefix + name);
  if (el) el.classList.add('active');
  btn.classList.add('active');
}



function isPanelOrdered(p, orderedPanels) {
  if (!orderedPanels.length) return true; // no order found ‚Äî show all
  const pLower = p.trim().toLowerCase();
  return orderedPanels.some(op => {
    const opClean = op.trim().replace(/^Other: /i, '').toLowerCase();
    return opClean === pLower ||
      (pLower === 'other' && op.trim().toLowerCase().startsWith('other'));
  });
}



// Consultant/admin auth now handled by verifyRolePwd()

// ‚îÄ‚îÄ‚îÄ ROLE-BASED ACCESS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

// ‚îÄ‚îÄ‚îÄ LAB ID + CR HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateLabIdPreview() {
  const type = document.getElementById('reg_labid_type')?.value || 'A';
  const num  = document.getElementById('reg_labid_num')?.value.trim() || '';
  const year = document.getElementById('reg_labid_year')?.value.trim() || '';
  const hidden = document.getElementById('reg_labid');
  const preview = document.getElementById('labid_preview');
  if (num && year) {
    const val = type + '_' + num + '_' + year;
    if (hidden) hidden.value = val;
    if (preview) preview.textContent = '‚Üí ' + val;
  } else {
    if (hidden) hidden.value = '';
    if (preview) preview.textContent = num || year ? '‚ö† Enter both number and year' : '';
  }
}

function validateCR(input) {
  const hint = document.getElementById('cr_hint');
  input.classList.remove('cr-error','cr-ok');
  if (!input.value) { if (hint) hint.textContent = ''; return; }
  if (input.value.length === 12) {
    input.classList.add('cr-ok');
    if (hint) hint.textContent = '‚úÖ Valid 12-digit CR';
  } else {
    input.classList.add('cr-error');
    if (hint) hint.textContent = (12 - input.value.length) + ' more digit(s) needed';
  }
}

// Auto-fill year field on load
document.addEventListener('DOMContentLoaded', function() {
  // If no script URL configured, show setup prompt after role selection
  if (!SCRIPT_URL) {
    var banner = document.createElement('div');
    banner.id = 'setup-url-banner';
    banner.style.cssText = 'position:fixed;bottom:70px;left:0;right:0;z-index:9999;background:#7a1020;color:white;padding:14px 20px;font-family:var(--mono);font-size:12px;text-align:center;box-shadow:0 -4px 20px rgba(0,0,0,0.4);';
    banner.innerHTML = '‚ö†Ô∏è Google Sheets not configured. Tap <strong>‚öô Config</strong> (bottom left) and enter your Apps Script URL to enable syncing.';
    document.body.appendChild(banner);
  }
  // Set default year in lab ID
  const yearEl = document.getElementById('reg_labid_year');
  if (yearEl && !yearEl.value) yearEl.value = new Date().getFullYear();
  updateLabIdPreview();

  // Set default date
  const dateEl = document.getElementById('reg_date');
  if (dateEl) dateEl.valueAsDate = new Date();

  // Hide home screen, show role selection
  const homeEl = document.getElementById('screen-home');
  if (homeEl) homeEl.style.display = 'none';

  const roleEl = document.getElementById('screen-role');
  if (roleEl) {
    roleEl.style.display = 'flex';
    roleEl.style.zIndex = '99999';
  }
});


// ‚îÄ‚îÄ‚îÄ UNIQUE LAB ID CHECK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function checkUniqueLabId(lab, input) {
  const val = input.value.trim();
  const statusEl = document.getElementById('a' + lab + '_uid_status');
  if (!val) { statusEl.textContent = ''; statusEl.style.color = ''; return; }

  // Check against all saved acceptance records for this lab
  const allKeys = Object.keys(localStorage);
  const duplicate = allKeys.some(k => {
    if (!k.startsWith('hemepath_accept_' + lab + '_')) return false;
    try {
      const saved = JSON.parse(localStorage.getItem(k));
      const savedUid = saved && saved.uniqueLabId ? saved.uniqueLabId.trim().toLowerCase() : '';
      return savedUid && savedUid === val.toLowerCase();
    } catch(e) { return false; }
  });

  if (duplicate) {
    statusEl.textContent = '‚ö†Ô∏è This Unique Lab ID already exists for ' + lab.toUpperCase() + ' ‚Äî possible duplicate!';
    statusEl.style.color = 'var(--crimson)';
    input.classList.add('cr-error');
  } else {
    statusEl.textContent = '‚úÖ ID available';
    statusEl.style.color = '#1a6a3a';
    input.classList.remove('cr-error');
  }
}


// ‚îÄ‚îÄ‚îÄ RESULT ENTRY OPTION SELECTION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function selectResult(prefix, pid, el) {
  const val = el.dataset.val;
  const resultEl = document.getElementById(prefix + '_' + pid + '_result');
  const otherWrap = document.getElementById(prefix + '_' + pid + '_other_wrap');

  // Handle Others ‚Äî single select only
  if (val === 'Others') {
    // Deselect Others if already selected
    if (el.classList.contains('selected')) {
      el.classList.remove('selected');
      if (otherWrap) otherWrap.classList.add('hidden');
    } else {
      el.classList.add('selected');
      if (otherWrap) otherWrap.classList.remove('hidden');
    }
    _updateResultValue(prefix, pid);
    return;
  }
  if (otherWrap) otherWrap.classList.add('hidden');

  // Toggle this option ‚Äî multi-select allowed
  const isSelected = el.classList.contains('selected-negative') ||
                     el.classList.contains('selected-positive') ||
                     el.classList.contains('selected-inconclusive');

  if (isSelected) {
    // Deselect
    el.classList.remove('selected','selected-positive','selected-negative','selected-inconclusive');
  } else {
    // Select with color coding
    const valL = val.toLowerCase();
    if (valL.includes('negative') || valL.includes('normal') || valL.includes('no fusion') ||
        valL.includes('no mutation') || valL.includes('no cnv') || valL.includes('wild type') ||
        valL === 'polyclonal') {
      el.classList.add('selected-negative');
    } else if (valL.includes('inconclusive') || valL.includes('failed') || valL.includes('vus')) {
      el.classList.add('selected-inconclusive');
    } else {
      el.classList.add('selected-positive');
    }
  }

  _updateResultValue(prefix, pid);
}

function _updateResultValue(prefix, pid) {
  // Collect all selected result values for this panel
  const opts = document.getElementById(prefix + '_' + pid + '_opts');
  const resultEl = document.getElementById(prefix + '_' + pid + '_result');
  if (!opts || !resultEl) return;
  const selected = [];
  opts.querySelectorAll('.result-opt.selected, .result-opt.selected-positive, .result-opt.selected-negative, .result-opt.selected-inconclusive').forEach(function(o) {
    selected.push(o.dataset.val);
  });
  // Check if Others is selected ‚Äî append other text
  var otherWrap = document.getElementById(prefix + '_' + pid + '_other_wrap');
  var otherText = document.getElementById(prefix + '_' + pid + '_other_text');
  if (otherWrap && !otherWrap.classList.contains('hidden') && otherText && otherText.value.trim()) {
    selected.push(otherText.value.trim());
  }
  resultEl.value = selected.join(' | ');
}




// ‚îÄ‚îÄ‚îÄ CONFIG PASSWORD GATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function promptConfig() {
  const overlay = document.getElementById('config-pwd-overlay');
  overlay.style.display = 'flex';
  document.getElementById('config-pwd-input').value = '';
  document.getElementById('config-pwd-error').textContent = '';
  setTimeout(() => document.getElementById('config-pwd-input').focus(), 100);
}
function closeConfigPrompt() {
  document.getElementById('config-pwd-overlay').style.display = 'none';
}
function verifyConfig() {
  const input = document.getElementById('config-pwd-input');
  const err   = document.getElementById('config-pwd-error');
  if (input.value === 'Sree@Feb2026') {
    closeConfigPrompt();
    openConfig();
  } else {
    err.textContent = '‚ùå Incorrect password';
    input.value = '';
    input.focus();
  }
}



// ‚îÄ‚îÄ‚îÄ VISIT SELECTOR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ‚îÄ‚îÄ Report visit selector ‚Äî switches which LabID report is downloaded ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function _reportVisitSelectorHTML(cr, visits, currentLabId) {
  var html = '<div class="visit-selector" style="margin-bottom:12px;padding:10px;background:#f8f8f8;border-radius:10px;border:1px solid var(--border);">';
  html += '<div style="font-size:10px;color:var(--slate);font-family:var(--mono);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.05em;">Select Visit to Download</div>';
  html += '<div style="display:flex;flex-wrap:wrap;gap:6px;">';
  visits.forEach(function(v) {
    var sel = v.labid === currentLabId;
    var btnStyle = 'padding:7px 11px;border-radius:8px;border:1.5px solid ' +
      (sel ? 'var(--crimson);background:var(--crimson);color:white;' : 'var(--border);background:white;color:var(--dark);') +
      'font-family:var(--mono);font-size:11px;font-weight:700;cursor:pointer;line-height:1.3;';
    var safeLabid = v.labid.replace(/'/g, '');
    var safeCr = cr.replace(/'/g, '');
    html += '<button onclick="_switchReportVisit(\'' + safeCr + '\',\'' + safeLabid + '\',this)" style="' + btnStyle + '">';
    html += v.labid;
    if (v.date) html += '<br><span style="font-size:9px;font-weight:400;">' + v.date + '</span>';
    html += '</button>';
  });
  html += '</div></div>';
  return html;
}
function _switchReportVisit(cr, labid, btn) {
  window._lastReportLabId = labid;
  var parent = btn.closest('.visit-selector');
  if (parent) {
    parent.querySelectorAll('button').forEach(function(b) {
      b.style.background='white'; b.style.color='var(--dark)'; b.style.borderColor='var(--border)';
    });
    btn.style.background='var(--crimson)'; btn.style.color='white'; btn.style.borderColor='var(--crimson)';
  }
  var visit = getVisits(cr).find(function(v){return v.labid===labid;}) || getLatestVisit(cr);
  document.getElementById('rpt_patient_card').innerHTML = patientCardHTML(visit);
}


function _visitSelectorHTML(context, cr, visits, currentLabId) {
  var html = '<div class="visit-selector" style="margin-bottom:10px;padding:10px;background:#f8f8f8;border-radius:10px;border:1px solid var(--border);">';
  html += '<div style="font-size:10px;color:var(--slate);font-family:var(--mono);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.05em;">Select Visit</div>';
  html += '<div style="display:flex;flex-wrap:wrap;gap:6px;">';
  visits.forEach(function(v) {
    var sel = v.labid === currentLabId;
    html += '<button onclick="_switchVisit(\'' + context + '\',\'' + cr + '\',\'' + v.labid + '\',this)" ';
    html += 'style="padding:7px 11px;border-radius:8px;border:1.5px solid ';
    html += sel ? 'var(--crimson);background:var(--crimson);color:white;' : 'var(--border);background:white;color:var(--dark);';
    html += 'font-family:var(--mono);font-size:11px;font-weight:700;cursor:pointer;line-height:1.3;">';
    html += v.labid;
    if (v.date) html += '<br><span style="font-size:9px;font-weight:400;">' + v.date + '</span>';
    html += '</button>';
  });
  html += '</div></div>';
  return html;
}
function _switchVisit(context, cr, labid, btn) {
  setSelectedLabId(context, cr, labid);
  var parent = btn.closest('.visit-selector');
  if (parent) {
    parent.querySelectorAll('button').forEach(function(b) {
      b.style.background='white'; b.style.color='var(--dark)'; b.style.borderColor='var(--border)';
    });
    btn.style.background='var(--crimson)'; btn.style.color='white'; btn.style.borderColor='var(--crimson)';
  }
  var visits = getVisits(cr);
  var visit = visits.find(function(v){return v.labid===labid;}) || getLatestVisit(cr);
  var parts = context.split('_');
  var mod = parts[0]; // order, accept, entry, morph
  var lab = parts.slice(1).join('_');
  if (mod === 'order')  renderOrderCard(lab, visit, cr);
  if (mod === 'accept') renderAcceptanceCard(lab, visit, cr);
  if (mod === 'entry')  renderEntryCard(lab, visit, cr);
  if (mod === 'morph')  renderMorphCard(visit, cr);
  // Also update provbm textarea if it's open for same CR
  if (mod === 'morph') {
    var provCR = document.getElementById('provbm_cr') ? document.getElementById('provbm_cr').value.trim() : '';
    if (provCR === cr) {
      window._lastProvBMCR_labid = labid;
      var morph = labid ? loadLocal(vKey('morph', cr, labid)) : null;
      var ta = document.getElementById('provbm_report');
      if (ta) ta.value = (morph && morph.report) ? morph.report : '';
      document.getElementById('provbm_pc').innerHTML = patientCardHTML(visit);
    }
  }
}

function buildVisitSelector(cr, context, onSelect) {
  var visits = getVisits(cr);
  if (!visits || visits.length === 0) {
    // fallback to legacy pt_ key
    var pt = loadLocal('pt_' + cr);
    if (pt) visits = [pt];
  }
  if (!visits || visits.length === 0) return null;

  var currentLabId = getSelectedLabId(context, cr) || visits[visits.length-1].labid;
  setSelectedLabId(context, cr, currentLabId);

  if (visits.length === 1) {
    // Only one visit - no selector needed
    onSelect(currentLabId, visits[0]);
    return;
  }

  // Multiple visits - show selector
  var html = '<div class="visit-selector">';
  html += '<div style="font-size:11px;color:var(--slate);font-family:var(--mono);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.05em;">Select Visit</div>';
  html += '<div style="display:flex;flex-wrap:wrap;gap:6px;">';
  visits.forEach(function(v, i) {
    var isSelected = v.labid === currentLabId;
    html += '<button onclick="selectVisitBtn(\'' + context + '\',\'' + cr + '\',\'' + v.labid + '\',this)" ';
    html += 'style="padding:8px 12px;border-radius:8px;border:1.5px solid ' + (isSelected ? 'var(--crimson)' : 'var(--border)') + ';';
    html += 'background:' + (isSelected ? 'var(--crimson)' : 'white') + ';';
    html += 'color:' + (isSelected ? 'white' : 'var(--dark)') + ';';
    html += 'font-family:var(--mono);font-size:12px;font-weight:700;cursor:pointer;">';
    html += v.labid + (v.date ? '<br><span style="font-size:10px;font-weight:400;">' + v.date + '</span>' : '');
    html += '</button>';
  });
  html += '</div></div>';
  return {html: html, visits: visits, currentLabId: currentLabId};
}

function selectVisitBtn(context, cr, labid, btn) {
  setSelectedLabId(context, cr, labid);
  // Update button styles
  var parent = btn.closest('.visit-selector');
  if (parent) {
    parent.querySelectorAll('button').forEach(function(b) {
      b.style.background = 'white';
      b.style.color = 'var(--dark)';
      b.style.borderColor = 'var(--border)';
    });
    btn.style.background = 'var(--crimson)';
    btn.style.color = 'white';
    btn.style.borderColor = 'var(--crimson)';
  }
  // Re-trigger the load for this context
  if (context === 'order') {
    var lab = btn.closest('.sub-panel') ? btn.closest('.sub-panel').id.replace('order-','') : null;
    if (lab) { var visit = getVisits(cr).find(function(v){return v.labid===labid;}); if(visit) renderOrderCard(lab, visit, cr); }
  } else if (context === 'accept') {
    var lab = btn.closest('.sub-panel') ? btn.closest('.sub-panel').id.replace('accept-','') : null;
    if (lab) { var visit = getVisits(cr).find(function(v){return v.labid===labid;}); if(visit) renderAcceptanceCard(lab, visit, cr); }
  } else if (context === 'entry') {
    var lab = btn.closest('.sub-panel') ? btn.closest('.sub-panel').id.replace('entry-','') : null;
    if (lab) { var visit = getVisits(cr).find(function(v){return v.labid===labid;}); if(visit) renderEntryCard(lab, visit, cr); }
  } else if (context === 'morph') {
    var visit = getVisits(cr).find(function(v){return v.labid===labid;});
    if (visit) renderMorphCard(visit, cr);
  }
}

// ‚îÄ‚îÄ‚îÄ FETCH FROM SHEET ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Fetches all data for a CR from Google Sheets and caches locally
function fetchAllFromSheet(cr, callback) {
  if (!SCRIPT_URL) { showToast('‚ö†Ô∏è Script URL not configured', 'error'); callback(false); return; }
  showToast('üîÑ Fetching from server‚Ä¶');
  var url = SCRIPT_URL + (SCRIPT_URL.indexOf('?') === -1 ? '?' : '&') + 'cr=' + encodeURIComponent(cr) + '&type=fetch_all';
  fetch(url)
    .then(function(r) { return r.json(); })
    .then(function(res) {
      if (!res || res.status !== 'ok' || !res.data) {
        showToast('‚ö†Ô∏è CR not found on server', 'error');
        callback(false); return;
      }
      var d = res.data;
      if (d.patient) {
        var p = d.patient;
        var ptObj = {
          cr: p[1]||'', labid: p[2]||'', date: p[3]||'', name: p[4]||'',
          age: p[5]||'', sex: p[6]||'', faculty: p[7]||'', jr: p[8]||'',
          sr: p[9]||'', sample: p[10]||'', tlc: p[11]||'',
          bmQuality: p[12]||'', blasts: p[13]||'', eos: p[14]||'',
          plasma: p[15]||'', rightImprint: p[16]||'', leftImprint: p[17]||'',
          suspicion: p[18]||''
        };
        saveVisit(cr, ptObj);
      }
      if (d.patients) {
        // Multiple rows returned for this CR
        d.patients.forEach(function(p) {
          var ptObj = {
            cr: p[1]||'', labid: p[2]||'', date: p[3]||'', name: p[4]||'',
            age: p[5]||'', sex: p[6]||'', faculty: p[7]||'', jr: p[8]||'',
            sr: p[9]||'', sample: p[10]||'', tlc: p[11]||'',
            bmQuality: p[12]||'', blasts: p[13]||'', eos: p[14]||'',
            plasma: p[15]||'', rightImprint: p[16]||'', leftImprint: p[17]||'',
            suspicion: p[18]||''
          };
          saveVisit(cr, ptObj);
        });
      }
      if (d.morph) {
        var m = d.morph;
        var mLabId = m[2] || '';
        var morphObj = {report: m[4]||'', labid: mLabId};
        saveLocal('morph_' + cr, morphObj); // legacy
        if (mLabId) saveLocal(vKey('morph', cr, mLabId), morphObj); // visit-scoped
      }
      if (d.morph_all) {
        d.morph_all.forEach(function(m) {
          var mLabId = m[2] || '';
          var morphObj = {report: m[4]||'', labid: mLabId};
          if (mLabId) saveLocal(vKey('morph', cr, mLabId), morphObj);
          saveLocal('morph_' + cr, morphObj); // legacy = last one
        });
      }
      var labKeys = ['fish','fcm','rtpcr','ngsh12','ngsh9','tcr'];
      // Helper: cache one lab row by its LabID
      function cacheLabRow(key, row, cr) {
        var labid    = row[2] || '';
        var panels   = row[7] || '';
        var payment  = row[5] || '';
        var notes    = row[6] || '';
        var uniqueId = row[3] || '';
        if (panels) {
          var orderData = {panels: panels, payment: payment, notes: notes, labid: labid};
          if (labid) saveLocal(vKey('order_' + key, cr, labid), orderData);
          saveLocal('order_' + key + '_' + cr, orderData); // legacy
        }
        var panelList = panels ? panels.split(' | ').map(function(s){return s.trim();}) : [];
        if (panelList.length > 0) {
          var panelStatus = {};
          var panelResults = {};
          panelList.forEach(function(p, i) {
            var st = row[8 + (i*2)] || '';
            var rs = row[9 + (i*2)] || '';
            if (st) panelStatus[p] = st;
            if (rs) panelResults[p] = rs;
          });
          if (Object.keys(panelStatus).length > 0) {
            var accData = {panelStatus: panelStatus, uniqueLabId: uniqueId, payment: payment, notes: notes, labid: labid};
            if (labid) saveLocal(vKey('accept_' + key, cr, labid), accData);
            saveLocal('accept_' + key + '_' + cr, accData);
          }
          if (Object.keys(panelResults).length > 0) {
            var entData = {panelResults: panelResults, labid: labid};
            if (labid) saveLocal(vKey('entry_' + key, cr, labid), entData);
            saveLocal('entry_' + key + '_' + cr, entData);
          }
        }
      }
      labKeys.forEach(function(key) {
        if (d[key]) {
          cacheLabRow(key, d[key], cr);
        }
        if (d[key + '_all']) {
          d[key + '_all'].forEach(function(row) { cacheLabRow(key, row, cr); });
        }
      });
      showToast('‚úÖ Data loaded from server');
      callback(true);
    })
    .catch(function(err) {
      showToast('‚ùå Server error: ' + err.message, 'error');
      callback(false);
    });
}


// Updated checkPatientExists ‚Äî checks local first, then fetches if needed
function checkPatientExistsAsync(cr, callback) {
  if (loadLocal('pt_' + cr)) { callback(true); return; }
  fetchAllFromSheet(cr, callback);
}

// ‚îÄ‚îÄ‚îÄ WORKFLOW GATE HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showWorkflowBlock(id, msg) {
  const el = document.getElementById(id);
  if (!el) return;
  el.innerHTML = '<span class="wf-icon">üö´</span>' + msg;
  el.classList.add('visible');
}
function clearWorkflowBlock(id) {
  const el = document.getElementById(id);
  if (el) { el.classList.remove('visible'); el.innerHTML = ''; }
}
function checkPatientExists(cr) {
  return !!loadLocal('pt_' + cr);
}
function checkOrderExists(lab, cr) {
  const order = loadLocal('order_' + lab + '_' + cr);
  return !!(order && order.panels && order.panels.trim());
}
function checkAcceptanceExists(lab, cr) {
  const acc = loadLocal('accept_' + lab + '_' + cr);
  return !!(acc && acc.panelStatus && Object.keys(acc.panelStatus).length > 0);
}



function testConnection() {
  var url = document.getElementById('scriptUrl').value.trim() || SCRIPT_URL;
  var el = document.getElementById('conn-test-result');
  el.style.color = '#888';
  el.textContent = 'üîÑ Testing‚Ä¶';
  var testUrl = url + (url.indexOf('?') === -1 ? '?' : '&') + 'type=ping';
  fetch(testUrl)
    .then(function(r) { return r.json(); })
    .then(function(res) {
      if (res && res.status === 'ok') {
        el.style.color = '#1a6a3a';
        el.textContent = '‚úÖ Connected! Server is reachable.';
      } else {
        el.style.color = 'var(--crimson)';
        el.textContent = '‚ùå Server error: ' + JSON.stringify(res);
      }
    })
    .catch(function(err) {
      el.style.color = 'var(--crimson)';
      el.textContent = '‚ùå Failed: ' + err.message + ' ‚Äî Check URL and redeploy Apps Script as Anyone';
    });
}

// ‚îÄ‚îÄ‚îÄ MODULE 07: PROVISIONAL BM REPORT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function loadForProvBM() {
  var cr = document.getElementById('provbm_cr').value.trim();
  if (!cr) { showToast('Please enter a CR number', 'error'); return; }
  function _showProv(pt) {
    var visits = getVisits(cr);
    if (!visits.length) visits = [pt];
    // Always start with LATEST but show selector for ALL visits (even single)
    var labid = pt.labid || (visits[visits.length-1]||{}).labid || '';
    window._lastProvBMCR_labid = labid;
    setSelectedLabId('morph', cr, labid);
    document.getElementById('provbm_pc').innerHTML = patientCardHTML(visits.find(function(v){return v.labid===labid;})||pt);
    var morph = labid ? loadLocal(vKey('morph', cr, labid)) : null;
    document.getElementById('provbm_report').value = (morph && morph.report) ? morph.report : '';
    // Always show visit selector in provisional report (even for single visit)
    var wrap = document.getElementById('provbm_wrap');
    if (wrap) {
      var ex = wrap.querySelector('.visit-selector'); if(ex) ex.remove();
      wrap.insertAdjacentHTML('afterbegin', _visitSelectorHTML('morph', cr, visits, labid));
    }
    document.getElementById('provbm_wrap').classList.remove('hidden');
    window._lastProvBMCR = cr;
    showToast('‚úÖ Loaded: ' + (pt.name || cr), 'success');
  }
  var pt = getLatestVisit(cr) || loadLocal('pt_' + cr);
  if (pt) { _showProv(pt); return; }
  showToast('üîÑ Searching server‚Ä¶');
  fetchAllFromSheet(cr, function(found) {
    var p = loadLocal('pt_' + cr);
    if (!found || !p) { showToast('‚ùå Patient not found. Register first.', 'error'); return; }
    _showProv(p);
  });
}


function downloadProvBM() {
  var cr = document.getElementById('provbm_cr').value.trim();
  if (!cr) { showToast('No CR loaded', 'error'); return; }
  var report = document.getElementById('provbm_report').value.trim();
  if (!report) { showToast('\u26a0\ufe0f Please enter report text before downloading', 'error'); return; }

  // Strictly use selected visit ‚Äî no fallback to latest
  var _pvLabId = getSelectedLabId('morph', cr) || window._lastProvBMCR_labid || '';
  if (!_pvLabId) { showToast('‚ö†Ô∏è No visit selected', 'error'); return; }
  var pt  = (getVisits(cr).find(function(v){return v.labid===_pvLabId;})) || {};
  var now = new Date();
  var dateStr = now.toLocaleDateString('en-IN', {day:'2-digit', month:'short', year:'numeric'});
  var timeStr = now.toLocaleTimeString('en-IN', {hour:'2-digit', minute:'2-digit', hour12:true});
  var NL   = '\n';
  var LINE  = '\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500';
  var DLINE = '\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550';

  var PAYMENT_FULL = {
    '\u2705 Paid':'Paid',
    'Ayushman':'Ayushman Bharat (PMJAY)',
    'Poor Free':'Poor Free (BPL)',
    'JSSK':'JSSK (Govt Scheme)',
    'HIMCARE':'HIMCARE (HP Scheme)',
    '\u274c Not Paid':'Payment Pending'
  };

  var LABS = ['fish','fcm','rtpcr','ngsh12','ngsh9','tcr'];
  var LAB_LABELS = {fish:'FISH',fcm:'FCM (Flow Cytometry)',rtpcr:'RT-PCR / Molecular',ngsh12:'NGS-H12',ngsh9:'NGS-H9',tcr:'TCR Clonality'};
  var testsOrdered = [];
  LABS.forEach(function(lab) {
    // Strict visit isolation ‚Äî no legacy fallback
    var order  = _pvLabId ? loadLocal(vKey('order_'  + lab, cr, _pvLabId)) : null;
    var accept = _pvLabId ? loadLocal(vKey('accept_' + lab, cr, _pvLabId)) : null;
    if (order && order.panels && order.panels.trim()) {
      var payRaw    = order.payment || '';
      var payFull   = PAYMENT_FULL[payRaw] || payRaw || 'Not specified';
      var panels    = order.panels.split(' | ').map(function(s){return s.trim();}).filter(Boolean);
      var orderNote  = order.notes  ? order.notes.trim()  : '';
      var acceptNote = accept && accept.notes ? accept.notes.trim() : '';
      var uniqueId   = accept && accept.uniqueLabId ? accept.uniqueLabId : '';
      var line = LAB_LABELS[lab] + ': ' + panels.join(', ') + ' [' + payFull + ']';
      if (uniqueId)   line += ' | Lab ID: ' + uniqueId;
      if (orderNote)  line += NL + '       Order note: ' + orderNote;
      if (acceptNote) line += NL + '  Acceptance note: ' + acceptNote;
      testsOrdered.push(line);
    }
  });

  var txt = '';
  txt += 'PROVISIONAL BONE MARROW REPORT' + NL;
  txt += 'Dept of Hematology, PGIMER, Chandigarh' + NL;
  txt += DLINE + NL;
  txt += 'Date    : ' + dateStr + '  ' + timeStr + NL;
  txt += LINE + NL;
  txt += 'Patient : ' + (pt.name  || '\u2014') + NL;
  txt += 'CR No.  : ' + (pt.cr    || cr)       + NL;
  txt += 'Lab ID  : ' + (pt.labid || '\u2014') + NL;
  txt += 'Age/Sex : ' + (pt.age   || '?') + ' yr / ' + (pt.sex || '?') + NL;
  txt += LINE + NL + NL;
  txt += 'BONE MARROW REPORT' + NL + NL;
  txt += report + NL + NL;
  if (testsOrdered.length > 0) {
    txt += LINE + NL;
    txt += 'ANCILLARY TESTS ORDERED' + NL;
    testsOrdered.forEach(function(t){ txt += '  \u2022 ' + t + NL; });
    txt += NL;
  }
  txt += LINE + NL;
  txt += '\u26a0\ufe0f  PROVISIONAL REPORT \u2014 NOT VALIDATED' + NL;
  txt += 'This report is provisional and not validated.' + NL;
  txt += 'The report in HIS will be the final one.' + NL;
  txt += LINE + NL;
  txt += '\u00a9 Dept of Hematology, PGIMER, Chandigarh' + NL;

  var safeName = (pt.name ? pt.name.replace(/[^a-zA-Z0-9]/g,'_') : cr);
  var filename  = 'ProvBM_' + cr + '_' + _pvLabId + '_' + safeName + '.txt';
  var blob = new Blob([txt], {type:'text/plain;charset=utf-8'});
  var url  = URL.createObjectURL(blob);
  var a    = document.createElement('a');
  a.href = url; a.download = filename;
  document.body.appendChild(a); a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  showToast('\u2705 Downloaded: ' + filename, 'success');
}

function loadForMorph() {
  var cr = document.getElementById('morph_cr').value.trim();
  if (!cr) { showToast('Please enter a CR number', 'error'); return; }
  // Always clear first ‚Äî never show stale data
  var ta = document.getElementById('morph_report');
  if (ta) ta.value = '';
  document.getElementById('morph_pc').innerHTML = '';
  document.getElementById('morph_wrap').classList.add('hidden');
  clearWorkflowBlock('morph_wfblock');
  // Always fetch from sheet first to get latest data
  showToast('üîÑ Loading‚Ä¶');
  fetchAllFromSheet(cr, function(found) {
    if (!found || !getLatestVisit(cr)) {
      // Try local as fallback
      var ptLocal = getLatestVisit(cr);
      if (!ptLocal) {
        showWorkflowBlock('morph_wfblock',
          'Patient <strong>' + cr + '</strong> is not registered. Please complete <strong>Module 01</strong> first.');
        return;
      }
    }
    _showMorphVisit(cr);
  });
}
function _showMorphVisit(cr) {
  clearWorkflowBlock('morph_wfblock');
  var visits = getVisits(cr);
  if (!visits.length) { var pt = loadLocal('pt_' + cr); if(pt) visits=[pt]; }
  // Always use LATEST visit ‚Äî no selector for morphology module
  var visit = visits[visits.length-1] || loadLocal('pt_' + cr);
  var labid = visit ? visit.labid : '';
  setSelectedLabId('morph', cr, labid);
  renderMorphCard(visit, cr);
}

function renderMorphCard(data, cr) {
  document.getElementById('morph_pc').innerHTML = patientCardHTML(data);
  // Always blank first ‚Äî no stale data ever
  var morphTA = document.getElementById('morph_report');
  if (morphTA) morphTA.value = '';
  // Only populate if this exact visit has saved morphology
  const _mLabId2 = getSelectedLabId('morph', cr) || (data && data.labid) || '';
  const saved = _mLabId2 ? loadLocal(vKey('morph', cr, _mLabId2)) : null;
  // Never fall back to legacy key ‚Äî if vKey has no data, leave blank
  if (saved && saved.report) {
    document.getElementById('morph_report').value = saved.report;
  }
  document.getElementById('morph_wrap').classList.remove('hidden');
  showToast('‚úÖ Loaded: ' + data.name, 'success');
}

function saveMorph() {
  var cr = document.getElementById('morph_cr').value.trim();
  if (!cr) { showToast('No CR number', 'error'); return; }
  var report = document.getElementById('morph_report').value.trim();
  if (!report) {
    showToast('‚ö†Ô∏è Please enter morphology report before saving', 'error');
    document.getElementById('morph_report').focus();
    return;
  }
  var visit = getVisits(cr).find(function(v){return v.labid===getSelectedLabId('morph',cr);}) || getLatestVisit(cr) || {};
  var labid = visit.labid || '';
  var payload = {
    sheet: 'Morphology', action: 'morphology',
    cr, report, labid: labid,
    name: visit.name || '', visitLabId: labid,
    timestamp: new Date().toISOString()
  };
  saveLocal(vKey('morph', cr, labid), payload);
  saveLocal('morph_' + cr, payload); // legacy
  sendToSheet(payload, '‚úÖ Morphology report saved!');
  setTimeout(function() { showReadyBanner('screen-morph', '‚úÖ Saved ‚Äî Ready for next case'); }, 1500);
}

// ‚îÄ‚îÄ‚îÄ MODULE 3: TEST ACCEPTANCE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleStatus(prefix, pid, status, el) {
  const block = document.getElementById(prefix + '_' + pid + '_block');
  ['OK','PP','HP'].forEach(s => {
    const btn = el.parentElement.querySelector('.' + s.toLowerCase() + '-tag');
    if (btn) btn.classList.remove('selected');
  });
  el.classList.add('selected');
  block.classList.remove('ok-status','pp-status','hp-status');
  block.classList.add(status.toLowerCase() + '-status');
}

function loadForAcceptance(lab) {
  var cr = document.getElementById('a' + lab + '_cr').value.trim();
  if (!cr) { showToast('Please enter a CR number', 'error'); return; }
  clearWorkflowBlock('accept_' + lab + '_wfblock');
  var pt = getLatestVisit(cr);
  if (pt) { _showAcceptVisit(lab, cr); return; }
  showToast('üîÑ Searching server‚Ä¶');
  fetchAllFromSheet(cr, function(found) {
    if (!found || !getLatestVisit(cr)) {
      showWorkflowBlock('accept_' + lab + '_wfblock',
        'Patient <strong>' + cr + '</strong> is not registered. Please complete <strong>Module 01</strong> first.');
      return;
    }
    _showAcceptVisit(lab, cr);
  });
}
function _showAcceptVisit(lab, cr) {
  clearWorkflowBlock('accept_' + lab + '_wfblock');
  var visits = getVisits(cr);
  if (!visits.length) { var pt = loadLocal('pt_' + cr); if(pt) visits=[pt]; }
  // Always use LATEST visit ‚Äî no selector for lab modules
  var visit = visits[visits.length-1] || loadLocal('pt_' + cr);
  var labid = visit ? visit.labid : '';
  setSelectedLabId('accept_' + lab, cr, labid);
  if (!loadLocal(vKey('order_' + lab, cr, labid))) {
    showWorkflowBlock('accept_' + lab + '_wfblock',
      'No <strong>' + lab.toUpperCase() + '</strong> tests ordered for Lab ID <strong>' + labid + '</strong>. Complete Module 03 first.');
    return;
  }
  renderAcceptanceCard(lab, visit, cr);
}

function _doLoadAcceptance(lab, cr) {
  clearWorkflowBlock('accept_' + lab + '_wfblock');
  if (!checkOrderExists(lab, cr)) {
    showWorkflowBlock('accept_' + lab + '_wfblock',
      'No <strong>' + lab.toUpperCase() + '</strong> tests ordered for this case. Please complete <strong>Module 03 ‚Äî Order Tests</strong> first.');
    return;
  }
  renderAcceptanceCard(lab, loadLocal('pt_' + cr), cr);
}

function renderAcceptanceCard(lab, data, cr) {
  const prefix = 'a' + lab;
  document.getElementById(prefix + '_pc').innerHTML = patientCardHTML(data);
  // ‚îÄ‚îÄ Clear all acceptance status buttons first ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  document.querySelectorAll('#' + prefix + '_wrap .ok-tag, #' + prefix + '_wrap .pp-tag, #' + prefix + '_wrap .hp-tag').forEach(function(btn) {
    btn.classList.remove('selected');
  });
  document.querySelectorAll('#' + prefix + '_wrap .prb').forEach(function(b) {
    b.classList.remove('ok-status','pp-status','hp-status');
  });
  var accNotesEl = document.getElementById(prefix + '_notes');
  if (accNotesEl) accNotesEl.value = '';
  var uidEl = document.getElementById(prefix + '_unique_id');
  if (uidEl) uidEl.value = '';
  var uidStatus = document.getElementById(prefix + '_uid_status');
  if (uidStatus) { uidStatus.textContent = ''; }
  // ‚îÄ‚îÄ Load order for this visit only (no legacy fallback) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const _aLabId = getSelectedLabId('accept_' + lab, cr) || (data && data.labid) || '';
  const order = _aLabId ? loadLocal(vKey('order_' + lab, cr, _aLabId)) : null;
  const orderedPanels = order && order.panels ? order.panels.split(' | ') : [];
  const summaryEl = document.getElementById(prefix + '_ordered');
  summaryEl.textContent = orderedPanels.length
    ? 'üìã Ordered: ' + orderedPanels.join(' ¬∑ ')
    : '‚ö†Ô∏è No panels ordered yet for this case.';

  // Dim panels not ordered
  const allPanels = LAB_PANELS[lab] || [];
  allPanels.forEach(p => {
    const p_id = panelId(p);
    const block = document.getElementById(prefix + '_' + p_id + '_block');
    if (!block) return;
    block.classList.toggle('inactive', !isPanelOrdered(p, orderedPanels));
  });

  // Restore saved acceptance for this visit only ‚Äî no legacy fallback
  const saved = _aLabId ? loadLocal(vKey('accept_' + lab, cr, _aLabId)) : null;
  if (saved) {
    // Restore unique lab ID
    const uidEl = document.getElementById(prefix + '_unique_id');
    if (uidEl && saved.uniqueLabId) {
      uidEl.value = saved.uniqueLabId;
      document.getElementById(prefix + '_uid_status').textContent = '‚úÖ ID loaded';
      document.getElementById(prefix + '_uid_status').style.color = '#1a6a3a';
    }
  }
  if (saved && saved.panelStatus) {
    Object.entries(saved.panelStatus).forEach(([p, status]) => {
      const p_id = panelId(p);
      const block = document.getElementById(prefix + '_' + p_id + '_block');
      if (!block || !status) return;
      const btn = block.querySelector('.' + status.toLowerCase() + '-tag');
      if (btn) {
        btn.classList.add('selected');
        block.classList.add(status.toLowerCase() + '-status');
      }
    });
    const notesEl = document.getElementById(prefix + '_notes');
    if (notesEl) notesEl.value = saved.notes || '';
  }

  document.getElementById(prefix + '_wrap').classList.remove('hidden');
  showToast('‚úÖ Loaded: ' + data.name, 'success');
}

function saveAcceptance(lab) {
  const cr = document.getElementById('a' + lab + '_cr').value.trim();
  if (!cr) { showToast('No CR number', 'error'); return; }
  const prefix = 'a' + lab;

  // Require Unique Lab ID
  const uniqueLabId = document.getElementById(prefix + '_unique_id')?.value.trim() || '';
  if (!uniqueLabId) {
    showToast('‚ö†Ô∏è Please enter a Unique Lab ID for ' + lab.toUpperCase(), 'error');
    document.getElementById(prefix + '_unique_id')?.focus();
    return;
  }

  // Check for duplicates (allow re-save of same CR)
  const allKeys = Object.keys(localStorage);
  const duplicate = allKeys.some(k => {
    if (!k.startsWith('hemepath_accept_' + lab + '_')) return false;
    const savedCr = k.replace('hemepath_accept_' + lab + '_', '');
    if (savedCr === cr) return false; // same case = re-save, allowed
    try {
      const saved = JSON.parse(localStorage.getItem(k));
      const savedUid = saved && saved.uniqueLabId ? saved.uniqueLabId.trim().toLowerCase() : '';
      return savedUid && savedUid === uniqueLabId.toLowerCase();
    } catch(e) { return false; }
  });
  if (duplicate) {
    showToast('‚ö†Ô∏è Duplicate! This Unique Lab ID already exists in ' + lab.toUpperCase(), 'error');
    document.getElementById(prefix + '_unique_id')?.focus();
    return;
  }

  const panels = LAB_PANELS[lab] || [];
  let anySet = false;
  const panelStatus = {};
  panels.forEach(p => {
    const p_id = panelId(p);
    const block = document.getElementById(prefix + '_' + p_id + '_block');
    if (!block || block.classList.contains('inactive')) return;
    const selected = block.querySelector('.mtag.selected');
    const status = selected ? selected.textContent.trim() : '';
    if (status) { anySet = true; panelStatus[p] = status; }
  });
  if (!anySet) { showToast('‚ö†Ô∏è Please set status for at least one panel', 'error'); return; }
  const notes = document.getElementById(prefix + '_notes')?.value || '';
  const pt2 = loadLocal('pt_' + cr) || {};
  const payload = { sheet: lab.toUpperCase(), action: 'save_acceptance', lab, cr,
    labid: pt2.labid || '', name: pt2.name || '',
    uniqueLabId, panelStatus, notes, timestamp: new Date().toISOString() };
    var _aLabId = getSelectedLabId('accept_' + lab, cr) || (getLatestVisit(cr)||{}).labid || '';
  payload.visitLabId = _aLabId;
  saveLocal(vKey('accept_' + lab, cr, _aLabId), payload);
  saveLocal('accept_' + lab + '_' + cr, payload);
  sendToSheet(payload, '‚úÖ ' + lab.toUpperCase() + ' acceptance saved!');
  setTimeout(function() { showReadyBanner('screen-results', '‚úÖ Saved ‚Äî Ready for next case'); }, 1500);
}

// ‚îÄ‚îÄ‚îÄ MODULE 4: RESULT ENTRY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function loadForEntry(lab) {
  var cr = document.getElementById('e' + lab + '_cr').value.trim();
  if (!cr) { showToast('Please enter a CR number', 'error'); return; }
  clearWorkflowBlock('entry_' + lab + '_wfblock');
  var pt = getLatestVisit(cr);
  if (pt) { _showEntryVisit(lab, cr); return; }
  showToast('üîÑ Searching server‚Ä¶');
  fetchAllFromSheet(cr, function(found) {
    if (!found || !getLatestVisit(cr)) {
      showWorkflowBlock('entry_' + lab + '_wfblock',
        'Patient <strong>' + cr + '</strong> is not registered. Please complete <strong>Module 01</strong> first.');
      return;
    }
    _showEntryVisit(lab, cr);
  });
}
function _showEntryVisit(lab, cr) {
  clearWorkflowBlock('entry_' + lab + '_wfblock');
  var visits = getVisits(cr);
  if (!visits.length) { var pt = loadLocal('pt_' + cr); if(pt) visits=[pt]; }
  // Always use LATEST visit ‚Äî no selector for lab modules
  var visit = visits[visits.length-1] || loadLocal('pt_' + cr);
  var labid = visit ? visit.labid : '';
  setSelectedLabId('entry_' + lab, cr, labid);
  if (!loadLocal(vKey('order_' + lab, cr, labid))) {
    showWorkflowBlock('entry_' + lab + '_wfblock',
      'No <strong>' + lab.toUpperCase() + '</strong> tests ordered for Lab ID <strong>' + labid + '</strong>. Complete Module 03 first.');
    return;
  }
  if (!loadLocal(vKey('accept_' + lab, cr, labid))) {
    showWorkflowBlock('entry_' + lab + '_wfblock',
      '‚ö†Ô∏è Not yet accepted for Lab ID <strong>' + labid + '</strong>. Please complete Module 04 first.');
  }
  renderEntryCard(lab, visit, cr);
}

function _doLoadEntry(lab, cr) {
  clearWorkflowBlock('entry_' + lab + '_wfblock');
  if (!checkOrderExists(lab, cr)) {
    showWorkflowBlock('entry_' + lab + '_wfblock',
      'No <strong>' + lab.toUpperCase() + '</strong> tests ordered for this case. Please complete <strong>Module 03 ‚Äî Order Tests</strong> first.');
    return;
  }
  if (!checkAcceptanceExists(lab, cr)) {
    showWorkflowBlock('entry_' + lab + '_wfblock',
      '‚ö†Ô∏è <strong>' + lab.toUpperCase() + '</strong> tests have not been accepted yet (Module 04). Results can be previewed but please complete acceptance first.');
  }
  renderEntryCard(lab, loadLocal('pt_' + cr), cr);
}

function renderEntryCard(lab, data, cr) {
  const prefix = 'e' + lab;
  document.getElementById(prefix + '_pc').innerHTML = patientCardHTML(data);
  // ‚îÄ‚îÄ Clear all result selections first ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  document.querySelectorAll('#' + prefix + '_wrap .result-opt').forEach(function(o) {
    o.classList.remove('selected','selected-positive','selected-negative','selected-inconclusive');
  });
  document.querySelectorAll('#' + prefix + '_wrap .other-input-wrap').forEach(function(w) {
    w.classList.add('hidden');
  });
  document.querySelectorAll('#' + prefix + '_wrap input[type="hidden"]').forEach(function(h) {
    h.value = '';
  });
  document.querySelectorAll('#' + prefix + '_wrap .mob-notes').forEach(function(n) {
    n.value = '';
  });
  var overallEl = document.getElementById(prefix + '_overall_notes');
  if (overallEl) overallEl.value = '';
  // ‚îÄ‚îÄ Load order and accept for this visit only (no legacy fallback) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const _eLabId2 = getSelectedLabId('entry_' + lab, cr) || (data && data.labid) || '';
  const order  = _eLabId2 ? loadLocal(vKey('order_'  + lab, cr, _eLabId2)) : null;
  const accept = _eLabId2 ? loadLocal(vKey('accept_' + lab, cr, _eLabId2)) : null;
  const orderedPanels = order && order.panels ? order.panels.split(' | ') : [];
  const summaryEl = document.getElementById(prefix + '_ordered');
  summaryEl.textContent = orderedPanels.length
    ? 'üìã Ordered: ' + orderedPanels.join(' ¬∑ ')
    : '‚ö†Ô∏è No panels ordered yet.';

  // Show panels, add status badge, dim inactive
  const allPanels = LAB_PANELS[lab] || [];
  allPanels.forEach(p => {
    const p_id = panelId(p);
    const block = document.getElementById(prefix + '_' + p_id + '_block');
    const badge = document.getElementById(prefix + '_' + p_id + '_badge');
    if (!block) return;
    block.classList.toggle('inactive', !isPanelOrdered(p, orderedPanels));
    // Show acceptance status badge
    const status = accept && accept.panelStatus ? accept.panelStatus[p] : '';
    if (badge && status) {
      badge.textContent = status;
      badge.className = 'status-badge-inline ' + status.toLowerCase();
    }
  });

  // Restore saved results
  const saved  = _eLabId2 ? loadLocal(vKey('entry_' + lab, cr, _eLabId2)) : null;
  if (saved && saved.panelResults) {
    Object.entries(saved.panelResults).forEach(([p, fullVal]) => {
      const pid2 = panelId(p);
      // Parse value and notes
      const parts = fullVal.split(' | Notes: ');
      const val = parts[0].trim();
      const notes = parts[1] || '';
      // Restore hidden input
      const resEl = document.getElementById(prefix + '_' + pid2 + '_result');
      if (resEl) resEl.value = val;
      // Restore selected button
      const opts = document.querySelectorAll('#' + prefix + '_' + pid2 + '_opts .result-opt');
      opts.forEach(o => {
        if (o.dataset.val === val || (val.startsWith('Others') && o.dataset.val === 'Others')) {
          selectResult(prefix, pid2, o);
        }
      });
      // Restore notes
      const notesEl = document.getElementById(prefix + '_' + pid2 + '_notes');
      if (notesEl) notesEl.value = notes;
    });
    const overallEl = document.getElementById(prefix + '_overall_notes');
    if (overallEl) overallEl.value = saved.overallNotes || '';
  }

  document.getElementById(prefix + '_wrap').classList.remove('hidden');
  showToast('‚úÖ Loaded: ' + data.name, 'success');
}

function saveEntry(lab) {
  const cr = document.getElementById('e' + lab + '_cr').value.trim();
  if (!cr) { showToast('No CR number', 'error'); return; }
  const prefix = 'e' + lab;
  const panels = LAB_PANELS[lab] || [];
  const panelResults = {};
  panels.forEach(p => {
    const pid = panelId(p);
    const block = document.getElementById(prefix + '_' + pid + '_block');
    if (!block || block.classList.contains('inactive')) return;
    let val = document.getElementById(prefix + '_' + pid + '_result')?.value.trim() || '';
    // If Others selected, get text
    if (val === 'Others') {
      const otherText = document.getElementById(prefix + '_' + pid + '_other_text')?.value.trim();
      if (otherText) val = 'Others: ' + otherText;
    }
    const notes = document.getElementById(prefix + '_' + pid + '_notes')?.value.trim() || '';
    if (val || notes) panelResults[p] = val + (notes ? ' | Notes: ' + notes : '');
  });
  if (Object.keys(panelResults).length === 0) {
    showToast('‚ö†Ô∏è Please select result for at least one panel', 'error'); return;
  }
  const overallNotes = document.getElementById(prefix + '_overall_notes')?.value || '';
  const pt3 = loadLocal('pt_' + cr) || {};
  const payload = { sheet: lab.toUpperCase(), action: 'save_results', lab, cr,
    labid: pt3.labid || '', name: pt3.name || '',
    panelResults, overallNotes, timestamp: new Date().toISOString() };
    var _eLabId = getSelectedLabId('entry_' + lab, cr) || (getLatestVisit(cr)||{}).labid || '';
  payload.visitLabId = _eLabId;
  saveLocal(vKey('entry_' + lab, cr, _eLabId), payload);
  saveLocal('entry_' + lab + '_' + cr, payload);
  sendToSheet(payload, '‚úÖ ' + lab.toUpperCase() + ' results saved!');
  setTimeout(function() { showReadyBanner('screen-entry', '‚úÖ Saved ‚Äî Ready for next case'); }, 1500);
}

// ‚îÄ‚îÄ‚îÄ MODULE 2: ORDER TESTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const LAB_KEYS = ['fish','fcm','rtpcr','ngsh12','ngsh9'];

function loadForOrder(lab) {
  var cr = document.getElementById(lab + '_cr').value.trim();
  if (!cr) { showToast('Please enter a CR number', 'error'); return; }
  clearWorkflowBlock('order_' + lab + '_wfblock');
  var pt = getLatestVisit(cr);
  if (pt) { _showOrderVisit(lab, cr); return; }
  showToast('üîÑ Searching server‚Ä¶');
  fetchAllFromSheet(cr, function(found) {
    if (!found || !getLatestVisit(cr)) {
      showWorkflowBlock('order_' + lab + '_wfblock',
        'Patient <strong>' + cr + '</strong> is not registered. Please complete <strong>Module 01 ‚Äî Register Patient</strong> first.');
      return;
    }
    _showOrderVisit(lab, cr);
  });
}
function _showOrderVisit(lab, cr) {
  clearWorkflowBlock('order_' + lab + '_wfblock');
  var visits = getVisits(cr);
  if (!visits.length) { var pt = loadLocal('pt_' + cr); if(pt) visits=[pt]; }
  // Always use LATEST visit ‚Äî no selector for lab modules
  var visit = visits[visits.length-1] || loadLocal('pt_' + cr);
  var labid = visit ? visit.labid : '';
  setSelectedLabId('order_' + lab, cr, labid);
  renderOrderCard(lab, visit, cr);
}

function renderOrderCard(lab, data, cr) {
  document.getElementById(lab + '_pc').innerHTML = patientCardHTML(data);
  document.getElementById(lab + '_card_wrap').classList.remove('hidden');
  // ‚îÄ‚îÄ Clear ALL selections first ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  document.querySelectorAll('#' + lab + '-panels .mtag').forEach(function(t) { t.classList.remove('selected'); });
  document.querySelectorAll('#' + lab + '-payment .mtag').forEach(function(t) { t.classList.remove('selected'); });
  var notesEl = document.getElementById(lab + '_notes');
  if (notesEl) notesEl.value = '';
  var otherWrap = document.getElementById(lab + '_other_wrap');
  if (otherWrap) otherWrap.classList.add('hidden');
  var summaryEl = document.getElementById(lab + '_summary');
  if (summaryEl) summaryEl.classList.add('hidden');
  // ‚îÄ‚îÄ Restore saved data for this visit only (no legacy fallback) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const labid = getSelectedLabId('order_' + lab, cr) || (data && data.labid) || '';
  const saved = labid ? loadLocal(vKey('order_' + lab, cr, labid)) : null;
  if (saved && saved.panels) { restoreMTags(lab + '-panels', saved.panels); }
  if (saved && saved.payment) { restoreMTags(lab + '-payment', saved.payment); }
  if (saved && saved.notes) { if (notesEl) notesEl.value = saved.notes; }
  updateLabSummary(lab);
  showToast('‚úÖ Loaded: ' + data.name, 'success');
}

function restoreMTags(containerId, csv) {
  if (!csv) return;
  const vals = csv.split(' | ');
  const container = document.getElementById(containerId);
  if (!container) return;
  container.querySelectorAll('.mtag').forEach(t => {
    if (vals.includes(t.textContent.trim())) t.classList.add('selected');
  });
}

function getMTagValues(containerId) {
  const container = document.getElementById(containerId);
  if (!container) return '';
  return Array.from(container.querySelectorAll('.mtag.selected'))
    .map(t => t.textContent.trim()).join(' | ');
}

function saveOrder(lab) {
  const cr = document.getElementById(lab + '_cr').value.trim();
  if (!cr) { showToast('No CR number', 'error'); return; }

  let panels, payment, notes;

  // Structured labs (payment + panel-tag based)
  const structuredLabs = ['fish','rtpcr','fcm','ngsh12','ngsh9','tcr'];
  if (structuredLabs.includes(lab)) {
    const payEl = document.querySelector('#' + lab + '-payment .mtag.selected');
    payment = payEl ? payEl.textContent.trim() : '';
    const panelEls = Array.from(document.querySelectorAll('#' + lab + '-panels .panel-tag.selected'))
      .map(t => t.dataset.val);
    const otherText = document.getElementById(lab + '_other_text')?.value.trim();
    if (otherText && document.querySelector('#' + lab + '-panels .other-trigger.selected')) {
      panelEls.push('Other: ' + otherText);
    }
    panels = panelEls.join(' | ');
    notes = document.getElementById(lab + '_notes')?.value || '';
    if (!payment) { showToast('‚ö†Ô∏è Please select payment status', 'error'); return; }
    if (!panels)  { showToast('‚ö†Ô∏è Please select at least one panel', 'error'); return; }
  } else {
    panels  = getMTagValues(lab + '-panels');
    payment = getMTagValues(lab + '-payment');
    notes   = document.getElementById(lab + '_notes')?.value || '';
    if (!panels) { showToast('‚ö†Ô∏è Please select at least one panel', 'error'); return; }
  }

  const pt = loadLocal('pt_' + cr) || {};
  const payload = {
    sheet: lab.toUpperCase(),
    action: 'order',
    lab, cr,
    labid: pt.labid || '',
    name:  pt.name  || '',
    panels, payment, notes,
    timestamp: new Date().toISOString()
  };

    var _oLabId = getSelectedLabId('order_' + lab, cr) || (getLatestVisit(cr)||{}).labid || '';
  payload.visitLabId = _oLabId;
  saveLocal(vKey('order_' + lab, cr, _oLabId), payload);
  saveLocal('order_' + lab + '_' + cr, payload);
  sendToSheet(payload, '‚úÖ ' + lab.toUpperCase() + ' order saved!');
  setTimeout(function() { showReadyBanner('screen-order', '‚úÖ Saved ‚Äî Ready for next case'); }, 1500);
}

// ‚îÄ‚îÄ‚îÄ MODULE 3: RESULTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function loadForResult(lab) {
  const cr = document.getElementById('r' + lab + '_cr').value.trim();
  if (!cr) { showToast('Please enter a CR number', 'error'); return; }
  const local = loadLocal('pt_' + cr);
  if (local) {
    renderResultCard(lab, local, cr);
  } else {
    fetchFromSheet(cr, 'result', lab);
  }
}

function renderResultCard(lab, data, cr) {
  const prefix = 'r' + lab;
  document.getElementById(prefix + '_pc').innerHTML = patientCardHTML(data);

  // Get ordered panels
  const _aLabId = getSelectedLabId('accept_' + lab, cr) || (data && data.labid) || '';
  const order = (_aLabId && loadLocal(vKey('order_' + lab, cr, _aLabId))) || loadLocal('order_' + lab + '_' + cr);
  const orderedPanels = order && order.panels ? order.panels.split(' | ') : [];

  const summaryEl = document.getElementById(prefix + '_ordered');
  if (orderedPanels.length) {
    summaryEl.textContent = 'üìã Ordered: ' + orderedPanels.join(' ¬∑ ');
    summaryEl.classList.remove('empty');
  } else {
    summaryEl.textContent = '‚ö†Ô∏è No panels found for this CR ‚Äî order first or results will save without panel filter.';
    summaryEl.classList.remove('empty');
  }

  // Show all panel blocks; dim those not ordered
  const allPanels = LAB_PANELS[lab] || [];
  allPanels.forEach(p => {
    const pid = panelId(p);
    const block = document.getElementById(prefix + '_' + pid + '_block');
    if (!block) return;
    // If orders exist, dim panels not ordered; if no orders show all
    block.classList.toggle('inactive', !isPanelOrdered(p, orderedPanels));
  });

  // Restore saved results
  const saved = loadLocal('result_' + lab + '_' + cr);
  if (saved && saved.panelData) {
    Object.entries(saved.panelData).forEach(([p, val]) => {
      const pid = panelId(p);
      const accEl = document.getElementById(prefix + '_' + pid + '_acc');
      const rejEl = document.getElementById(prefix + '_' + pid + '_rej');
      const resEl = document.getElementById(prefix + '_' + pid + '_result');
      const block = document.getElementById(prefix + '_' + pid + '_block');
      if (val.accepted === 'Accepted' && accEl) {
        accEl.classList.add('selected');
        if (block) block.classList.add('accepted');
        if (resEl) { resEl.style.display='block'; resEl.value = val.result || ''; }
      } else if (val.accepted === 'Not Accepted' && rejEl) {
        rejEl.classList.add('selected');
        if (block) block.classList.add('rejected');
      }
    });
    const notesEl = document.getElementById(prefix + '_overall_notes');
    if (notesEl) notesEl.value = saved.overallNotes || '';
  }

  document.getElementById(prefix + '_wrap').classList.remove('hidden');
  showToast('‚úÖ Loaded: ' + data.name, 'success');
}

function setStatus(prefix, status) {
  ['pending','inprog','done'].forEach(s => {
    const el = document.getElementById(prefix + '_' + s);
    if (el) el.classList.remove('selected');
  });
  const map = { 'Pending': 'pending', 'In Progress': 'inprog', 'Done': 'done' };
  const el = document.getElementById(prefix + '_' + map[status]);
  if (el) el.classList.add('selected');
}

function getStatus(prefix) {
  if (document.getElementById(prefix + '_done')?.classList.contains('selected')) return 'Done';
  if (document.getElementById(prefix + '_inprog')?.classList.contains('selected')) return 'In Progress';
  return 'Pending';
}

const LAB_PANELS = {"fish": ["ALL", "MDS", "MDS-Extended", "Acute Leuk-NOS", "CML/MPN", "JMML", "CLL", "CLL+CCND1", "Lymphoma-not CLL", "HES", "T-PLL", "MM", "Other"], "fcm": ["Acute Leuk", "CLPD", "MM-Diagnosis", "MM-MRD", "B-ALL-MRD", "T-ALL-MRD", "MDS", "B & T Tubes Acute Leuk", "CLPD-MRD", "Mast Cell Tube", "Neuroblastoma", "Other"], "rtpcr": ["Acute Leukemia Panel", "BCR-ABL1", "JAK2", "CML/MPN Panel", "MYD88", "BRAF", "ddPCR-MRD", "qPCR-MRD", "Other"], "ngsh12": ["Myeloid Mutation Panel", "Lymphoid Mutation Panel", "TP53 Only", "Other"], "ngsh9": ["RNA Fusion Panel", "IBMFS Panel", "WES with CNV", "TCR by NGS", "T-ALL Somatic", "Other"], "tcr": ["TCR Beta", "TCR Gamma", "Other"]};

function panelId(p) {
  return p.toLowerCase().replace(/[^a-z0-9]+/g,'_').replace(/^_|_$/g,'');
}

function togglePanelAccept(prefix, pid, type, el) {
  const block = document.getElementById(prefix + '_' + pid + '_block');
  const accBtn = document.getElementById(prefix + '_' + pid + '_acc');
  const rejBtn = document.getElementById(prefix + '_' + pid + '_rej');
  const resultBox = document.getElementById(prefix + '_' + pid + '_result');

  accBtn.classList.remove('selected');
  rejBtn.classList.remove('selected');
  el.classList.add('selected');
  block.classList.remove('accepted','rejected');

  if (type === 'accepted') {
    block.classList.add('accepted');
    if (resultBox) { resultBox.style.display = 'block'; resultBox.focus(); }
  } else {
    block.classList.add('rejected');
    if (resultBox) { resultBox.style.display = 'none'; resultBox.value = ''; }
  }
}

function saveResult(lab) {
  const cr = document.getElementById('r' + lab + '_cr').value.trim();
  if (!cr) { showToast('No CR number', 'error'); return; }
  const prefix = 'r' + lab;
  const panels = LAB_PANELS[lab] || [];

  // Check at least one panel has acceptance set
  let anySet = false;
  const panelData = {};
  panels.forEach(p => {
    const pid = panelId(p);
    const accEl = document.getElementById(prefix + '_' + pid + '_acc');
    const rejEl = document.getElementById(prefix + '_' + pid + '_rej');
    const resEl = document.getElementById(prefix + '_' + pid + '_result');
    if (!accEl || !rejEl) return;
    const accepted = accEl.classList.contains('selected');
    const rejected = rejEl.classList.contains('selected');
    if (accepted || rejected) anySet = true;
    panelData[p] = {
      accepted: accepted ? 'Accepted' : rejected ? 'Not Accepted' : '',
      result: resEl ? resEl.value.trim() : ''
    };
  });

  if (!anySet) { showToast('‚ö†Ô∏è Please mark at least one panel as Accepted or Not Accepted', 'error'); return; }

  const overallNotes = document.getElementById(prefix + '_overall_notes')?.value || '';
  const payload = {
    sheet: lab.toUpperCase(),
    action: 'upsert_result',
    lab, cr, panelData, overallNotes,
    timestamp: new Date().toISOString()
  };

  saveLocal('result_' + lab + '_' + cr, payload);
  sendToSheet(payload, '‚úÖ ' + lab.toUpperCase() + ' saved!');
}


// ‚îÄ‚îÄ‚îÄ PATIENT LOOKUP (unified) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function lookupPatient(module) {
  // legacy ‚Äî not used in new modules but kept for safety
}

// ‚îÄ‚îÄ‚îÄ MODULE 4: INTEGRATED REPORT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function loadReport() {
  const cr = document.getElementById('rpt_cr').value.trim();
  if (!cr) { showToast('Please enter a CR number', 'error'); return; }
  function _show(patient) {
    var visits = getVisits(cr);
    if (!visits.length) visits = [patient];
    // Use latest visit by default
    var labid = visits[visits.length-1].labid || patient.labid || '';
    window._lastReportCR = cr;
    window._lastReportLabId = labid;
    document.getElementById('rpt_patient_card').innerHTML = patientCardHTML(visits.find(function(v){return v.labid===labid;})||patient);
    // Always show visit selector
    var wrap = document.getElementById('rpt_content');
    var ex = wrap.querySelector('.visit-selector'); if(ex) ex.remove();
    wrap.insertAdjacentHTML('afterbegin', _reportVisitSelectorHTML(cr, visits, labid));
    wrap.classList.remove('hidden');
    showToast('‚úÖ Loaded: ' + (patient.name || cr), 'success');
  }
  const patient = getLatestVisit(cr) || loadLocal('pt_' + cr);
  if (patient) { _show(patient); return; }
  showToast('üîÑ Searching server‚Ä¶');
  fetchAllFromSheet(cr, function(found) {
    const pt = getLatestVisit(cr) || loadLocal('pt_' + cr);
    if (!found || !pt) { showToast('‚ùå Patient not found. Register first.', 'error'); return; }
    _show(pt);
  });
}



// ‚îÄ‚îÄ‚îÄ SEND TO SHEET ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ‚îÄ‚îÄ‚îÄ MODULE 4: INTEGRATED REPORT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function loadReport() {
  const cr = document.getElementById('rpt_cr').value.trim();
  if (!cr) { showToast('Please enter a CR number', 'error'); return; }
  function _show(patient) {
    var visits = getVisits(cr);
    if (!visits.length) visits = [patient];
    // Use latest visit by default
    var labid = visits[visits.length-1].labid || patient.labid || '';
    window._lastReportCR = cr;
    window._lastReportLabId = labid;
    document.getElementById('rpt_patient_card').innerHTML = patientCardHTML(visits.find(function(v){return v.labid===labid;})||patient);
    // Always show visit selector
    var wrap = document.getElementById('rpt_content');
    var ex = wrap.querySelector('.visit-selector'); if(ex) ex.remove();
    wrap.insertAdjacentHTML('afterbegin', _reportVisitSelectorHTML(cr, visits, labid));
    wrap.classList.remove('hidden');
    showToast('‚úÖ Loaded: ' + (patient.name || cr), 'success');
  }
  const patient = getLatestVisit(cr) || loadLocal('pt_' + cr);
  if (patient) { _show(patient); return; }
  showToast('üîÑ Searching server‚Ä¶');
  fetchAllFromSheet(cr, function(found) {
    const pt = getLatestVisit(cr) || loadLocal('pt_' + cr);
    if (!found || !pt) { showToast('‚ùå Patient not found. Register first.', 'error'); return; }
    _show(pt);
  });
}


// ‚îÄ‚îÄ‚îÄ TXT REPORT GENERATOR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function generateTxtReport(cr, filterLabId) {
  // filterLabId: if set, only generate report for that visit; otherwise all visits
  var visits = getVisits(cr);
  if (!visits.length) { var ptLeg = loadLocal('pt_' + cr); if(ptLeg) visits=[ptLeg]; }
  if (!visits.length) return null;
  var p = visits[0]; // Use first visit for top-level demographics

  const PAYMENT_FULL = {
    '‚úÖ Paid':'Paid', 'Ayushman':'Ayushman Bharat (PMJAY)',
    'Poor Free':'Poor Free (BPL)', 'JSSK':'JSSK (Govt Scheme)',
    'HIMCARE':'HIMCARE (HP Scheme)', '‚ùå Not Paid':'Payment Pending',
    'PP':'Payment Pending', 'HP':'On Hold ‚Äî Payment', 'OK':'Accepted'
  };

  const LAB_DEF = {"fish": {"label": "FISH", "panels": ["ALL", "MDS", "MDS-Extended", "Acute Leuk-NOS", "CML/MPN", "JMML", "CLL", "CLL+CCND1", "Lymphoma-not CLL", "HES", "T-PLL", "MM", "Other"]}, "fcm": {"label": "FCM", "panels": ["Acute Leuk", "CLPD", "MM-Diagnosis", "MM-MRD", "B-ALL-MRD", "T-ALL-MRD", "MDS", "B & T Tubes Acute Leuk", "CLPD-MRD", "Mast Cell Tube", "Neuroblastoma", "Other"]}, "rtpcr": {"label": "RT-PCR", "panels": ["Acute Leukemia Panel", "BCR-ABL1", "JAK2", "CML/MPN Panel", "MYD88", "BRAF", "ddPCR-MRD", "qPCR-MRD", "Other"]}, "ngsh12": {"label": "NGS-H12", "panels": ["Myeloid Mutation Panel", "Lymphoid Mutation Panel", "TP53 Only", "Other"]}, "ngsh9": {"label": "NGS-H9", "panels": ["RNA Fusion Panel", "IBMFS Panel", "WES with CNV", "TCR by NGS", "T-ALL Somatic", "Other"]}, "tcr": {"label": "TCR", "panels": ["TCR Beta", "TCR Gamma", "Other"]}};

  function isPanelOrdered(panel, orderedPanels) {
    return orderedPanels.some(function(op) {
      var base = op.replace(/^Other:\s*/i,'').toLowerCase().trim();
      return base === panel.toLowerCase().trim() || op.toLowerCase().includes(panel.toLowerCase());
    });
  }

  const now = new Date();
  const dateStr = now.toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric'});
  const timeStr = now.toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit'});
  const LINE  = '‚îÄ'.repeat(44);
  const DLINE = '‚ïê'.repeat(44);

  var txt = '';
  txt += 'PRISM ‚Äî PGIMER HemePath Registry\n';
  txt += 'Generated: ' + dateStr + '  ' + timeStr + '\n';
  txt += DLINE + '\n\n';

  // Patient demographics (from first visit, CR level)
  txt += 'Patient : ' + (p.name || '‚Äî') + '\n';
  txt += 'CR No.  : ' + (p.cr || cr) + '\n';
  txt += 'Age/Sex : ' + (p.age || '?') + ' yr / ' + (p.sex || '?') + '\n';
  txt += 'Faculty : ' + (p.faculty || '‚Äî') + '\n';
  txt += DLINE + '\n\n';

  // ‚îÄ‚îÄ Loop each visit ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Filter to specific visit if requested
  if (filterLabId) {
    visits = visits.filter(function(v) { return v.labid === filterLabId; });
  }

  visits.forEach(function(visit, vi) {
    var labid = visit.labid || '‚Äî';
    txt += '‚ïî' + '‚ïê'.repeat(42) + '‚ïó\n';
    txt += '  VISIT ' + (vi+1) + ' ‚Äî Lab ID: ' + labid + '\n';
    txt += '  Date: ' + (visit.date || '‚Äî') + '  |  Sample: ' + (visit.sample || '‚Äî') + '\n';
    txt += '‚ïö' + '‚ïê'.repeat(42) + '‚ïù\n\n';

    // BM Morphology for this visit
    // Strict visit isolation ‚Äî no legacy fallback for morph
    var morph = labid ? loadLocal(vKey('morph', cr, labid)) : null;
    txt += 'BONE MARROW MORPHOLOGY\n';
    if (morph && morph.report) {
      txt += morph.report + '\n';
    } else {
      txt += '  Awaiting Result\n';
    }
    txt += '\n' + LINE + '\n\n';

    txt += 'ANCILLARY INVESTIGATIONS\n\n';

    // Loop labs for this visit
    Object.entries(LAB_DEF).forEach(function([labKey, lab]) {
      // Strict visit isolation ‚Äî no legacy fallback
      var order  = labid ? loadLocal(vKey('order_'  + labKey, cr, labid)) : null;
      var accept = labid ? loadLocal(vKey('accept_' + labKey, cr, labid)) : null;
      var entry  = labid ? loadLocal(vKey('entry_'  + labKey, cr, labid)) : null;

      var orderedPanels = order && order.panels
        ? order.panels.split(' | ').map(function(s){return s.trim();})
        : [];

      var uniqueId  = accept && accept.uniqueLabId ? accept.uniqueLabId : null;
      var uid_str   = uniqueId ? '  [Unique ID: ' + uniqueId + ']' : '';
      var payRaw    = order ? (order.payment || '') : '';
      var payFull   = PAYMENT_FULL[payRaw] || payRaw;
      var pay_str   = payFull ? '  [' + payFull + ']' : '';
      var orderNotes  = order  && order.notes  ? order.notes.trim()  : '';
      var acceptNotes = accept && accept.notes ? accept.notes.trim() : '';

      if (orderedPanels.length === 0) {
        txt += lab.label + '\n  Not Ordered\n\n';
        return;
      }

      txt += lab.label + uid_str + pay_str + '\n';
      if (orderNotes)  txt += '  Order note     : ' + orderNotes + '\n';
      if (acceptNotes) txt += '  Acceptance note: ' + acceptNotes + '\n';

      lab.panels.forEach(function(panel) {
        if (!isPanelOrdered(panel, orderedPanels)) return;
        var accStatus   = accept && accept.panelStatus && accept.panelStatus[panel] ? accept.panelStatus[panel] : null;
        var panelResult = entry  && entry.panelResults && entry.panelResults[panel]  ? entry.panelResults[panel]  : null;
        var resultStr;
        if (panelResult) resultStr = panelResult;
        else if (accStatus === 'HP') resultStr = 'On Hold (Payment)';
        else if (accStatus === 'PP') resultStr = 'Awaiting Result (Payment Pending)';
        else resultStr = 'Awaiting Result';
        var padded = (panel + ' ').padEnd(26, '.');
        txt += '  ' + padded + ' ' + resultStr + '\n';
      });
      txt += '\n';
    });

    txt += LINE + '\n\n';
  });

  txt += 'Generated by PRISM v1.0 ‚Äî ¬© Dept of Hematology, PGIMER, Chandigarh\n';
  return txt;
}

function downloadTxt() {
  const cr = window._lastReportCR;
  if (!cr) { showToast('No report loaded', 'error'); return; }
  const selectedLabId = window._lastReportLabId || '';
  const txt = generateTxtReport(cr, selectedLabId);
  if (!txt) { showToast('No data found for this CR', 'error'); return; }

  const p = loadLocal('pt_' + cr);
  const safeName = (p && p.name ? p.name.replace(/[^a-zA-Z0-9]/g,'_') : cr);
  const filename = 'PRISM_' + cr + '_' + safeName + '.txt';

  const blob = new Blob([txt], {type: 'text/plain;charset=utf-8'});
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href     = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  showToast('‚úÖ Downloaded: ' + filename, 'success');
}

// ‚îÄ‚îÄ‚îÄ SEND TO SHEET (fetch no-cors + GET fallback) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function sendToSheet(payload, successMsg) {
  if (!SCRIPT_URL) {
    showToast('‚ö†Ô∏è Script URL not set! Tap ‚öô Config to enter your Apps Script URL.', 'error');
    promptConfig();
    return;
  }
  showToast('üîÑ Syncing to Google Sheets‚Ä¶');
  var url = SCRIPT_URL + (SCRIPT_URL.indexOf('?') === -1 ? '?' : '&') +
    'write=1&data=' + encodeURIComponent(JSON.stringify(payload));
  // Use no-cors for writes ‚Äî Apps Script doesn't return CORS headers on write
  // no-cors = fire and forget, we assume success if no network error
  fetch(url, {mode: 'no-cors'})
    .then(function() {
      showToast(successMsg || '‚úÖ Saved to Google Sheets', 'success');
    })
    .catch(function(err) {
      // Fallback: try JSONP
      var cbName = 'writeCB_' + Date.now();
      var script = document.createElement('script');
      window[cbName] = function(res) {
        delete window[cbName];
        if (document.body.contains(script)) document.body.removeChild(script);
        showToast(successMsg || '‚úÖ Saved to Google Sheets', 'success');
      };
      script.onerror = function() {
        showToast('‚ö†Ô∏è Saved locally. Sheet sync may have failed.', 'error');
      };
      script.src = url + '&callback=' + cbName;
      document.body.appendChild(script);
    });
}
</script>
</body>
</html>
